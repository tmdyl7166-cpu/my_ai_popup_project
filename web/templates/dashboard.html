<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI弹窗项目监控中心</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .status-healthy { color: #28a745; }
        .status-warning { color: #ffc107; }
        .status-error { color: #dc3545; }
        .status-running { color: #007bff; }
        .card-hover:hover { transform: translateY(-2px); transition: all 0.3s; }
        .log-container { max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 0.9em; }
        .progress-bar-custom { transition: width 0.3s ease; }
        .log-error { color: #dc3545; }
        .log-warning { color: #ffc107; }
        .log-success { color: #28a745; }
        .log-timestamp { color: #6c757d; }
        .log-line { padding: 2px 0; border-bottom: 1px solid #333; }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-cogs me-2"></i>AI弹窗项目监控中心
            </a>
            <div class="d-flex">
                <span class="navbar-text me-3" id="connection-status">
                    <i class="fas fa-circle text-success"></i> 已连接
                </span>
                <span class="navbar-text" id="last-update"></span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- 侧边栏 -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-server me-2"></i>系统状态</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">项目状态</label>
                            <div id="project-status" class="alert alert-success">
                                <i class="fas fa-check-circle me-2"></i>运行正常
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">系统资源</label>
                            <div class="progress mb-2" style="height: 20px;">
                                <div class="progress-bar bg-info progress-bar-custom" id="cpu-bar" style="width: 0%">CPU</div>
                            </div>
                            <div class="progress mb-2" style="height: 20px;">
                                <div class="progress-bar bg-success progress-bar-custom" id="memory-bar" style="width: 0%">内存</div>
                            </div>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar bg-warning progress-bar-custom" id="disk-bar" style="width: 0%">磁盘</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 快速操作 -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h5><i class="fas fa-bolt me-2"></i>快速操作</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary w-100 mb-2" onclick="runAllScripts()">
                            <i class="fas fa-play me-2"></i>运行所有脚本
                        </button>
                        <button class="btn btn-warning w-100 mb-2" onclick="refreshStatus()">
                            <i class="fas fa-sync me-2"></i>刷新状态
                        </button>
                        <button class="btn btn-info w-100" onclick="showSystemInfo()">
                            <i class="fas fa-info me-2"></i>系统信息
                        </button>
                    </div>
                </div>

                <!-- 健康监控 -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h5><i class="fas fa-heartbeat me-2"></i>健康监控</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <label class="form-label small">后端服务 (端口8000)</label>
                            <div id="backend-status" class="badge bg-secondary">检测中...</div>
                        </div>
                        <div class="mb-2">
                            <label class="form-label small">Web监控 (端口8080)</label>
                            <div id="web-status" class="badge bg-secondary">检测中...</div>
                        </div>
                        <div>
                            <label class="form-label small">健康检查</label>
                            <div id="health-status" class="badge bg-secondary">检测中...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 主内容区 -->
            <div class="col-md-9">
                <!-- 标签页 -->
                <ul class="nav nav-tabs" id="mainTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="scripts-tab" data-bs-toggle="tab" data-bs-target="#scripts" type="button">
                            <i class="fas fa-terminal me-2"></i>脚本监控
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="deployment-tab" data-bs-toggle="tab" data-bs-target="#deployment" type="button">
                            <i class="fas fa-rocket me-2"></i>部署进度
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="config-tab" data-bs-toggle="tab" data-bs-target="#config" type="button">
                            <i class="fas fa-cogs me-2"></i>配置管理
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button">
                            <i class="fas fa-file-alt me-2"></i>日志查看
                        </button>
                    </li>
                </ul>

                <!-- 标签页内容 -->
                <div class="tab-content mt-3" id="mainTabsContent">
                    <!-- 脚本监控 -->
                    <div class="tab-pane fade show active" id="scripts" role="tabpanel">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5><i class="fas fa-terminal me-2"></i>自动化脚本监控</h5>
                                <button class="btn btn-sm btn-outline-primary" onclick="loadScripts()">
                                    <i class="fas fa-sync me-1"></i>刷新
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="scripts-container">
                                    <!-- 脚本列表将在这里动态加载 -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 部署进度 -->
                    <div class="tab-pane fade" id="deployment" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-rocket me-2"></i>部署进度</h5>
                            </div>
                            <div class="card-body">
                                <div id="deployment-content">
                                    <!-- 部署进度内容将在这里加载 -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 配置管理 -->
                    <div class="tab-pane fade" id="config" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-cogs me-2"></i>配置管理</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="list-group" id="config-list">
                                            <a href="#" class="list-group-item list-group-item-action" onclick="loadConfig('project')">
                                                <i class="fas fa-project-diagram me-2"></i>项目配置
                                            </a>
                                            <a href="#" class="list-group-item list-group-item-action" onclick="loadConfig('frontend')">
                                                <i class="fas fa-desktop me-2"></i>前端配置
                                            </a>
                                            <a href="#" class="list-group-item list-group-item-action" onclick="loadConfig('backend')">
                                                <i class="fas fa-server me-2"></i>后端配置
                                            </a>
                                            <a href="#" class="list-group-item list-group-item-action" onclick="loadConfig('scripts')">
                                                <i class="fas fa-terminal me-2"></i>脚本配置
                                            </a>
                                        </div>
                                    </div>
                                    <div class="col-md-8">
                                        <div id="config-editor">
                                            <div class="alert alert-info">
                                                <i class="fas fa-info-circle me-2"></i>选择左侧配置项进行查看和编辑
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 日志查看 -->
                    <div class="tab-pane fade" id="logs" role="tabpanel">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5><i class="fas fa-file-alt me-2"></i>日志查看</h5>
                                <div>
                                    <select class="form-select form-select-sm d-inline-block w-auto me-2" id="log-script-select">
                                        <option value="">选择脚本</option>
                                    </select>
                                    <button class="btn btn-sm btn-outline-primary" onclick="loadLogs()">
                                        <i class="fas fa-sync me-1"></i>刷新
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="logs-content" class="log-container border p-3 bg-dark text-light">
                                    <!-- 日志内容将在这里显示 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 模态框：脚本详情 -->
    <div class="modal fade" id="scriptModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="scriptModalTitle">脚本详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="scriptModalBody">
                    <!-- 脚本详情内容 -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" id="runScriptBtn">运行脚本</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let socket;
        let currentScripts = [];

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initWebSocket();
            loadScripts();
            loadDeploymentProgress();
            updateSystemResources();
            
            // 启动健康监控
            checkServicesHealth();
            setInterval(checkServicesHealth, 10000); // 每10秒检测一次

            // 定期更新系统资源
            setInterval(updateSystemResources, 5000);
        });

        // 检测服务健康状态
        async function checkServicesHealth() {
            // 检测后端服务
            await checkPort(8000, 'backend-status');
            // 检测Web服务
            await checkPort(8080, 'web-status');
            // 检测健康检查
            await checkHealth();
        }

        // 检测端口
        async function checkPort(port, elementId) {
            try {
                const response = await fetch(`http://localhost:${port}/api/health`, {
                    method: 'GET',
                    timeout: 2000
                });
                if (response.ok) {
                    document.getElementById(elementId).className = 'badge bg-success';
                    document.getElementById(elementId).innerHTML = '<i class="fas fa-check"></i> 运行中';
                } else {
                    document.getElementById(elementId).className = 'badge bg-warning';
                    document.getElementById(elementId).innerHTML = '<i class="fas fa-exclamation"></i> 异常';
                }
            } catch (error) {
                document.getElementById(elementId).className = 'badge bg-danger';
                document.getElementById(elementId).innerHTML = '<i class="fas fa-times"></i> 停止';
            }
        }

        // 检测健康检查
        async function checkHealth() {
            try {
                const response = await fetch('/api/health', {
                    method: 'GET',
                    timeout: 2000
                });
                if (response.ok) {
                    document.getElementById('health-status').className = 'badge bg-success';
                    document.getElementById('health-status').innerHTML = '<i class="fas fa-heart"></i> 健康';
                } else {
                    document.getElementById('health-status').className = 'badge bg-warning';
                    document.getElementById('health-status').innerHTML = '<i class="fas fa-exclamation"></i> 警告';
                }
            } catch (error) {
                document.getElementById('health-status').className = 'badge bg-danger';
                document.getElementById('health-status').innerHTML = '<i class="fas fa-times"></i> 异常';
            }
        }

        // 初始化WebSocket连接
        function initWebSocket() {
            socket = io();

            socket.on('connect', function() {
                updateConnectionStatus(true);
                console.log('WebSocket连接成功');
            });

            socket.on('disconnect', function() {
                updateConnectionStatus(false);
                console.log('WebSocket连接断开');
            });

            socket.on('status_update', function(data) {
                updateScriptsStatus(data);
            });

            socket.on('script_result', function(data) {
                showScriptResult(data);
            });

            socket.on('script_completed', function(data) {
                showNotification(`脚本 ${data.script} 执行完成`, 'success');
                loadScripts(); // 刷新脚本列表
            });

            socket.on('script_error', function(data) {
                showNotification(`脚本 ${data.script} 执行失败: ${data.error}`, 'error');
            });
        }

        // 更新连接状态
        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connection-status');
            if (connected) {
                statusEl.innerHTML = '<i class="fas fa-circle text-success"></i> 已连接';
            } else {
                statusEl.innerHTML = '<i class="fas fa-circle text-danger"></i> 未连接';
            }
        }

        // 加载脚本列表
        async function loadScripts() {
            try {
                const response = await fetch('/api/scripts/list');
                const scripts = await response.json();
                currentScripts = scripts;
                renderScripts(scripts);
                updateLogScriptSelect(scripts);
            } catch (error) {
                console.error('加载脚本列表失败:', error);
                showNotification('加载脚本列表失败', 'error');
            }
        }

        // 渲染脚本列表
        function renderScripts(scripts) {
            const container = document.getElementById('scripts-container');
            container.innerHTML = '';

            if (scripts.length === 0) {
                container.innerHTML = '<div class="alert alert-info">暂无脚本配置</div>';
                return;
            }

            scripts.forEach(script => {
                const statusClass = getStatusClass(script.status);
                const statusIcon = getStatusIcon(script.status);

                const scriptCard = document.createElement('div');
                scriptCard.className = 'card mb-3 card-hover';
                scriptCard.innerHTML = `
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="card-title">
                                    <i class="fas fa-terminal me-2"></i>${script.display_name}
                                </h6>
                                <p class="card-text text-muted small">${script.description}</p>
                                <div class="d-flex align-items-center">
                                    <span class="badge ${statusClass} me-2">
                                        ${statusIcon} ${script.status}
                                    </span>
                                    <small class="text-muted">
                                        频率: ${script.frequency}
                                        ${script.last_run ? ` | 上次运行: ${new Date(script.last_run).toLocaleString()}` : ''}
                                    </small>
                                </div>
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary" onclick="runScript('${script.name}')">
                                    <i class="fas fa-play"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-info" onclick="showScriptDetails('${script.name}')">
                                    <i class="fas fa-info"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="viewScriptLogs('${script.name}')">
                                    <i class="fas fa-file-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                container.appendChild(scriptCard);
            });
        }

        // 获取状态样式类
        function getStatusClass(status) {
            switch (status) {
                case 'running': return 'bg-primary';
                case 'completed': return 'bg-success';
                case 'failed': return 'bg-danger';
                case 'idle': return 'bg-secondary';
                default: return 'bg-warning';
            }
        }

        // 获取状态图标
        function getStatusIcon(status) {
            switch (status) {
                case 'running': return '<i class="fas fa-spinner fa-spin"></i>';
                case 'completed': return '<i class="fas fa-check"></i>';
                case 'failed': return '<i class="fas fa-times"></i>';
                case 'idle': return '<i class="fas fa-pause"></i>';
                default: return '<i class="fas fa-question"></i>';
            }
        }

        // 运行脚本
        async function runScript(scriptName) {
            try {
                const response = await fetch(`/api/scripts/run/${scriptName}`, {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.status === 'started') {
                    showNotification(`脚本 ${scriptName} 开始运行`, 'info');
                    // 更新按钮状态
                    updateScriptStatus(scriptName, 'running');
                } else {
                    showNotification(`启动脚本失败: ${result.message}`, 'error');
                }
            } catch (error) {
                console.error('运行脚本失败:', error);
                showNotification('运行脚本失败', 'error');
            }
        }

        // 显示脚本详情
        function showScriptDetails(scriptName) {
            const script = currentScripts.find(s => s.name === scriptName);
            if (!script) return;

            const modal = new bootstrap.Modal(document.getElementById('scriptModal'));
            document.getElementById('scriptModalTitle').textContent = script.display_name;

            const modalBody = document.getElementById('scriptModalBody');
            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>基本信息</h6>
                        <p><strong>名称:</strong> ${script.display_name}</p>
                        <p><strong>状态:</strong> <span class="badge ${getStatusClass(script.status)}">${script.status}</span></p>
                        <p><strong>频率:</strong> ${script.frequency}</p>
                        ${script.last_run ? `<p><strong>上次运行:</strong> ${new Date(script.last_run).toLocaleString()}</p>` : ''}
                    </div>
                    <div class="col-md-6">
                        <h6>描述</h6>
                        <p>${script.description}</p>
                    </div>
                </div>
            `;

            document.getElementById('runScriptBtn').onclick = () => {
                runScript(scriptName);
                modal.hide();
            };

            modal.show();
        }

        // 查看脚本日志
        function viewScriptLogs(scriptName) {
            document.getElementById('log-script-select').value = scriptName;
            document.getElementById('logs-tab').click();
            loadLogs();
        }

        // 更新脚本状态
        function updateScriptStatus(scriptName, status) {
            const scriptCards = document.querySelectorAll('.card');
            scriptCards.forEach(card => {
                const title = card.querySelector('.card-title');
                if (title && title.textContent.includes(scriptName)) {
                    const badge = card.querySelector('.badge');
                    if (badge) {
                        badge.className = `badge ${getStatusClass(status)} me-2`;
                        badge.innerHTML = `${getStatusIcon(status)} ${status}`;
                    }
                }
            });
        }

        // 更新脚本状态（从WebSocket）
        function updateScriptsStatus(data) {
            if (data.scripts) {
                Object.entries(data.scripts).forEach(([scriptName, status]) => {
                    updateScriptStatus(scriptName, status);
                });
            }
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
        }

        // 显示脚本执行结果
        function showScriptResult(data) {
            const message = data.result.status === 'success' ?
                `脚本 ${data.script} 执行成功` :
                `脚本 ${data.script} 执行失败: ${data.result.message || '未知错误'}`;

            showNotification(message, data.result.status === 'success' ? 'success' : 'error');
        }

        // 加载部署进度
        async function loadDeploymentProgress() {
            try {
                const response = await fetch('/api/deployment/progress');
                const data = await response.json();

                const container = document.getElementById('deployment-content');
                if (data.status === 'success') {
                    container.innerHTML = `<pre class="bg-light p-3 rounded">${data.content}</pre>`;
                } else {
                    container.innerHTML = `<div class="alert alert-warning">${data.message}</div>`;
                }
            } catch (error) {
                console.error('加载部署进度失败:', error);
                document.getElementById('deployment-content').innerHTML =
                    '<div class="alert alert-danger">加载部署进度失败</div>';
            }
        }

        // 加载配置
        async function loadConfig(component) {
            try {
                const response = await fetch(`/api/config/${component}`);
                const config = await response.json();

                const editor = document.getElementById('config-editor');
                if (config.error) {
                    editor.innerHTML = `<div class="alert alert-danger">${config.error}</div>`;
                } else {
                    const formatted = JSON.stringify(config, null, 2);
                    editor.innerHTML = `
                        <h6>${component} 配置</h6>
                        <pre class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto;"><code>${formatted}</code></pre>
                        <button class="btn btn-primary mt-2" onclick="editConfig('${component}')">编辑配置</button>
                    `;
                }
            } catch (error) {
                console.error('加载配置失败:', error);
                document.getElementById('config-editor').innerHTML =
                    '<div class="alert alert-danger">加载配置失败</div>';
            }
        }

        // 加载日志
        async function loadLogs() {
            const scriptName = document.getElementById('log-script-select').value;
            if (!scriptName) {
                document.getElementById('logs-content').innerHTML = '<div class="alert alert-info">请选择要查看的脚本日志</div>';
                return;
            }

            try {
                const response = await fetch(`/api/logs/${scriptName}`);
                const data = await response.json();

                const container = document.getElementById('logs-content');
                if (data.status === 'success') {
                    const logsHtml = data.logs.map(line =>
                        `<div>${line.replace(/</g, '<').replace(/>/g, '>')}</div>`
                    ).join('');
                    container.innerHTML = logsHtml;
                } else {
                    container.innerHTML = `<div class="alert alert-warning">${data.message}</div>`;
                }
            } catch (error) {
                console.error('加载日志失败:', error);
                document.getElementById('logs-content').innerHTML =
                    '<div class="alert alert-danger">加载日志失败</div>';
            }
        }

        // 更新日志脚本选择器
        function updateLogScriptSelect(scripts) {
            const select = document.getElementById('log-script-select');
            select.innerHTML = '<option value="">选择脚本</option>';

            scripts.forEach(script => {
                const option = document.createElement('option');
                option.value = script.name;
                option.textContent = script.display_name;
                select.appendChild(option);
            });
        }

        // 更新系统资源
        async function updateSystemResources() {
            try {
                const response = await fetch('/api/system/resources');
                const resources = await response.json();

                if (!resources.error) {
                    document.getElementById('cpu-bar').style.width = `${resources.cpu_percent}%`;
                    document.getElementById('cpu-bar').textContent = `CPU ${resources.cpu_percent.toFixed(1)}%`;

                    document.getElementById('memory-bar').style.width = `${resources.memory.percent}%`;
                    document.getElementById('memory-bar').textContent = `内存 ${resources.memory.percent.toFixed(1)}%`;

                    document.getElementById('disk-bar').style.width = `${resources.disk.percent}%`;
                    document.getElementById('disk-bar').textContent = `磁盘 ${resources.disk.percent.toFixed(1)}%`;
                }
            } catch (error) {
                console.error('更新系统资源失败:', error);
            }
        }

        // 显示通知
        function showNotification(message, type = 'info') {
            const alertClass = {
                'success': 'alert-success',
                'error': 'alert-danger',
                'warning': 'alert-warning',
                'info': 'alert-info'
            }[type] || 'alert-info';

            const notification = document.createElement('div');
            notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(notification);

            // 3秒后自动移除
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }

        // 工具函数
        function runAllScripts() {
            showNotification('功能开发中...', 'info');
        }

        function refreshStatus() {
            loadScripts();
            updateSystemResources();
            showNotification('状态已刷新', 'success');
        }

        function showSystemInfo() {
            showNotification('系统信息功能开发中...', 'info');
        }

        function editConfig(component) {
            showNotification('配置编辑功能开发中...', 'info');
        }
    </script>
</body>
</html>
