{
    "meta": {
        "layer": "L3",
        "name": "约束层",
        "description": "定义技术实现的约束、规范和依赖关系",
        "dependsOn": ["L1", "L2"],
        "createdAt": "2026-01-16T00:00:00Z",
        "lastModified": "2026-01-16T00:00:00Z",
        "version": "1.0.0"
    },
    "python": {
        "version": {
            "minimum": "3.10.0",
            "maximum": "3.11.9",
            "recommended": "3.10.12"
        },
        "encoding": "utf-8",
        "typeHints": "required",
        "styleGuide": "PEP 8"
    },
    "dependencies": {
        "core": {
            "PyQt5": {
                "version": ">=5.15.10",
                "purpose": "GUI框架",
                "alternatives": ["PySide6"],
                "locked": false
            },
            "PyQt5-sip": {
                "version": ">=12.13.1",
                "purpose": "PyQt5 SIP绑定",
                "locked": false
            },
            "fastapi": {
                "version": ">=0.120.0",
                "purpose": "Web框架",
                "locked": false
            },
            "uvicorn": {
                "version": ">=0.30.0",
                "purpose": "ASGI服务器",
                "locked": false
            },
            "python-multipart": {
                "version": ">=0.0.6",
                "purpose": "多部分表单数据处理",
                "locked": false
            },
            "pydantic": {
                "version": ">=2.10.0",
                "purpose": "数据验证",
                "locked": false
            },
            "pydantic-settings": {
                "version": ">=2.5.0",
                "purpose": "Pydantic设置管理",
                "locked": false
            }
        },
        "web": {
            "jinja2": {
                "version": ">=3.1.4",
                "purpose": "模板引擎",
                "locked": false
            },
            "aiofiles": {
                "version": ">=24.0.0",
                "purpose": "异步文件操作",
                "locked": false
            },
            "websockets": {
                "version": ">=14.0",
                "purpose": "WebSocket支持",
                "locked": false
            },
            "python-socketio": {
                "version": ">=5.12.0",
                "purpose": "Socket.IO客户端",
                "locked": false
            },
            "schedule": {
                "version": ">=1.2.2",
                "purpose": "任务调度",
                "locked": false
            }
        },
        "ai": {
            "torch": {
                "version": ">=2.5.0",
                "purpose": "深度学习框架",
                "cpuOnly": true,
                "gpuOptional": true,
                "locked": false
            },
            "torchvision": {
                "version": ">=0.20.0",
                "purpose": "PyTorch视觉库",
                "locked": false
            },
            "torchaudio": {
                "version": ">=2.5.0",
                "purpose": "PyTorch音频库",
                "locked": false
            },
            "ollama": {
                "version": ">=0.3.0",
                "purpose": "本地LLM推理",
                "locked": false
            },
            "insightface": {
                "version": "0.7.3",
                "purpose": "人脸分析",
                "locked": true
            },
            "face-recognition": {
                "version": ">=1.3.0",
                "purpose": "人脸识别",
                "locked": false
            },
            "dlib": {
                "version": ">=19.24.0",
                "purpose": "人脸特征点检测",
                "locked": false
            },
            "deepface": {
                "version": ">=0.0.90",
                "purpose": "深度人脸分析",
                "locked": false
            },
            "mediapipe": {
                "version": ">=0.10.15",
                "purpose": "面部网格检测",
                "locked": false
            },
            "onnxruntime": {
                "version": ">=1.17.0",
                "purpose": "推理加速",
                "locked": false
            },
            "transformers": {
                "version": ">=4.46.0",
                "purpose": "文本生成模型",
                "locked": false
            },
            "diffusers": {
                "version": ">=0.31.0",
                "purpose": "扩散模型",
                "locked": false
            }
        },
        "media": {
            "opencv-python": {
                "version": ">=4.10.0",
                "purpose": "图像/视频处理",
                "locked": false
            },
            "opencv-python-headless": {
                "version": ">=4.10.0",
                "purpose": "OpenCV无头版本",
                "locked": false
            },
            "Pillow": {
                "version": ">=11.0.0",
                "purpose": "图像处理",
                "locked": false
            },
            "numpy": {
                "version": ">=1.24.0,<2.0.0",
                "purpose": "数值计算",
                "locked": true
            },
            "scipy": {
                "version": ">=1.14.0",
                "purpose": "科学计算",
                "locked": false
            },
            "imageio": {
                "version": ">=2.36.0",
                "purpose": "图像I/O",
                "locked": false
            },
            "moviepy": {
                "version": ">=2.0.0",
                "purpose": "视频编辑",
                "locked": false
            },
            "imageio-ffmpeg": {
                "version": ">=0.5.0",
                "purpose": "FFmpeg绑定",
                "locked": false
            }
        },
        "data": {
            "pandas": {
                "version": ">=2.2.0",
                "purpose": "数据处理",
                "locked": false
            },
            "matplotlib": {
                "version": ">=3.9.0",
                "purpose": "数据可视化",
                "locked": false
            },
            "scikit-learn": {
                "version": ">=1.5.0",
                "purpose": "机器学习",
                "locked": false
            },
            "scikit-image": {
                "version": ">=0.24.0",
                "purpose": "图像处理",
                "locked": false
            }
        },
        "async": {
            "concurrent-log-handler": {
                "version": ">=0.9.25",
                "purpose": "并发日志处理",
                "locked": false
            },
            "threadpoolctl": {
                "version": ">=3.5.0",
                "purpose": "线程池控制",
                "locked": false
            }
        },
        "network": {
            "httpx": {
                "version": ">=0.28.0",
                "purpose": "异步HTTP客户端",
                "locked": false
            },
            "aiohttp": {
                "version": ">=3.10.0",
                "purpose": "异步HTTP库",
                "locked": false
            }
        },
        "serialization": {
            "orjson": {
                "version": ">=3.10.0",
                "purpose": "快速JSON序列化",
                "locked": false
            },
            "python-dotenv": {
                "version": ">=1.0.1",
                "purpose": "环境变量加载",
                "locked": false
            },
            "pyyaml": {
                "version": ">=6.0.2",
                "purpose": "YAML解析",
                "locked": false
            },
            "toml": {
                "version": ">=0.10.2",
                "purpose": "TOML解析",
                "locked": false
            }
        },
        "utilities": {
            "watchdog": {
                "version": ">=6.0.0",
                "purpose": "文件监控",
                "locked": false
            },
            "pathvalidate": {
                "version": ">=3.2.1",
                "purpose": "路径验证",
                "locked": false
            },
            "tqdm": {
                "version": ">=4.67.0",
                "purpose": "进度条",
                "locked": false
            },
            "psutil": {
                "version": ">=6.1.0",
                "purpose": "系统监控",
                "locked": false
            },
            "loguru": {
                "version": ">=0.7.3",
                "purpose": "日志记录",
                "locked": false
            },
            "colorlog": {
                "version": ">=6.9.0",
                "purpose": "彩色日志",
                "locked": false
            },
            "requests": {
                "version": ">=2.32.0",
                "purpose": "HTTP请求",
                "locked": false
            },
            "urllib3": {
                "version": ">=2.3.0",
                "purpose": "URL处理",
                "locked": false
            }
        },
        "security": {
            "cryptography": {
                "version": ">=43.0.0",
                "purpose": "加密库",
                "locked": false
            },
            "bcrypt": {
                "version": ">=4.2.0",
                "purpose": "密码哈希",
                "locked": false
            },
            "passlib": {
                "version": ">=1.7.4",
                "purpose": "密码工具",
                "locked": false
            }
        },
        "testing": {
            "pytest": {
                "version": ">=8.3.0",
                "purpose": "测试框架",
                "locked": false
            },
            "pytest-asyncio": {
                "version": ">=0.25.0",
                "purpose": "异步测试",
                "locked": false
            },
            "pytest-cov": {
                "version": ">=6.0.0",
                "purpose": "测试覆盖率",
                "locked": false
            },
            "pytest-mock": {
                "version": ">=3.14.0",
                "purpose": "测试模拟",
                "locked": false
            }
        },
        "quality": {
            "black": {
                "version": ">=25.0.0",
                "purpose": "代码格式化",
                "locked": false
            },
            "isort": {
                "version": ">=6.0.0",
                "purpose": "导入排序",
                "locked": false
            },
            "flake8": {
                "version": ">=7.1.0",
                "purpose": "代码检查",
                "locked": false
            },
            "mypy": {
                "version": ">=1.12.0",
                "purpose": "类型检查",
                "locked": false
            }
        },
        "tools": {
            "click": {
                "version": ">=8.1.7",
                "purpose": "命令行工具",
                "locked": false
            },
            "rich": {
                "version": ">=13.9.0",
                "purpose": "富文本终端",
                "locked": false
            },
            "typer": {
                "version": ">=0.15.0",
                "purpose": "CLI框架",
                "locked": false
            }
        },
        "platform": {
            "pywin32": {
                "version": ">=308",
                "purpose": "Windows API",
                "platform": "win32",
                "locked": false
            },
            "pyobjc": {
                "version": ">=10.0",
                "purpose": "macOS Objective-C桥接",
                "platform": "darwin",
                "locked": false
            }
        },
        "gpu": {
            "torch-cuda": {
                "version": ">=2.5.0+cu121",
                "purpose": "CUDA支持的PyTorch",
                "platform": "linux,win32",
                "optional": true,
                "locked": false
            },
            "torch-directml": {
                "version": ">=0.2.5",
                "purpose": "DirectML支持",
                "platform": "win32",
                "optional": true,
                "locked": false
            },
            "onnxruntime-gpu": {
                "version": ">=1.20.0",
                "purpose": "GPU推理加速",
                "platform": "linux,win32",
                "optional": true,
                "locked": false
            }
        },
        "development": {
            "pip-tools": {
                "version": ">=7.4.0",
                "purpose": "依赖管理",
                "optional": true,
                "locked": false
            },
            "pre-commit": {
                "version": ">=4.0.0",
                "purpose": "代码质量检查",
                "optional": true,
                "locked": false
            },
            "ipykernel": {
                "version": ">=6.30.0",
                "purpose": "Jupyter内核",
                "optional": true,
                "locked": false
            }
        }
    },
    "gpu": {
        "supportedBackends": ["cuda", "directml", "cpu"],
        "cuda": {
            "version": ">=11.8",
            "cudnn": ">=8.6.0",
            "minMemory": "4GB",
            "recommendedMemory": "8GB"
        },
        "directml": {
            "version": ">=12.0",
            "minMemory": "4GB"
        },
        "fallback": "cpu",
        "autoDetect": true
    },
    "externalServices": {
        "ollama": {
            "host": "http://localhost:11434",
            "timeout": 300,
            "healthCheckInterval": 30,
            "required": false
        },
        "virtualCamera": {
            "device": "/dev/video0",
            "width": 1920,
            "height": 1080,
            "fps": 30,
            "required": false
        }
    },
    "fileFormats": {
        "input": {
            "image": [".jpg", ".jpeg", ".png", ".bmp", ".webp", ".tiff"],
            "video": [".mp4", ".avi", ".mov", ".mkv", ".webm"],
            "model": [".onnx", ".pth", ".pt", ".bin"]
        },
        "output": {
            "image": [".jpg", ".png", ".webp"],
            "video": [".mp4"],
            "log": [".log"]
        }
    },
    "apiContracts": {
        "rest": {
            "version": "1.0",
            "basePath": "/api/v1",
            "endpoints": {
                "health": {
                    "method": "GET",
                    "path": "/health",
                    "response": "object"
                },
                "tasks": {
                    "method": "POST",
                    "path": "/tasks",
                    "request": "TaskRequest",
                    "response": "TaskResponse"
                },
                "taskStatus": {
                    "method": "GET",
                    "path": "/tasks/{taskId}",
                    "response": "TaskStatus"
                },
                "processImage": {
                    "method": "POST",
                    "path": "/process/image",
                    "request": "ImageProcessRequest",
                    "response": "ProcessResponse"
                },
                "processVideo": {
                    "method": "POST",
                    "path": "/process/video",
                    "request": "VideoProcessRequest",
                    "response": "ProcessResponse"
                }
            }
        },
        "websocket": {
            "endpoints": {
                "progress": {
                    "path": "/ws/progress",
                    "events": ["progress", "status"]
                },
                "logs": {
                    "path": "/ws/logs",
                    "events": ["log"]
                }
            }
        }
    },
    "codingStandards": {
        "style": {
            "language": "Python",
            "standard": "PEP 8",
            "formatter": "Black",
            "linter": "Ruff",
            "typeChecker": "MyPy"
        },
        "naming": {
            "classes": "PascalCase",
            "functions": "snake_case",
            "constants": "UPPER_SNAKE_CASE",
            "variables": "snake_case",
            "privateMembers": "prefix_underscore"
        },
        "documentation": {
            "required": true,
            "docstringStyle": "Google",
            "modules": true,
            "classes": true,
            "publicMethods": true,
            "complexFunctions": true
        },
        "errorHandling": {
            "strategy": "fail-fast with recovery",
            "logging": "required for all exceptions",
            "userMessages": "friendly and actionable",
            "recovery": "graceful degradation"
        },
        "testing": {
            "coverage": {
                "minimum": 80,
                "target": 90
            },
            "types": ["unit", "integration", "e2e"],
            "tools": ["pytest", "pytest-asyncio"]
        }
    },
    "performanceConstraints": {
        "memory": {
            "softLimit": "8GB",
            "hardLimit": "12GB",
            "perTask": "2GB",
            "monitoring": true
        },
        "cpu": {
            "maxUsage": 80,
            "threadsPerTask": 2,
            "parallelTasks": 4
        },
        "gpu": {
            "memoryFraction": 0.8,
            "perTaskFraction": 0.5
        },
        "latency": {
            "apiResponse": 100,
            "taskStart": 500,
            "realtimeFrame": 33
        },
        "throughput": {
            "imageProcessing": "10 images/second",
            "videoProcessing": "5 fps",
            "realtimeProcessing": "25 fps"
        }
    },
    "securityConstraints": {
        "inputValidation": {
            "filePaths": "sanitize and validate",
            "userInput": "sanitize and validate",
            "apiParams": "pydantic validation"
        },
        "fileSystem": {
            "allowedDirs": ["./assets", "./output", "./temp"],
            "forbiddenPaths": ["/etc", "/root", "/home"],
            "maxFileSize": "5GB"
        },
        "network": {
            "outbound": "ollama only",
            "inbound": "localhost only",
            "disabled": false
        },
        "privacy": {
            "dataRetention": "session only",
            "localProcessing": true,
            "noCloudUpload": true
        }
    },
    "deploymentConstraints": {
        "docker": {
            "baseImage": "python:3.10-slim",
            "exposedPorts": [8000],
            "volumeMounts": ["./assets:/app/assets"],
            "environment": ["PYTHONPATH=/app"]
        },
        "environment": {
            "development": "dev",
            "staging": "staging",
            "production": "production"
        }
    },
    "compatibilityMatrix": {
        "os": {
            "windows": {
                "versions": ["10", "11"],
                "gpuBackend": ["cuda", "directml"],
                "virtualCamera": ["OBS Virtual Camera"]
            },
            "linux": {
                "versions": ["Ubuntu 20.04+", "Debian 10+"],
                "gpuBackend": ["cuda"],
                "virtualCamera": ["v4l2loopback"]
            },
            "macos": {
                "versions": ["12+"],
                "gpuBackend": ["metal"],
                "virtualCamera": ["CamTwist"]
            }
        }
    },
    "thirdPartyEngines": {
        "deep-live-cam": {
            "version": "latest",
            "interface": "python module",
            "priority": 1,
            "features": ["realtime", "face-swap", "expression"]
        },
        "facefusion": {
            "version": "latest",
            "interface": "rest api",
            "priority": 2,
            "features": ["face-swap", "face-enhance", "batch"]
        },
        "iroop": {
            "version": "latest",
            "interface": "python module",
            "priority": 3,
            "features": ["one-shot", "face-swap"]
        }
    }
}

