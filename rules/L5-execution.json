{
    "meta": {
        "layer": "L5",
        "name": "执行层",
        "description": "具体的执行规则、操作指南和任务分配",
        "dependsOn": [
            "L1",
            "L2",
            "L3",
            "L4"
        ],
        "createdAt": "2026-01-16T00:00:00Z",
        "lastModified": "2026-01-16T00:00:00Z",
        "version": "1.0.0"
    },
    "executionPlan": {
        "phases": [
            {
                "phase": "initialization",
                "description": "系统初始化阶段",
                "steps": [
                    "加载配置",
                    "初始化日志系统",
                    "检查依赖",
                    "准备工作目录"
                ],
                "timeout": 30000
            },
            {
                "phase": "validation",
                "description": "输入验证阶段",
                "steps": [
                    "验证文件格式",
                    "检查文件完整性",
                    "验证参数范围",
                    "确认资源可用性"
                ],
                "timeout": 10000
            },
            {
                "phase": "processing",
                "description": "核心处理阶段",
                "steps": [
                    "加载AI模型",
                    "执行人脸检测",
                    "进行特征提取",
                    "执行人脸替换",
                    "后处理优化"
                ],
                "timeout": 300000
            },
            {
                "phase": "output",
                "description": "输出生成阶段",
                "steps": [
                    "编码输出文件",
                    "保存到指定路径",
                    "生成预览",
                    "清理临时文件"
                ],
                "timeout": 60000
            }
        ],
        "rollbackStrategy": {
            "enabled": true,
            "checkpoints": [
                "validation",
                "processing"
            ],
            "cleanupActions": [
                "删除临时文件",
                "释放GPU内存",
                "关闭文件句柄"
            ]
        }
    },
    "implementationDetails": {
        "engineSelection": {
            "primary": "deep-live-cam",
            "fallback": [
                "facefusion",
                "iroop"
            ],
            "criteria": {
                "realtime": "deep-live-cam",
                "quality": "facefusion",
                "compatibility": "iroop"
            }
        },
        "resourceAllocation": {
            "cpu": {
                "threads": 4,
                "priority": "normal"
            },
            "gpu": {
                "memoryFraction": 0.8,
                "allowGrowth": true
            },
            "memory": {
                "softLimit": "8GB",
                "hardLimit": "12GB"
            }
        },
        "errorRecovery": {
            "automaticRetry": {
                "maxAttempts": 3,
                "delayMs": 1000,
                "backoffMultiplier": 2
            },
            "gracefulDegradation": {
                "cpuFallback": true,
                "qualityReduction": true,
                "batchSizeReduction": true
            }
        },
        "monitoring": {
            "metrics": [
                "processing_time",
                "memory_usage",
                "gpu_utilization",
                "frame_rate",
                "error_rate"
            ],
            "alerts": {
                "memory_threshold": 0.9,
                "gpu_memory_threshold": 0.95,
                "processing_timeout": 300000
            }
        }
    },
    "taskWorkflows": {
        "image_to_camera": {
            "name": "图片合成到实时摄像头",
            "description": "将源图片中的人脸替换到实时摄像头画面",
            "steps": [
                {
                    "step": 1,
                    "name": "validate_input",
                    "description": "验证输入图片",
                    "action": "检查图片格式、大小、是否包含人脸",
                    "errorHandling": {
                        "invalid_format": "返回错误：请选择支持的图片格式(jpg, png, webp)",
                        "no_face": "警告：未检测到人脸，是否继续？",
                        "file_too_large": "错误：文件大小超过100MB"
                    },
                    "timeout": 5000
                },
                {
                    "step": 2,
                    "name": "load_source_image",
                    "description": "加载源图片",
                    "action": "读取图片文件，转换为numpy数组",
                    "outputs": [
                        "source_image"
                    ],
                    "errorHandling": {
                        "file_not_found": "错误：文件不存在",
                        "permission_denied": "错误：无权限读取文件"
                    }
                },
                {
                    "step": 3,
                    "name": "extract_face_features",
                    "description": "提取人脸特征",
                    "action": "使用InsightFace提取源图片人脸特征和关键点",
                    "outputs": [
                        "source_embedding",
                        "face_landmarks"
                    ],
                    "engine": "insightface",
                    "gpuPreferred": true
                },
                {
                    "step": 4,
                    "name": "initialize_camera",
                    "description": "初始化摄像头",
                    "action": "打开摄像头，获取视频流",
                    "outputs": [
                        "camera_stream"
                    ],
                    "errorHandling": {
                        "camera_not_found": "错误：未检测到摄像头",
                        "camera_busy": "错误：摄像头被其他程序占用"
                    }
                },
                {
                    "step": 5,
                    "name": "start_realtime_loop",
                    "description": "开始实时处理循环",
                    "action": "循环获取帧，检测人脸，替换人脸，输出到虚拟摄像头",
                    "outputs": [
                        "processed_stream"
                    ],
                    "performance": {
                        "targetFps": 25,
                        "maxLatency": 100
                    },
                    "controls": {
                        "pause": "暂停处理",
                        "resume": "恢复处理",
                        "stop": "停止处理并释放资源"
                    }
                },
                {
                    "step": 6,
                    "name": "cleanup",
                    "description": "清理资源",
                    "action": "释放摄像头，关闭虚拟摄像头输出",
                    "alwaysExecute": true
                }
            ],
            "defaultParameters": {
                "face_scale": 1.0,
                "enhance_quality": true,
                "output_fps": 30,
                "preview_enabled": true
            }
        },
        "image_to_video": {
            "name": "图片合成到视频",
            "description": "将源图片中的人脸替换到目标视频的每一帧",
            "steps": [
                {
                    "step": 1,
                    "name": "validate_inputs",
                    "description": "验证输入",
                    "action": "检查源图片和目标视频",
                    "errorHandling": {
                        "invalid_image": "错误：源图片格式不支持",
                        "invalid_video": "错误：目标视频格式不支持"
                    }
                },
                {
                    "step": 2,
                    "name": "load_source",
                    "description": "加载源图片",
                    "action": "读取并预处理源图片",
                    "outputs": [
                        "source_image"
                    ]
                },
                {
                    "step": 3,
                    "name": "load_target_video",
                    "description": "加载目标视频",
                    "action": "读取视频文件，提取帧列表",
                    "outputs": [
                        "video_frames",
                        "video_metadata"
                    ],
                    "progressReporting": {
                        "start": 10,
                        "end": 30
                    }
                },
                {
                    "step": 4,
                    "name": "extract_face_features",
                    "description": "提取人脸特征",
                    "action": "从源图片提取人脸特征",
                    "outputs": [
                        "face_embedding"
                    ],
                    "progressReporting": {
                        "start": 30,
                        "end": 40
                    }
                },
                {
                    "step": 5,
                    "name": "process_frames",
                    "description": "逐帧处理视频",
                    "action": "遍历每帧，检测人脸，替换人脸",
                    "outputs": [
                        "processed_frames"
                    ],
                    "engine": "deep-live-cam",
                    "progressReporting": {
                        "start": 40,
                        "end": 80,
                        "granularity": "per_frame"
                    }
                },
                {
                    "step": 6,
                    "name": "encode_output",
                    "description": "编码输出视频",
                    "action": "将处理后的帧合成新视频",
                    "progressReporting": {
                        "start": 80,
                        "end": 90
                    }
                },
                {
                    "step": 7,
                    "name": "save_output",
                    "description": "保存输出",
                    "action": "保存视频到指定路径",
                    "outputs": [
                        "output_path"
                    ],
                    "progressReporting": {
                        "start": 90,
                        "end": 100
                    }
                }
            ],
            "defaultParameters": {
                "output_format": "mp4",
                "output_quality": "high",
                "preserve_audio": true,
                "face_scale": 1.0,
                "enhance_quality": true
            }
        },
        "video_to_camera": {
            "name": "视频呈现到实时摄像头",
            "description": "将视频内容实时输出到虚拟摄像头",
            "steps": [
                {
                    "step": 1,
                    "name": "validate_video",
                    "description": "验证视频文件",
                    "action": "检查视频格式、分辨率、帧率"
                },
                {
                    "step": 2,
                    "name": "load_video",
                    "description": "加载视频",
                    "action": "读取视频文件"
                },
                {
                    "step": 3,
                    "name": "setup_virtual_camera",
                    "description": "设置虚拟摄像头",
                    "action": "初始化虚拟摄像头设备"
                },
                {
                    "step": 4,
                    "name": "start_playback_loop",
                    "description": "开始播放循环",
                    "action": "逐帧推送到虚拟摄像头"
                }
            ]
        },
        "image_to_image": {
            "name": "图片合成到图片",
            "description": "将源图片中的人脸替换到目标图片",
            "steps": [
                {
                    "step": 1,
                    "name": "validate_inputs",
                    "description": "验证源图片和目标图片"
                },
                {
                    "step": 2,
                    "name": "load_images",
                    "description": "加载源图片和目标图片"
                },
                {
                    "step": 3,
                    "name": "detect_faces",
                    "description": "检测目标图片人脸",
                    "action": "返回所有人脸区域供选择"
                },
                {
                    "step": 4,
                    "name": "select_target_face",
                    "description": "选择目标人脸",
                    "action": "用户选择要替换的人脸区域"
                },
                {
                    "step": 5,
                    "name": "swap_faces",
                    "description": "执行人脸替换"
                },
                {
                    "step": 6,
                    "name": "blend_result",
                    "description": "混合结果"
                },
                {
                    "step": 7,
                    "name": "save_output",
                    "description": "保存结果"
                }
            ]
        },
        "ai_analyze": {
            "name": "AI分析与理解",
            "description": "使用Ollama分析媒体内容并生成建议",
            "steps": [
                {
                    "step": 1,
                    "name": "understand_command",
                    "description": "理解用户命令",
                    "action": "使用Ollama解析自然语言命令",
                    "engine": "ollama"
                },
                {
                    "step": 2,
                    "name": "extract_parameters",
                    "description": "提取参数",
                    "action": "从解析结果中提取操作类型和参数"
                },
                {
                    "step": 3,
                    "name": "generate_execution_plan",
                    "description": "生成执行计划",
                    "action": "将AI决策转换为具体任务"
                }
            ]
        }
    },
    "stateMachine": {
        "states": {
            "IDLE": {
                "description": "空闲状态",
                "allowedTransitions": [
                    "SELECTING_SOURCE"
                ],
                "onEnter": "清除状态，重置计数器",
                "onExit": ""
            },
            "SELECTING_SOURCE": {
                "description": "选择源文件",
                "allowedTransitions": [
                    "SOURCE_SELECTED",
                    "IDLE"
                ],
                "onEnter": "打开文件选择对话框",
                "onExit": ""
            },
            "SOURCE_SELECTED": {
                "description": "已选择源文件",
                "allowedTransitions": [
                    "SELECTING_TARGET",
                    "PROCESSING",
                    "IDLE"
                ],
                "onEnter": "预览源文件",
                "onExit": ""
            },
            "SELECTING_TARGET": {
                "description": "选择目标",
                "allowedTransitions": [
                    "READY",
                    "IDLE"
                ],
                "onEnter": "打开目标选择对话框",
                "onExit": ""
            },
            "READY": {
                "description": "就绪",
                "allowedTransitions": [
                    "PROCESSING",
                    "IDLE"
                ],
                "onEnter": "显示参数确认界面",
                "onExit": ""
            },
            "PROCESSING": {
                "description": "处理中",
                "allowedTransitions": [
                    "PAUSED",
                    "COMPLETED",
                    "FAILED",
                    "CANCELLED"
                ],
                "onEnter": "启动处理任务",
                "onExit": "保存中间结果"
            },
            "PAUSED": {
                "description": "暂停",
                "allowedTransitions": [
                    "PROCESSING",
                    "CANCELLED"
                ],
                "onEnter": "暂停处理任务",
                "onExit": ""
            },
            "COMPLETED": {
                "description": "完成",
                "allowedTransitions": [
                    "IDLE",
                    "EXPORTING"
                ],
                "onEnter": "显示结果预览",
                "onExit": ""
            },
            "EXPORTING": {
                "description": "导出中",
                "allowedTransitions": [
                    "COMPLETED",
                    "IDLE"
                ],
                "onEnter": "开始导出",
                "onExit": ""
            },
            "FAILED": {
                "description": "失败",
                "allowedTransitions": [
                    "IDLE",
                    "RETRY"
                ],
                "onEnter": "显示错误信息",
                "onExit": ""
            },
            "RETRY": {
                "description": "重试",
                "allowedTransitions": [
                    "PROCESSING",
                    "IDLE"
                ],
                "onEnter": "重置参数后重新处理",
                "onExit": ""
            },
            "CANCELLED": {
                "description": "已取消",
                "allowedTransitions": [
                    "IDLE"
                ],
                "onEnter": "清理临时文件",
                "onExit": ""
            }
        },
        "initialState": "IDLE",
        "finalStates": [
            "COMPLETED",
            "CANCELLED",
            "FAILED"
        ]
    },
    "callbacks": {
        "onTaskStart": {
            "description": "任务开始时触发",
            "actions": [
                "记录任务开始日志",
                "初始化进度条",
                "清空临时文件"
            ]
        },
        "onTaskProgress": {
            "description": "任务进度更新时触发",
            "actions": [
                "更新进度条",
                "推送WebSocket消息",
                "更新状态缓存"
            ]
        },
        "onTaskComplete": {
            "description": "任务完成时触发",
            "actions": [
                "记录完成日志",
                "保存结果文件",
                "显示完成通知"
            ]
        },
        "onTaskError": {
            "description": "任务出错时触发",
            "actions": [
                "记录错误日志",
                "保存错误上下文",
                "显示错误提示"
            ]
        },
        "onTaskCancel": {
            "description": "任务取消时触发",
            "actions": [
                "停止处理线程",
                "清理临时文件",
                "释放资源"
            ]
        }
    },
    "errorHandling": {
        "retryPolicy": {
            "maxRetries": 3,
            "retryDelay": 1000,
            "exponentialBackoff": true,
            "retryableErrors": [
                "GPU_OUT_OF_MEMORY",
                "NETWORK_TIMEOUT",
                "FILE_READ_ERROR"
            ]
        },
        "fallbackStrategies": {
            "GPU_OUT_OF_MEMORY": {
                "description": "GPU内存不足时回退到CPU",
                "action": "切换到CPU模式处理",
                "notifyUser": true
            },
            "ENGINE_NOT_FOUND": {
                "description": "引擎不可用时使用备用引擎",
                "action": "切换到备用引擎",
                "notifyUser": true
            },
            "MODEL_LOAD_FAILED": {
                "description": "模型加载失败时重试或降级",
                "action": "尝试加载轻量级模型",
                "notifyUser": true
            }
        },
        "errorCodes": {
            "E001": {
                "message": "文件不存在",
                "description": "指定的文件路径不存在",
                "action": "提示用户重新选择文件",
                "severity": "error"
            },
            "E002": {
                "message": "文件格式不支持",
                "description": "文件格式不在支持列表中",
                "action": "提示用户选择支持的格式",
                "severity": "error"
            },
            "E003": {
                "message": "未检测到人脸",
                "description": "图片中未检测到人脸特征",
                "action": "询问用户是否继续或选择其他图片",
                "severity": "warning"
            },
            "E004": {
                "message": "内存不足",
                "description": "系统内存不足以完成处理",
                "action": "建议关闭其他程序或降低处理质量",
                "severity": "error"
            },
            "E005": {
                "message": "处理超时",
                "description": "任务处理超过预期时间",
                "action": "询问用户是否继续等待或取消",
                "severity": "warning"
            },
            "E006": {
                "message": "AI模型不可用",
                "description": "Ollama服务未运行",
                "action": "提示用户启动Ollama服务",
                "severity": "error"
            },
            "E007": {
                "message": "摄像头访问失败",
                "description": "无法访问摄像头设备",
                "action": "检查摄像头连接或权限设置",
                "severity": "error"
            }
        }
    },
    "performanceOptimization": {
        "caching": {
            "faceEmbeddings": {
                "enabled": true,
                "maxSize": 100,
                "ttl": 3600
            },
            "processedFrames": {
                "enabled": true,
                "maxSize": 50,
                "strategy": "LRU"
            },
            "modelWeights": {
                "enabled": true,
                "preload": [
                    "insightface",
                    "face_recognition"
                ]
            }
        },
        "parallelization": {
            "frameProcessing": {
                "enabled": true,
                "batchSize": 10,
                "workers": 4
            },
            "multiTask": {
                "enabled": true,
                "maxConcurrent": 2
            }
        },
        "resourceManagement": {
            "memory": {
                "cleanupInterval": 60000,
                "maxMemoryPercent": 80
            },
            "gpu": {
                "memoryGrowth": true,
                "maxMemoryFraction": 0.8
            },
            "threads": {
                "reuse": true,
                "maxWorkers": 8
            }
        }
    },
    "apiEndpoints": {
        "POST /api/v1/tasks": {
            "description": "创建新任务",
            "requestBody": {
                "type": "TaskRequest",
                "required": [
                    "taskType",
                    "sourcePath"
                ]
            },
            "responses": {
                "201": {
                    "description": "任务创建成功",
                    "body": "TaskCreatedResponse"
                },
                "400": {
                    "description": "请求参数错误",
                    "body": "ErrorResponse"
                }
            }
        },
        "GET /api/v1/tasks/{taskId}": {
            "description": "获取任务状态",
            "responses": {
                "200": {
                    "description": "任务状态",
                    "body": "TaskStatusResponse"
                },
                "404": {
                    "description": "任务不存在"
                }
            }
        },
        "DELETE /api/v1/tasks/{taskId}": {
            "description": "取消任务"
        },
        "POST /api/v1/process/image": {
            "description": "处理图片",
            "requestBody": {
                "type": "ImageProcessRequest"
            }
        },
        "POST /api/v1/process/video": {
            "description": "处理视频"
        }
    },
    "cliCommands": {
        "start": {
            "description": "启动应用",
            "options": [
                {
                    "flag": "--gui",
                    "description": "启动GUI模式",
                    "default": true
                },
                {
                    "flag": "--api",
                    "description": "启动API服务",
                    "default": true
                },
                {
                    "flag": "--port",
                    "description": "API服务端口",
                    "default": 8000
                }
            ]
        },
        "process": {
            "description": "处理媒体文件",
            "options": [
                {
                    "flag": "--type",
                    "description": "处理类型(image_to_video, image_to_image等)",
                    "required": true
                },
                {
                    "flag": "--source",
                    "description": "源文件路径",
                    "required": true
                },
                {
                    "flag": "--target",
                    "description": "目标文件路径"
                },
                {
                    "flag": "--output",
                    "description": "输出文件路径"
                }
            ]
        },
        "serve": {
            "description": "启动API服务器",
            "options": [
                {
                    "flag": "--host",
                    "description": "绑定地址",
                    "default": "0.0.0.0"
                },
                {
                    "flag": "--port",
                    "description": "端口",
                    "default": 8000
                }
            ]
        }
    },
    "checklist": {
        "preLaunch": [
            "检查Python版本 >= 3.10",
            "检查依赖安装",
            "检查Ollama服务运行状态",
            "检查GPU驱动版本",
            "确认虚拟摄像头可用(可选)"
        ],
        "preTask": [
            "验证输入文件存在且格式正确",
            "确认有足够磁盘空间",
            "检查GPU内存是否充足",
            "确认输出目录可写"
        ],
        "postTask": [
            "验证输出文件完整性",
            "清理临时文件",
            "记录任务日志",
            "更新任务历史"
        ],
        "webLaunch": [
            "检查Web依赖安装",
            "验证端口可用性(默认8080)",
            "检查静态文件完整性",
            "验证API端点可访问",
            "确认WebSocket连接正常"
        ]
    },
    "webOperations": {
        "dashboard": {
            "description": "主仪表板操作指南",
            "startup": [
                "启动Web服务: python web/start_monitor.py",
                "访问 http://localhost:8080",
                "等待系统数据加载完成"
            ],
            "monitoring": [
                "查看系统资源使用情况",
                "监控脚本运行状态",
                "检查部署进度更新",
                "关注系统警报通知"
            ]
        },
        "scriptManagement": {
            "description": "脚本管理操作流程",
            "listScripts": "查看所有可用脚本及其状态",
            "runScript": [
                "选择目标脚本",
                "点击运行按钮",
                "观察执行状态变化",
                "查看执行结果和日志"
            ],
            "batchOperations": [
                "使用'运行所有脚本'批量启动",
                "监控批量执行进度",
                "处理执行失败的脚本",
                "查看批量执行报告"
            ]
        },
        "systemMonitoring": {
            "description": "系统监控操作指南",
            "resourceView": [
                "查看CPU/内存/磁盘实时使用率",
                "观察资源使用趋势图表",
                "设置资源使用警报阈值",
                "导出监控数据报告"
            ],
            "performanceAnalysis": [
                "分析系统性能瓶颈",
                "查看进程资源使用详情",
                "监控网络连接状态",
                "生成性能优化建议"
            ]
        },
        "configuration": {
            "description": "配置管理操作流程",
            "viewConfig": [
                "选择配置组件(project/frontend/backend/scripts)",
                "查看JSON格式配置内容",
                "验证配置语法正确性",
                "检查配置与规则一致性"
            ],
            "editConfig": [
                "备份当前配置",
                "修改配置参数",
                "验证配置格式",
                "保存并应用配置",
                "重启相关服务"
            ]
        },
        "logging": {
            "description": "日志查看操作指南",
            "realtimeLogs": [
                "选择脚本或系统日志",
                "设置日志显示行数",
                "启用自动滚动",
                "使用过滤器搜索日志"
            ],
            "logAnalysis": [
                "查看错误和警告信息",
                "分析日志时间分布",
                "导出日志文件",
                "生成日志统计报告"
            ]
        },
        "apiTesting": {
            "description": "API调试操作流程",
            "endpointTesting": [
                "选择API端点",
                "设置请求参数",
                "发送测试请求",
                "查看响应结果"
            ],
            "monitoring": [
                "监控API响应时间",
                "检查错误率统计",
                "分析API调用频率",
                "设置API健康检查"
            ]
        }
    }
}