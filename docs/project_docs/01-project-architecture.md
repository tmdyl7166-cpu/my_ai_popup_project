# 项目整体架构设计

> 本文档描述夜灵AR多功能合成软件的系统架构和模块设计。

## 📊 架构概览

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          用户层 (User Layer)                             │
│  ┌─────────────────────┐    ┌─────────────────────┐                     │
│  │  PyQt5 桌面GUI      │    │   Web 监控中心      │                     │
│  │  (主弹窗界面)       │    │  (监控/管理界面)    │                     │
│  └──────────┬──────────┘    └──────────┬──────────┘                     │
└─────────────┼────────────────────────────┼────────────────────────────────
              │                            │
              ▼                            ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                       应用层 (Application Layer)                         │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │                     FastAPI 后端服务                              │   │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐    │   │
│  │  │ 任务管理器 │ │ 调度器     │ │ API网关    │ │ WebSocket  │    │   │
│  │  └────────────┘ └────────────┘ └────────────┘ └────────────┘    │   │
│  └──────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        AI层 (AI Processing Layer)                        │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐          │
│  │ Ollama     │ │ 人脸识别   │ │ 质量分析   │ │ 命令理解   │          │
│  │ 客户端     │ │ (Insight)  │ │  (Analyzers)│ │(Processors)│          │
│  └────────────┘ └────────────┘ └────────────┘ └────────────┘          │
└─────────────────────────────────────────────────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                      处理层 (Processing Layer)                           │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐          │
│  │ 图片处理   │ │ 视频处理   │ │ 批量处理   │ │ 实时处理   │          │
│  │ (Image)    │ │ (Video)    │ │ (Batch)    │ │ (Realtime) │          │
│  └────────────┘ └────────────┘ └────────────┘ └────────────┘          │
└─────────────────────────────────────────────────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                      集成层 (Integration Layer)                          │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐                          │
│  │Deep-Live-  │ │ FaceFusion │ │ iRoop      │                          │
│  │Cam         │ │            │ │ DeepFaceCam│                          │
│  └────────────┘ └────────────┘ └────────────┘                          │
└─────────────────────────────────────────────────────────────────────────┘
```

## 🏗️ 分层架构说明

### 1. 用户层 (Presentation Layer)

**技术**: PyQt5 + Bootstrap 5 + Vanilla JS

**职责**:

- 提供图形用户界面
- 接收用户输入
- 展示处理结果
- 实时进度反馈

**模块**:

- `src/frontend/` - PyQt5 桌面应用
- `web/` - Web 监控管理界面

### 2. 应用层 (Application Layer)

**技术**: FastAPI + WebSocket + Task Scheduler

**职责**:

- 提供 RESTful API
- 管理任务队列
- 处理业务逻辑
- 实时状态推送

**模块**:

- `src/backend/` - API 服务器
- `api/` - API 接口定义和映射

### 3. AI层 (AI Processing Layer)

**技术**: Ollama + InsightFace + PyTorch

**职责**:

- 本地 AI 推理
- 人脸检测与识别
- 质量分析
- 自然语言命令理解

**模块**:

- `src/ai/` - AI 核心模块
  - `ollama_client.py` - Ollama LLM 客户端
  - `face_recognition/` - 人脸识别
  - `analyzers/` - 分析器
  - `processors/` - 处理器

### 4. 处理层 (Processing Layer)

**技术**: OpenCV + MoviePy + Pillow

**职责**:

- 图像合成处理
- 视频帧处理
- 实时流处理
- 批量任务处理

**模块**:

- `src/processing/` - 处理引擎

### 5. 集成层 (Integration Layer)

**技术**: Deep-Live-Cam + FaceFusion + iRoop

**职责**:

- 第三方引擎封装
- 统一调用接口
- 引擎差异处理

**模块**:

- `src/integrations/` - 引擎集成

## 📦 模块结构

### src/ 目录结构

```
src/
├── frontend/           # 前端UI模块
│   ├── main_window.py     # 主窗口
│   ├── popup_window.py    # 弹窗窗口
│   ├── components/        # UI组件
│   └── styles/            # 样式文件
│
├── backend/            # 后端服务模块
│   ├── api_server.py      # FastAPI服务器
│   ├── task_manager.py    # 任务管理
│   ├── scheduler.py       # 任务调度
│   └── middleware/        # 中间件
│
├── ai/                 # AI模块
│   ├── ollama_client.py   # Ollama客户端
│   ├── face_recognition/  # 人脸识别
│   ├── analyzers/         # 分析器
│   └── processors/        # 处理器
│
├── processing/         # 处理模块
│   ├── image_processor.py # 图片处理
│   ├── video_processor.py # 视频处理
│   ├── batch_processor.py # 批量处理
│   └── realtime_processor.py # 实时处理
│
├── integrations/       # 集成模块
│   ├── deep_live_cam.py   # Deep-Live-Cam集成
│   ├── facefusion.py      # FaceFusion集成
│   └── iroop_deepfacecam.py # iRoop集成
│
├── utils/              # 工具模块
│   ├── file_utils.py      # 文件工具
│   ├── video_utils.py     # 视频工具
│   ├── image_utils.py     # 图片工具
│   └── logger.py          # 日志工具
│
└── config/             # 配置模块
    └── app_config.py      # 应用配置
```

## 🔄 数据流

### 核心数据流路径

```
用户选择源图片/视频
    │
    ▼
┌─────────────────┐
│   前端界面      │
│  (接收用户输入) │
└────────┬────────┘
         │ API 调用
         ▼
┌─────────────────┐
│   后端服务      │
│  (任务创建)     │
└────────┬────────┘
         │ 任务分发
         ▼
┌─────────────────┐
│   AI模块        │
│  (人脸检测)     │
└────────┬────────┘
         │ 参数提取
         ▼
┌─────────────────┐
│   处理模块      │
│  (执行合成)     │
└────────┬────────┘
         │ 引擎调用
         ▼
┌─────────────────┐
│   集成模块      │
│  (第三方引擎)   │
└────────┬────────┘
         │ 结果返回
         ▼
┌─────────────────┐
│   前端界面      │
│  (展示结果)     │
└─────────────────┘
```

### 实时数据流

```
摄像头/视频流
    │
    ▼
┌─────────────────┐
│   实时处理      │
│  (帧捕获)       │
└────────┬────────┘
         │ 人脸检测
         ▼
┌─────────────────┐
│   AI模块        │
│  (特征提取)     │
└────────┬────────┘
         │ 人脸替换
         ▼
┌─────────────────┐
│   集成模块      │
│  (引擎处理)     │
└────────┬────────┘
         │ 输出流
         ▼
┌─────────────────┐
│   虚拟摄像头    │
│  (OBS输出)      │
└─────────────────┘
```

## 🔗 模块依赖关系

```
frontend    ─────▶   backend
    │                   │
    │                   ▼
    │              ┌─────────┐
    └──▶ config ◀──┤   ai    │
                    └───┬─────┘
                        │
                        ▼
                   ┌─────────┐
                   │processing│
                    └───┬─────┘
                        │
                        ▼
                   ┌─────────┐
                   │integrations│
```

**依赖规则**:

- 前端依赖后端和配置
- 后端依赖 AI、处理和工具
- AI 依赖配置、集成和工具
- 处理依赖 AI、工具和集成
- 集成依赖工具
- 工具无依赖

## 🌐 通信模式

### 1. 同步请求-响应 (API 调用)

```
前端 ─── HTTP POST ──▶ 后端 ─── 处理 ──▶ 响应 ──▶ 前端
```

### 2. 异步事件驱动 (进度更新)

```
处理模块 ─── 事件 ──▶ 消息队列 ─── 推送 ──▶ WebSocket ──▶ 前端
```

### 3. 回调机制 (AI 完成通知)

```
AI模块 ─── 回调 ──▶ 处理模块 ─── 继续处理
```

### 4. 流式传输 (实时视频)

```
实时处理 ─── 流 ──▶ WebSocket ──▶ 前端预览
```

## 📋 配置管理

### 配置文件层次

```
project_config.json     # 项目全局配置
├── rules/              # 规则配置
│   ├── L1-meta-goal.json
│   ├── L2-understanding.json
│   ├── L3-constraints.json
│   ├── L4-decisions.json
│   └── L5-execution.json
├── src/config/         # 源码配置
│   └── app_config.py
├── api/config/         # API配置
│   └── api_config.json
├── scripts/            # 脚本配置
│   └── scripts_config.json
└── web/                # Web配置
    └── web_config.json
```

## 🔧 扩展性设计

### 插件机制

```
新引擎集成步骤:
1. 在 src/integrations/ 创建引擎封装类
2. 实现统一接口 (start, stop, process)
3. 在 integrations_config.json 注册
4. 添加单元测试
5. 更新文档
```

### 配置扩展

```
新增配置项步骤:
1. 在对应 config 文件添加配置节
2. 更新配置验证规则
3. 在应用层加载配置
4. 添加配置说明文档
```

## 📊 性能考虑

### 异步处理

- 任务队列管理
- 线程池处理
- GPU 加速支持

### 缓存策略

- 人脸特征缓存
- 模型预加载
- 处理结果缓存

### 资源管理

- 内存使用监控
- GPU 内存管理
- 并发任务限制

## 🔒 安全考虑

### 数据安全

- 本地处理，不上传云端
- 文件路径验证
- 输入数据消毒

### 访问控制

- 本地服务仅监听 localhost
- 可选的认证机制
- 日志审计

## 📝 文档版本

| 版本 | 日期 | 修改内容 |
|------|------|----------|
| 1.0 | 2026-01-19 | 初始版本 |

## 🔗 相关文档

- [运行时逻辑流程](02-runtime-logic.md)
- [依赖和配置说明](03-dependencies-config.md)
- [API接口文档](04-frontend-backend-api.md)
- [自动化脚本说明](05-automation-scripts.md)
