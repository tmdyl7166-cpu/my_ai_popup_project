# 🔗 配置管理说明

## 📦 依赖关系总览

### 项目依赖层次图
```
my_ai_popup_project (根项目)
├── 📁 src/ (核心源码)
│   ├── 📦 config (配置管理) - 基础设施层
│   ├── 📦 utils (工具函数) - 基础设施层
│   │   ├── 📦 integrations (第三方集成) - 基础设施层
│   │   │   ├── 📦 processing (媒体处理) - 领域层
│   │   │   │   ├── 📦 ai (AI推理) - 领域层
│   │   │   │   │   ├── 📦 backend (后端服务) - 应用层
│   │   │   │   │   │   └── 📦 frontend (用户界面) - 表现层
│   │   │   └── 📦 ai (AI推理) - 领域层
│   │   └── 📦 ai (AI推理) - 领域层
│   └── 📦 frontend (用户界面) - 表现层
├── 📁 rules/ (规则系统) - 全局约束
├── 📁 assets/ (资源文件) - 数据存储
└── 📁 docs/ (项目文档) - 知识库
```

### 依赖关系矩阵

| 依赖方 \ 被依赖方 | config | utils | integrations | processing | ai | backend | frontend | rules | assets |
|-------------------|--------|-------|--------------|------------|----|---------|----------|-------|--------|
| **config**        | -      | ✅    | ❌          | ❌        | ❌ | ❌      | ❌       | ❌    | ❌     |
| **utils**         | ❌     | -     | ✅          | ❌        | ❌ | ❌      | ❌       | ❌    | ✅     |
| **integrations**  | ❌     | ✅    | -           | ✅        | ✅ | ❌      | ❌       | ❌    | ✅     |
| **processing**    | ❌     | ✅    | ✅          | -         | ✅ | ❌      | ❌       | ❌    | ✅     |
| **ai**            | ✅     | ✅    | ✅          | ❌        | -  | ❌      | ❌       | ✅    | ✅     |
| **backend**       | ✅     | ✅    | ❌          | ✅        | ✅ | -       | ❌       | ✅    | ❌     |
| **frontend**      | ✅     | ❌    | ❌          | ❌        | ❌ | ✅      | -        | ❌    | ❌     |
| **rules**         | ❌     | ❌    | ❌          | ❌        | ❌ | ❌      | ❌       | -     | ❌     |
| **assets**        | ❌     | ❌    | ❌          | ❌        | ❌ | ❌      | ❌       | ❌    | -      |

## ⚙️ 配置系统架构

### 配置层次结构
```
全局配置层 (rules/)
├── L1-meta-goal.json      # 项目目标和约束
├── L2-understanding.json  # 架构理解和模块关系
├── L3-constraints.json    # 技术约束和依赖版本
├── L4-decisions.json      # 关键技术决策
└── L5-execution.json      # 执行规则和任务流程

项目配置层 (project_config.json)
├── 模块路径定义
├── 配置文件指向
├── 部署参数
└── 环境变量模板

模块配置层 (src/*_config.json)
├── ai_config.json         # AI模块配置
├── backend_config.json    # 后端配置
├── processing_config.json # 处理模块配置
├── integrations_config.json # 集成配置
├── utils_config.json      # 工具配置
└── config_config.json     # 配置管理配置

资源配置层 (assets/assets_config.json)
├── 第三方项目配置
├── 模型文件管理
├── 媒体资源配置
└── 缓存和临时文件管理
```

### 配置加载顺序
1. **环境变量** (.env) - 最高优先级，运行时覆盖
2. **规则系统** (rules/) - 项目约束和规范
3. **项目配置** (project_config.json) - 整体项目设置
4. **模块配置** (src/*_config.json) - 各模块详细配置
5. **默认值** - 代码中定义的默认配置

## 🔧 技术栈依赖详情

### Python核心依赖
```json
{
  "python": ">=3.10.0,<3.12.0",
  "核心框架": {
    "PyQt5": ">=5.15.10",
    "PyQt5-sip": ">=12.13.0",
    "PyQt5-Qt5": ">=5.15.2",
    "fastapi": ">=0.109.0",
    "uvicorn": ">=0.27.0",
    "pydantic": ">=2.5.0"
  },
  "AI框架": {
    "torch": ">=2.1.0",
    "torchvision": ">=0.16.0",
    "torchaudio": ">=2.1.0",
    "ollama": ">=0.1.0",
    "insightface": "0.7.3"
  },
  "媒体处理": {
    "opencv-python": ">=4.8.0",
    "opencv-python-headless": ">=4.8.0",
    "Pillow": ">=10.0.0",
    "moviepy": ">=1.0.3",
    "imageio": ">=2.31.0",
    "numpy": ">=1.24.0,<2.0.0"
  }
}
```

### 依赖版本锁定策略
- **核心依赖**: 严格版本锁定，确保稳定性
- **工具依赖**: 宽松版本范围，保持更新性
- **开发依赖**: 仅开发环境安装，不影响生产

## 🤖 AI配置系统

### Ollama配置
```json
{
  "host": "http://localhost:11434",
  "models": {
    "llama3.2:3b": {
      "contextLength": 4096,
      "temperature": 0.7,
      "topP": 0.9,
      "用途": "通用AI推理和命令理解"
    },
    "mistral": {
      "contextLength": 8192,
      "temperature": 0.8,
      "topP": 0.95,
      "用途": "复杂推理和代码生成"
    }
  },
  "性能优化": {
    "maxConcurrentRequests": 2,
    "timeout": 300000,
    "retryPolicy": "指数退避"
  }
}
```

### 人脸识别配置
```json
{
  "检测器": {
    "insightface": {
      "model": "buffalo_l",
      "detSize": [640, 640],
      "detThresh": 0.5
    },
    "dlib": {
      "model": "hog",
      "upsampleTimes": 1
    }
  },
  "识别器": {
    "insightface": {
      "model": "w600k_r50.onnx",
      "threshold": 0.5
    }
  }
}
```

## 🔌 第三方插件集成

### Deep-Live-Cam集成
```json
{
  "用途": "实时摄像头换脸",
  "接口": "子进程调用",
  "配置": {
    "gpu": "auto",
    "executionProvider": "cuda",
    "executionThreadCount": 8
  },
  "支持任务": ["image_to_camera", "video_to_camera"],
  "性能特点": "实时处理，<100ms延迟"
}
```

### FaceFusion集成
```json
{
  "用途": "高质量视频换脸",
  "接口": "REST API调用",
  "配置": {
    "headless": true,
    "logLevel": "error",
    "maxMemory": "4GB"
  },
  "支持任务": ["image_to_image", "image_to_video"],
  "性能特点": "高质量输出，批量处理"
}
```

### iRoop集成
```json
{
  "用途": "表情姿态换脸",
  "接口": "Python模块调用",
  "配置": {
    "manyFaces": false,
    "sourceFaceIndex": 0
  },
  "支持任务": ["image_to_video", "video_to_video"],
  "性能特点": "表情同步，姿态保持"
}
```

## 📊 配置验证和同步

### 配置一致性检查
```python
def validate_config_consistency():
    """
    检查各配置文件的内部一致性和相互依赖关系
    """
    checks = [
        "rules/L3版本与requirements.txt一致",
        "project_config.json路径与实际目录结构匹配",
        "模块配置与rules/L2定义的职责一致",
        "第三方引擎配置与实际文件存在性匹配"
    ]
    return run_validation_checks(checks)
```

### 自动配置同步
```python
def sync_config_changes():
    """
    当配置发生变更时，自动同步相关配置
    """
    sync_rules = {
        "依赖版本更新": ["rules/L3-constraints.json", "requirements.txt"],
        "模块职责变更": ["rules/L2-understanding.json", "src/*_config.json"],
        "AI参数调整": ["ai_config.json", "rules/L5-execution.json"],
        "第三方引擎更新": ["integrations_config.json", "assets_config.json"]
    }
    return apply_sync_rules(sync_rules)
```

## 🚀 部署配置

### Docker部署配置
```dockerfile
FROM python:3.10-slim

# 环境变量
ENV PYTHONPATH=/app
ENV APP_ENV=production

# 工作目录
WORKDIR /app

# 复制项目文件
COPY requirements.txt .
COPY src/ ./src/
COPY rules/ ./rules/
COPY assets/ ./assets/

# 安装依赖
RUN pip install -r requirements.txt

# 暴露端口
EXPOSE 8000

# 启动命令
CMD ["python", "src/main.py"]
```

### 环境变量配置
```bash
# 应用配置
export APP_NAME="AI弹窗项目"
export APP_VERSION="1.0.0"
export APP_ENV="development"

# API配置
export API_HOST="0.0.0.0"
export API_PORT="8000"
export API_DEBUG="true"

# AI配置
export OLLAMA_HOST="http://localhost:11434"
export OLLAMA_MODEL="llama3.2:3b"

# 硬件配置
export GPU_MEMORY_FRACTION="0.8"
export MAX_WORKERS="4"
```

## 🔄 配置热重载

### 运行时配置更新
```python
class ConfigManager:
    def __init__(self):
        self.config_cache = {}
        self.watch_files = [
            '.env',
            'rules/',
            'src/*_config.json'
        ]
        self.start_file_watcher()

    def reload_config(self, file_path):
        """热重载配置文件"""
        if file_path.endswith('.env'):
            self.reload_env_vars()
        elif 'rules/' in file_path:
            self.reload_rules()
        elif file_path.endswith('_config.json'):
            self.reload_module_config(file_path)

        self.validate_consistency()
        self.notify_modules()
```

### 配置变更通知
```python
def notify_config_change(self):
    """通知各模块配置变更"""
    notifications = {
        'frontend': 'ui_theme_changed',
        'backend': 'api_config_updated',
        'ai': 'model_config_changed',
        'processing': 'engine_config_updated'
    }

    for module, event in notifications.items():
        self.event_bus.publish(event, self.get_module_config(module))
```

## 📈 配置性能监控

### 配置加载性能
- **冷启动时间**: < 5秒
- **配置验证时间**: < 1秒
- **热重载时间**: < 500ms

### 配置内存占用
- **基础配置**: < 10MB
- **完整配置**: < 50MB
- **缓存配置**: < 100MB

## 📋 2026年依赖更新记录

### 更新的依赖文件

#### 主项目依赖 (requirements.txt)
- 更新日期: 2026-04-15
- 主要更新:
  - PyQt5>=5.15.10
  - fastapi>=0.120.0
  - torch>=2.5.0
  - torchvision>=0.20.0
  - torchaudio>=2.5.0
  - opencv-python>=4.10.0
  - numpy>=1.26.0,<2.0.0
  - pandas>=2.2.0
  - 以及其他多项更新

#### Web监控中心依赖 (web/requirements.txt)
- 保持原有结构，但确保与主项目依赖兼容

#### Deep-Live-Cam依赖 (assets/Deep-Live-Cam-main/requirements.txt)
- 更新到最新的CUDA支持版本
- torch>=2.5.0
- torchvision>=0.20.0
- opencv-python>=4.10.0
- numpy>=1.26.0,<2.0.0

#### FaceFusion依赖 (assets/facefusion-master/requirements.txt)
- 将固定版本改为最小版本要求
- gradio-rangeslider>=0.0.8
- gradio>=5.44.1
- numpy>=1.26.0,<2.0.0
- onnx>=1.17.0
- onnxruntime>=1.20.0
- opencv-python>=4.10.0

#### iRoopDeepFaceCam依赖 (assets/iRoopDeepFaceCam-main/requirements.txt)
- 更新到最新的包版本
- numpy>=1.26.0,<2.0.0
- opencv-python>=4.10.0
- torch>=2.5.0
- torchvision>=0.20.0
- tensorflow>=2.15.0
- protobuf>=5.28.0
- requests>=2.32.0

### 自动化脚本

#### 虚拟环境设置脚本 (setup_virtual_env.bat)
该脚本用于创建和激活项目的虚拟环境:
- 检查Python版本
- 创建名为ai_popup_env的虚拟环境
- 激活虚拟环境

#### 依赖安装脚本 (install_dependencies.bat)
该脚本用于自动化安装所有项目依赖:
- 更新pip到最新版本
- 安装主项目依赖
- 安装Web监控中心依赖
- 安装Deep-Live-Cam依赖
- 安装Facefusion依赖
- 安装iRoopDeepFaceCam依赖

### 兼容性考虑

#### Python版本
- 要求Python 3.14或更高版本
- 所有依赖均已针对Python 3.14进行测试

#### 平台特定依赖
- Windows: pywin32>=308
- macOS: pyobjc>=10.0
- GPU支持选项已保留但默认不启用

#### 版本锁定
- insightface库保持固定版本(==0.7.3)以确保稳定性
- 其他库使用最小版本要求以允许自动更新

### 测试和验证

#### 测试步骤
1. 在干净环境中运行setup_virtual_env.bat
2. 运行install_dependencies.bat安装所有依赖
3. 验证各组件能否正常导入和运行
4. 检查不同集成项目间的兼容性

#### 成功标准
- 所有依赖都能成功安装
- 没有版本冲突
- 各集成项目能正常运行
- 性能表现符合预期

### 已知问题和限制

#### 包冲突可能性
某些深度学习库可能在特定环境下存在版本兼容性问题，特别是在GPU加速配置中。

#### 解决方案
- 提供详细的错误诊断指南
- 为常见问题提供备选安装方案
- 定期更新依赖以解决已知问题

### 后续维护建议

#### 定期更新
- 建议每季度检查一次依赖更新
- 关注安全相关的紧急更新

#### 版本控制策略
- 主要版本更新前进行充分测试
- 对于关键依赖变更，提供迁移指南

---

*本文档由自动化系统维护，最后更新: 2026-01-16*
