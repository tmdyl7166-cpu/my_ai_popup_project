# 🏗️ 项目架构说明

## 📊 项目架构总览

### 分层架构图
```
┌─────────────────────────────────────────────────────────────┐
│                    Presentation Layer                       │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐  │
│  │   Main Window   │  │   Popup Window  │  │  Components │  │
│  │   (PyQt5 GUI)   │  │   (AI Entry)    │  │   (UI Parts) │  │
│  └─────────────────┘  └─────────────────┘  └─────────────┘  │
└─────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────┐
│                   Application Layer                         │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐  │
│  │  Task Manager   │  │    Scheduler    │  │ API Server  │  │
│  │ (任务管理/状态) │  │  (任务调度)     │  │ (REST API)  │  │
│  └─────────────────┘  └─────────────────┘  └─────────────┘  │
└─────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────┐
│                     Domain Layer                            │
│  ┌─────────────────┐  ┌─────────────────┐                   │
│  │   AI Module     │  │ Processing Mod  │                   │
│  │ (Ollama推理)    │  │ (媒体处理)      │                   │
│  └─────────────────┘  └─────────────────┘                   │
└─────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────┐
│                  Infrastructure Layer                       │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐  │
│  │  Integrations   │  │    Utils       │  │   Config    │  │
│  │ (第三方引擎)    │  │  (工具函数)    │  │ (配置管理)  │  │
│  └─────────────────┘  └─────────────────┘  └─────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

## 📁 目录结构详解

### 根目录结构
```
my_ai_popup_project/
├── 📁 assets/              # 资源和第三方项目
│   ├── 📁 Deep-Live-Cam-main/    # 实时换脸引擎
│   ├── 📁 facefusion-master/     # 高质量视频换脸
│   ├── 📁 iRoopDeepFaceCam-main/ # 表情/姿态换脸
│   ├── 📁 images/                # 图片资源
│   ├── 📁 videos/                # 视频资源
│   ├── 📁 models/                # AI模型
│   └── assets_config.json        # 资源配置
├── 📁 docs/                # 项目文档
│   ├── 📁 project_docs/          # 项目文档
│   ├── 📁 deployment_progress/   # 部署进度
│   ├── docs_config.json          # 文档配置
│   └── docs_README.md            # 文档说明
├── 📁 rules/               # 规则系统
│   ├── L1-meta-goal.json         # 元目标层
│   ├── L2-understanding.json     # 全局理解层
│   ├── L3-constraints.json       # 约束层
│   ├── L4-decisions.json         # 决策层
│   ├── L5-execution.json         # 执行层
│   ├── rules.config.js           # 规则配置
│   └── 📁 data/                  # 规则数据
├── 📁 src/                 # 源代码
│   ├── 📁 ai/                     # AI模块
│   ├── 📁 backend/                # 后端服务
│   ├── 📁 config/                 # 配置模块
│   ├── 📁 frontend/               # 前端UI
│   ├── 📁 integrations/           # 集成模块
│   ├── 📁 processing/             # 处理模块
│   ├── 📁 utils/                  # 工具模块
│   ├── entry.py                   # 入口脚本
│   ├── main.py                    # 主入口
│   ├── src_config.json            # 源码配置
│   └── src_config_refactor.json   # 重构配置
├── 📁 tests/               # 测试代码
├── 📁 logs/                # 日志文件
├── 📁 health_monitor/      # 健康监控脚本
├── project_config.json     # 项目配置
├── requirements.txt        # Python依赖
├── start.sh                # 启动脚本
├── TODO.md                 # 任务跟踪
├── README.md               # 项目说明
└── verify_paths.py         # 路径验证
```

### 模块详细结构

#### 🎨 前端模块 (src/frontend/)
```
frontend/
├── __init__.py
├── main_window.py          # 主窗口
├── popup_window.py         # 弹窗窗口
├── components/             # UI组件
│   ├── video_panel.py      # 视频面板
│   ├── image_panel.py      # 图片面板
│   ├── progress_bar.py     # 进度条
│   └── control_buttons.py  # 控制按钮
├── styles/                 # 样式文件
└── frontend_config.json    # 前端配置
```

#### 🔧 后端模块 (src/backend/)
```
backend/
├── __init__.py
├── api_server.py          # API服务器
├── task_manager.py         # 任务管理器
├── scheduler.py            # 任务调度器
├── middleware/             # 中间件
│   ├── logging_middleware.py    # 日志中间件
│   └── auth_middleware.py       # 认证中间件
└── backend_config.json     # 后端配置
```

#### 🤖 AI模块 (src/ai/)
```
ai/
├── __init__.py
├── ollama_client.py        # Ollama客户端
├── analyzers/              # 分析器
├── face_recognition/       # 人脸识别
├── processors/             # 处理器
└── ai_config.json          # AI配置
```

#### ⚙️ 处理模块 (src/processing/)
```
processing/
├── __init__.py
├── video_processor.py      # 视频处理器
├── image_processor.py      # 图片处理器
├── realtime_processor.py   # 实时处理器
├── batch_processor.py      # 批量处理器
└── processing_config.json  # 处理配置
```

#### 🔗 集成模块 (src/integrations/)
```
integrations/
├── __init__.py
├── deep_live_cam.py        # Deep-Live-Cam集成
├── facefusion.py           # FaceFusion集成
├── iroop_deepfacecam.py    # iRoop集成
└── integrations_config.json # 集成配置
```

#### 🛠️ 工具模块 (src/utils/)
```
utils/
├── __init__.py
├── file_utils.py           # 文件工具
├── video_utils.py          # 视频工具
├── image_utils.py          # 图片工具
├── thread_utils.py         # 线程工具
├── logger.py               # 日志工具
├── path_resolver.py        # 路径解析
└── utils_config.json       # 工具配置
```

#### ⚙️ 配置模块 (src/config/)
```
config/
├── __init__.py
├── app_config.py           # 应用配置
└── config_config.json      # 配置管理配置
```

## 🔄 数据流向图

### 用户操作到结果输出的完整流程
```
用户输入
    ↓
前端UI (PyQt5)
    ↓ (API调用)
后端API (FastAPI)
    ↓ (任务创建)
任务管理器 (TaskManager)
    ↓ (任务调度)
调度器 (Scheduler)
    ↓ (AI决策)
AI模块 (Ollama推理)
    ↓ (参数优化)
处理模块 (Processing)
    ↓ (引擎调用)
集成模块 (Integrations)
    ↓ (第三方引擎)
Deep-Live-Cam / FaceFusion / iRoop
    ↓ (结果返回)
处理模块 (结果处理)
    ↓ (状态更新)
任务管理器 (状态更新)
    ↓ (进度推送)
前端UI (实时更新)
    ↓
用户看到结果
```

## 📋 模块职责矩阵

| 模块 | 用户界面 | 业务逻辑 | 数据处理 | 外部集成 | 配置管理 | 日志监控 |
|------|----------|----------|----------|----------|----------|----------|
| frontend | ✅ 主负责 | ❌ | ❌ | ❌ | ❌ | ❌ |
| backend | ❌ | ✅ 主负责 | ✅ 辅助 | ❌ | ✅ 辅助 | ✅ 辅助 |
| ai | ❌ | ✅ 主负责 | ✅ 主负责 | ❌ | ✅ 辅助 | ❌ |
| processing | ❌ | ✅ 辅助 | ✅ 主负责 | ✅ 辅助 | ❌ | ❌ |
| integrations | ❌ | ❌ | ❌ | ✅ 主负责 | ❌ | ✅ 辅助 |
| utils | ❌ | ❌ | ✅ 辅助 | ❌ | ❌ | ✅ 主负责 |
| config | ❌ | ❌ | ❌ | ❌ | ✅ 主负责 | ❌ |

## 🔗 依赖关系图

### 模块依赖关系
```
config (基础设施)
├── utils (基础设施)
│   ├── integrations (基础设施)
│   │   ├── processing (领域)
│   │   │   ├── ai (领域)
│   │   │   │   ├── backend (应用)
│   │   │   │   │   └── frontend (表现)
│   │   └── ai (领域)
│   └── ai (领域)
└── frontend (表现)
```

### 技术栈依赖
- **Python 3.10+**: 核心运行环境
- **PyQt5**: 桌面GUI框架
- **FastAPI**: Web框架和API
- **Ollama**: 本地AI推理
- **OpenCV/Pillow**: 图像视频处理
- **Torch**: 深度学习框架
- **第三方引擎**: Deep-Live-Cam, FaceFusion, iRoop

## 🚀 部署架构

### 单机部署架构
```
┌─────────────────────────────────────────────────────────────┐
│                    用户桌面环境                             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                AI弹窗应用                           │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │    │
│  │  │   Frontend  │  │   Backend   │  │   AI Core   │  │    │
│  │  │   (PyQt5)   │  │  (FastAPI)  │  │  (Ollama)   │  │    │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                            │
│  ┌─────────────────────────────────────────────────────┐    │
│  │              第三方引擎集成                          │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │    │
│  │  │ Deep-Live- │  │  FaceFusion │  │    iRoop    │  │    │
│  │  │    Cam     │  │             │  │             │  │    │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

### 资源管理架构
- **本地优先**: 所有数据处理在本地完成
- **GPU加速**: 支持CUDA/DirectML/OpenCL
- **内存管理**: 智能缓存和垃圾回收
- **存储优化**: 压缩存储和自动清理

## 🚀 项目启动流程

### 1️⃣ 环境初始化阶段
```mermaid
graph TD
    A[用户启动] --> B[检查Python版本 3.10+]
    B --> C[加载环境变量 .env]
    C --> D[验证系统依赖]
    D --> E[检查GPU/硬件加速]
    E --> F[初始化日志系统]
```

### 2️⃣ 配置加载阶段
```mermaid
graph TD
    A[读取project_config.json] --> B[加载rules/五层规则]
    B --> C[初始化各模块配置]
    C --> D[验证配置一致性]
    D --> E[建立模块间依赖关系]
```

### 3️⃣ 服务启动阶段
```mermaid
graph TD
    A[启动Ollama服务] --> B[初始化AI客户端]
    B --> C[启动FastAPI后端]
    C --> D[初始化任务管理器]
    D --> E[启动任务调度器]
    E --> F[加载第三方引擎]
    F --> G[启动PyQt5前端]
```

## 🔄 运行时序图

### 完整用户操作流程
```mermaid
sequenceDiagram
    participant U as 用户
    participant F as 前端(PyQt5)
    participant B as 后端(FastAPI)
    participant T as 任务管理器
    participant S as 调度器
    participant A as AI模块
    participant P as 处理模块
    participant I as 集成模块
    participant E as 第三方引擎

    U->>F: 点击弹窗按钮
    F->>B: 发送任务请求
    B->>T: 创建新任务
    T->>S: 提交任务到调度器
    S->>A: 请求AI决策
    A->>A: Ollama推理分析
    A->>T: 返回处理参数
    T->>S: 更新任务状态
    S->>P: 启动处理任务
    P->>I: 调用第三方引擎
    I->>E: 执行换脸处理
    E->>I: 返回处理结果
    I->>P: 结果处理完成
    P->>T: 更新任务状态
    T->>B: 推送进度更新
    B->>F: 实时进度反馈
    F->>U: 显示处理结果
```

## 🤖 AI执行逻辑

### AI决策流程
```mermaid
flowchart TD
    A[用户输入自然语言] --> B[前端收集上下文信息]
    B --> C[发送到后端API]
    C --> D[后端转发到AI模块]
    D --> E[Ollama客户端处理]
    E --> F{意图识别}
    F -->|图片合成| G[提取源/目标路径]
    F -->|视频处理| H[分析视频参数]
    F -->|实时换脸| I[配置摄像头参数]
    G --> J[规则系统裁决]
    H --> J
    I --> J
    J --> K{安全检查通过?}
    K -->|是| L[生成执行计划]
    K -->|否| M[返回拒绝原因]
    L --> N[返回处理参数]
    M --> O[用户提示错误]
```

### AI参数优化逻辑
```mermaid
flowchart TD
    A[接收基础参数] --> B[分析源文件特征]
    B --> C[检测人脸质量]
    C --> D[评估目标复杂度]
    D --> E[选择最优引擎]
    E --> F[调整处理参数]
    F --> G[预测处理时间]
    G --> H[优化资源分配]
    H --> I[生成最终配置]
```

## 📊 任务状态机

### 任务生命周期
```mermaid
stateDiagram-v2
    [*] --> IDLE: 创建任务
    IDLE --> PENDING: 用户确认
    PENDING --> RUNNING: 调度执行
    RUNNING --> PROCESSING: 开始处理
    PROCESSING --> COMPLETED: 处理成功
    PROCESSING --> FAILED: 处理失败
    PROCESSING --> CANCELLED: 用户取消
    COMPLETED --> [*]: 清理资源
    FAILED --> RETRY: 自动重试
    RETRY --> RUNNING: 重试执行
    RETRY --> ABORTED: 超过重试次数
    CANCELLED --> [*]: 清理资源
    ABORTED --> [*]: 记录失败
```

### 状态转换规则
- **IDLE → PENDING**: 用户确认任务参数
- **PENDING → RUNNING**: 调度器分配资源
- **RUNNING → PROCESSING**: AI决策完成，开始实际处理
- **PROCESSING → COMPLETED**: 处理成功，生成输出文件
- **PROCESSING → FAILED**: 处理过程中出现错误
- **FAILED → RETRY**: 自动重试（最多3次）
- **RETRY → ABORTED**: 重试失败，任务终止

## 🔄 模块间交互协议

### 前端 ↔ 后端通信
```json
// 请求格式
{
    "taskType": "image_to_camera",
    "sourcePath": "/path/to/source.jpg",
    "parameters": {
        "quality": "high",
        "fps": 25
    },
    "priority": "normal"
}

// 响应格式
{
    "success": true,
    "data": {},
    "message": "操作成功",
    "timestamp": "2024-01-01T00:00:00Z",
    "requestId": "req-123456"
}
```

### 实时进度推送 (WebSocket)
```json
// 进度更新
{
    "type": "progress",
    "taskId": "task_123456",
    "progress": 45,
    "message": "正在处理第3帧...",
    "eta": 15
}

// 状态变更
{
    "type": "status",
    "taskId": "task_123456",
    "status": "processing",
    "timestamp": 1640995200
}

// 完成通知
{
    "type": "completed",
    "taskId": "task_123456",
    "resultPath": "/output/result.mp4",
    "processingTime": 28.5
}
```

### AI决策协议
```json
// AI分析请求
{
    "command": "把我的照片换到这个视频里",
    "context": {
        "sourceType": "image",
        "targetType": "video",
        "files": {
            "source": "/path/to/photo.jpg",
            "target": "/path/to/video.mp4"
        }
    }
}

// AI决策响应
{
    "intent": "face_swap_video",
    "parameters": {
        "taskType": "image_to_video",
        "engine": "facefusion",
        "quality": "high",
        "blendMode": "poisson"
    },
    "estimatedTime": 120
}
```

## ⚡ 性能优化策略

### 并发处理机制
```mermaid
graph TD
    A[任务队列] --> B{资源检查}
    B -->|资源充足| C[立即执行]
    B -->|资源紧张| D[加入等待队列]
    C --> E[分配处理线程]
    D --> F[优先级排序]
    F --> G[等待资源释放]
    G --> E
    E --> H[执行处理任务]
    H --> I[监控资源使用]
    I --> J{超时检查}
    J -->|正常| K[完成处理]
    J -->|超时| L[强制终止]
    K --> M[释放资源]
    L --> M
```

### 内存管理策略
- **预分配策略**: 启动时预分配GPU内存
- **动态调整**: 根据任务复杂度调整内存使用
- **垃圾回收**: 处理完成后立即释放资源
- **缓存机制**: 复用已加载的模型和数据

### GPU资源调度
```mermaid
flowchart TD
    A[新任务请求] --> B{检查GPU状态}
    B -->|空闲| C[直接分配]
    B -->|忙碌| D[计算等待时间]
    D --> E{等待时间 < 阈值?}
    E -->|是| F[加入GPU队列]
    E -->|否| G[回退到CPU处理]
    C --> H[设置GPU上下文]
    F --> I[等待GPU释放]
    I --> H
    G --> J[CPU处理模式]
    H --> K[执行GPU任务]
    J --> L[执行CPU任务]
    K --> M[任务完成]
    L --> M
    M --> N[释放GPU资源]
```

## 🛡️ 错误处理和恢复

### 分层错误处理
```mermaid
flowchart TD
    A[用户操作] --> B{前端验证}
    B -->|失败| C[前端错误提示]
    B -->|成功| D[发送到后端]
    D --> E{后端验证}
    E -->|失败| F[返回API错误]
    E -->|成功| G[创建任务]
    G --> H{AI决策}
    H -->|失败| I[任务失败，回退]
    H -->|成功| J[开始处理]
    J --> K{处理执行}
    K -->|失败| L[记录错误，重试]
    K -->|成功| M[完成任务]
    L --> N{重试次数}
    N -->|超过限制| O[任务失败]
    N -->|可重试| P[重新调度]
```

### 自动恢复机制
- **网络重连**: Ollama服务断开自动重连
- **GPU恢复**: GPU内存不足时自动清理并重试
- **文件恢复**: 处理中断时从断点继续
- **状态同步**: 多进程间状态自动同步

## 📈 监控和日志

### 性能指标收集
- **处理时间**: 各阶段耗时统计
- **资源使用**: CPU/GPU/内存使用率
- **成功率**: 任务成功/失败比例
- **用户体验**: 响应时间和等待时间

### 日志分层
- **DEBUG**: 详细的调试信息
- **INFO**: 重要的状态变更
- **WARNING**: 潜在问题警告
- **ERROR**: 错误和异常信息
- **CRITICAL**: 严重错误，需要立即处理

---

*本文档由自动化系统维护，最后更新: 2026-01-16*
