# 系统运行时逻辑流程

> 本文档描述夜灵AR多功能合成软件的运行时逻辑流程和状态管理。

## 🔄 整体运行流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           启动阶段                                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                  │
│  │ 加载配置     │─▶│ 初始化日志   │─▶│ 检查依赖     │                  │
│  └──────────────┘  └──────────────┘  └──────────────┘                  │
│         │                 │                 │                            │
│         ▼                 ▼                 ▼                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                  │
│  │ 准备工作目录 │─▶│ 验证资源     │─▶│ 启动服务     │                  │
│  └──────────────┘  └──────────────┘  └──────────────┘                  │
│                                                  │                       │
└──────────────────────────────────────────────────┼───────────────────────┘
                                                   ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           就绪状态                                       │
│            等待用户选择操作（空闲状态）                                   │
└─────────────────────────────────────────────────────────────────────────┘
```

## 📋 用户操作流程

### 1. 图片合成到图片

```
用户选择源图片
     │
     ▼
系统检测并提取源图片人脸特征
     │
     ▼
用户选择目标图片
     │
     ▼
系统检测目标图片所有人脸区域
     │
     ▼
用户选择要替换的人脸区域
     │
     ▼
系统执行人脸替换
     │
     ▼
用户确认/调整结果
     │
     ▼
保存输出文件
```

### 2. 图片合成到视频

```
用户选择源图片
     │
     ▼
系统提取源图片人脸特征
     │
     ▼
用户选择目标视频
     │
     ▼
系统分析视频（帧数、时长、场景）
     │
     ▼
逐帧处理视频
  ┌──▶ 检测人脸
  │     │
  │     ▼
  │  提取人脸特征
  │     │
  │     ▼
  │  人脸替换
  │     │
  └───┘
     │
     ▼
合成输出视频
     │
     ▼
保存结果
```

### 3. 实时摄像头换脸

```
用户选择源图片
     │
     ▼
系统提取源图片人脸特征
     │
     ▼
用户启动实时摄像头
     │
     ▼
初始化摄像头和虚拟摄像头输出
     │
     ▼
开始实时处理循环（25 FPS）
  ┌──▶ 获取摄像头帧
  │     │
  │     ▼
  │  检测人脸
  │     │
  │     ▼
  │  人脸替换
  │     │
  │     ▼
  │  输出到虚拟摄像头
  │     │
  └───┘
     │
     ▼
用户停止处理
     │
     ▼
清理资源
```

### 4. AI 命令理解

```
用户输入自然语言命令
     │
     ▼
系统调用 Ollama 解析命令意图
     │
     ▼
提取操作类型和参数
     │
     ▼
生成执行计划
     │
     ▼
用户确认/调整计划
     │
     ▼
执行处理任务
```

## 🔢 状态机管理

### 系统状态定义

```
┌─────────────────────────────────────────────────────────────────┐
│                           状态定义                              │
├─────────────────────────────────────────────────────────────────┤
│  IDLE           │ 空闲状态，等待用户操作                        │
├─────────────────┼───────────────────────────────────────────────┤
│  SOURCE_SELECTED│ 已选择源文件，等待目标选择                    │
├─────────────────┼───────────────────────────────────────────────┤
│  SELECTING_TARGET│ 选择目标中                                  │
├─────────────────┼───────────────────────────────────────────────┤
│  READY          │ 就绪状态，可以开始处理                        │
├─────────────────┼───────────────────────────────────────────────┤
│  PROCESSING     │ 处理中                                       │
├─────────────────┼───────────────────────────────────────────────┤
│  PAUSED         │ 暂停状态                                     │
├─────────────────┼───────────────────────────────────────────────┤
│  COMPLETED      │ 完成状态                                     │
├─────────────────┼───────────────────────────────────────────────┤
│  FAILED         │ 错误状态                                     │
├─────────────────┼───────────────────────────────────────────────┤
│  CANCELLED      │ 取消状态                                     │
└─────────────────────────────────────────────────────────────────┘
```

### 状态转换图

```
                         ┌──────────┐
                         │  IDLE    │
                         └────┬─────┘
                              │
                     用户选择源文件
                              │
                              ▼
                  ┌───────────────────────┐
                  │  SOURCE_SELECTED      │
                  └───────────┬───────────┘
                              │
              ┌───────────────┼───────────────┐
              │               │               │
    用户选择目标        用户直接开始      用户取消
              │               │               │
              ▼               ▼               │
    ┌─────────────────┐      ▼               │
    │SELECTING_TARGET │  ┌──────────┐        │
    └────────┬────────┘  │  READY   │◀───────┘
             │           └────┬─────┘
             │                │
             │         用户开始处理
             │                │
             │                ▼
             │        ┌──────────────┐
             │        │  PROCESSING  │
             │        └──────┬───────┘
             │               │
             │    ┌─────────┼─────────┐
             │    │         │         │
             │  暂停      完成      错误
             │    │         │         │
             │    ▼         ▼         ▼
             │  ┌─────┐  ┌────────┐ ┌─────┐
             │  │PAUSED│ │COMPLETED│ │FAILED│
             │  └──┬──┘  └────┬───┘ └──┬──┘
             │     │         │        │
             │  继续     返回IDLE   返回IDLE
             │     │         │        │
             └─────┴─────────┴────────┘
```

### 状态说明

| 状态 | 进入条件 | 允许操作 | 退出条件 |
|------|----------|----------|----------|
| IDLE | 系统启动 / 任务完成 / 取消 | 选择源文件 | 选择源文件 |
| SOURCE_SELECTED | 用户选择源文件 | 选择目标 / 直接处理 / 取消 | 选择目标 / 开始处理 / 取消 |
| SELECTING_TARGET | 用户选择目标 | 确认选择 / 取消 | 确认 / 取消 |
| READY | 所有输入就绪 | 开始处理 / 取消 | 开始处理 / 取消 |
| PROCESSING | 开始处理任务 | 暂停 / 取消 | 暂停 / 完成 / 错误 |
| PAUSED | 暂停处理 | 继续 / 取消 | 继续 / 取消 |
| COMPLETED | 处理成功 | 导出 / 新任务 | 导出 / 新任务 |
| FAILED | 处理出错 | 重试 / 取消 | 重试 / 取消 |
| CANCELLED | 用户取消 | 新任务 | 返回IDLE |

## 🔄 任务生命周期

### 任务执行流程

```
┌─────────────────────────────────────────────────────────────────┐
│                        任务生命周期                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 任务创建                                                    │
│     - 验证输入参数                                              │
│     - 创建任务ID                                                │
│     - 初始化任务状态                                            │
│                                                                 │
│  2. 任务排队                                                    │
│     - 检查资源可用性                                            │
│     - 加入任务队列                                              │
│     - 返回任务ID                                                │
│                                                                 │
│  3. 任务执行                                                    │
│     - 加载处理模型                                              │
│     - 执行处理逻辑                                              │
│     - 定期更新进度                                              │
│                                                                 │
│  4. 任务完成                                                    │
│     - 保存输出文件                                              │
│     - 更新任务状态                                              │
│     - 清理临时资源                                              │
│                                                                 │
│  5. 任务清理                                                    │
│     - 释放内存                                                  │
│     - 删除临时文件                                              │
│     - 记录完成日志                                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 错误处理流程

```
任务执行中发生错误
        │
        ▼
┌───────────────┐
│  错误分类     │
└───────┬───────┘
        │
        ▼
┌─────────────────────────────────────┐
│  可恢复错误                         │
│  - GPU内存不足 → CPU回退            │
│  - 模型加载失败 → 重试/备用模型      │
│  - 网络超时 → 重试                  │
└─────────────────┬───────────────────┘
                  │
                  ▼
┌─────────────────────────────────────┐
│  不可恢复错误                       │
│  - 文件格式不支持                   │
│  - 输入数据无效                     │
│  - 权限不足                         │
└─────────────────┬───────────────────┘
                  │
                  ▼
        ┌─────────────────┐
        │  用户通知       │
        │  错误详情展示   │
        │  重试选项       │
        └─────────────────┘
```

## 📡 前后端通信

### HTTP API 通信

```
请求流程:
┌─────────┐    GET/POST     ┌─────────┐    内部调用    ┌─────────┐
│  前端   │ ──────────────▶ │  后端   │ ────────────▶ │  处理   │
│  (GUI)  │                 │ (FastAPI)│               │  模块   │
└─────────┘                 └─────────┘               └─────────┘
                                  │
                                  ▼
                            ┌─────────┐
                            │  返回   │
                            │  响应   │
                            └─────────┘
```

### WebSocket 实时通信

```
实时推送流程:
┌─────────┐    连接      ┌─────────┐              ┌─────────┐
│  前端   │ ───────────▶ │  WS服务 │ ── 进度 ───▶ │  前端   │
│  (GUI)  │              │ (Socket)│ ── 状态 ───▶ │  (GUI)  │
└─────────┘              └─────────┘ ── 日志 ───▶ └─────────┘
                                │
                                ▼
                          ┌─────────┐
                          │  任务   │
                          │  监控   │
                          └─────────┘
```

### 事件类型

| 事件类型 | 触发时机 | 数据内容 |
|----------|----------|----------|
| task_start | 任务开始 | 任务ID、类型、参数 |
| task_progress | 进度更新 | 任务ID、进度百分比 |
| task_complete | 任务完成 | 任务ID、结果路径 |
| task_error | 任务错误 | 任务ID、错误信息 |
| task_cancel | 任务取消 | 任务ID、原因 |
| status_change | 状态变更 | 新状态、原因 |
| resource_update | 资源更新 | CPU、内存、GPU使用率 |

## 🔧 服务启动流程

### 1. Web监控中心启动

```bash
python web/start_monitor.py
    │
    ▼
加载配置 (web_config.json)
    │
    ▼
初始化 FastAPI 应用
    │
    ▼
注册路由 (api/backend/routes.py)
    │
    ▼
启动 WebSocket 服务
    │
    ▼
启动健康监控定时器
    │
    ▼
启动 HTTP 服务 (0.0.0.0:8080)
```

### 2. 后端API服务启动

```bash
python src/backend/api_server.py
    │
    ▼
加载配置 (project_config.json)
    │
    ▼
初始化日志系统
    │
    ▼
加载规则文件 (rules/L*.json)
    │
    ▼
初始化各模块
    │
    ▼
启动 FastAPI 服务
```

### 3. GUI桌面应用启动

```bash
python src/frontend/main_window.py
    │
    ▼
加载配置
    │
    ▼
初始化 UI 组件
    │
    ▼
连接后端 API
    │
    ▼
显示主窗口
```

## 📊 资源监控

### 系统资源监控

```
监控指标:
- CPU 使用率
- 内存使用率
- GPU 使用率（如果可用）
- 磁盘空间
- 网络状态

监控频率:
- 普通指标: 5秒
- GPU指标: 10秒
- 磁盘检查: 60秒
```

### 任务资源监控

```
任务级监控:
- 任务执行时间
- 内存使用峰值
- GPU内存使用
- 处理速度 (FPS)

告警阈值:
- CPU > 80% 持续 60秒
- 内存 > 85%
- GPU内存 > 90%
- 任务超时 > 5分钟
```

## 🔄 定时任务

### 自动化任务

| 任务 | 频率 | 执行内容 |
|------|------|----------|
| 健康检查 | 每天 02:00 | 检查所有模块状态 |
| 配置验证 | 每天 03:00 | 验证配置一致性 |
| 日志清理 | 每周 | 清理过期日志 |
| 临时文件清理 | 每小时 | 清理临时文件 |
| 资源检查 | 持续 | 监控资源使用 |

## 📝 文档版本

| 版本 | 日期 | 修改内容 |
|------|------|----------|
| 1.0 | 2026-01-19 | 初始版本 |

## 🔗 相关文档

- [项目整体架构设计](01-project-architecture.md)
- [依赖和配置说明](03-dependencies-config.md)
- [API接口文档](04-frontend-backend-api.md)
- [自动化脚本说明](05-automation-scripts.md)
