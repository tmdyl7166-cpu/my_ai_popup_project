# 统一接口

> AISP REST API 接口文档
> 
> 文档版本: 1.0.0
> 最后更新: 2025-01-21

---

## API概览

### 基础信息

| 项目 | 说明 |
|------|------|
| 基础URL | `http://localhost:8000` |
| API文档 | `http://localhost:8000/docs` |
| 健康检查 | `http://localhost:8000/health` |

### 认证

所有API端点需要通过JWT Token认证：

```http
Authorization: Bearer <token>
```

---

## 认证接口

### 用户登录

```http
POST /api/auth/login
Content-Type: application/json

{
    "username": "admin",
    "password": "password"
}
```

**响应**:
```json
{
    "token": "eyJhbGciOiJIUzI1NiIs...",
    "expires_in": 3600
}
```

### 用户登出

```http
POST /api/auth/logout
Authorization: Bearer <token>
```

### 获取当前用户

```http
GET /api/auth/me
Authorization: Bearer <token>
```

**响应**:
```json
{
    "id": "admin",
    "username": "admin",
    "role": "admin"
}
```

---

## 状态接口

### 获取系统状态

```http
GET /api/status
Authorization: Bearer <token>
```

**响应**:
```json
{
    "status": "running",
    "modules": {
        "backend": "running",
        "ai_control": "running",
        "ar_engine": "stopped"
    },
    "resources": {
        "cpu_percent": 45.2,
        "memory_percent": 62.1,
        "gpu_percent": 78.5
    }
}
```

### 获取性能统计

```http
GET /api/status/performance
Authorization: Bearer <token>
```

---

## 任务接口

### 列出所有任务

```http
GET /api/tasks
Authorization: Bearer <token>
```

**响应**:
```json
{
    "tasks": [
        {
            "id": "task_001",
            "type": "video_process",
            "status": "running",
            "progress": 45
        }
    ],
    "total": 10,
    "page": 1,
    "page_size": 20
}
```

### 创建任务

```http
POST /api/tasks
Authorization: Bearer <token>
Content-Type: application/json

{
    "type": "video_process",
    "input_path": "/path/to/input.mp4",
    "output_path": "/path/to/output.mp4",
    "options": {
        "engine": "deep_live_cam",
        "quality": "high"
    }
}
```

**响应**:
```json
{
    "id": "task_002",
    "status": "pending",
    "message": "任务已创建"
}
```

### 获取任务详情

```http
GET /api/tasks/{task_id}
Authorization: Bearer <token>
```

### 执行任务

```http
POST /api/tasks/{task_id}/execute
Authorization: Bearer <token>
```

### 获取任务统计

```http
GET /api/tasks/stats
Authorization: Bearer <token>
```

---

## 帧处理接口

### 处理单帧图像

```http
POST /api/frame/process
Authorization: Bearer <token>
Content-Type: application/json

{
    "image_base64": "<base64编码图片>",
    "options": {
        "detect_only": false,
        "engine": "deep_live_cam"
    }
}
```

**响应**:
```json
{
    "processed_image_base64": "<base64编码结果图片>",
    "faces_detected": 2,
    "processing_time_ms": 45
}
```

---

## 人脸接口

### 检测人脸

```http
POST /api/faces/detect
Authorization: Bearer <token>
Content-Type: application/json

{
    "image_base64": "<base64编码图片>"
}
```

**响应**:
```json
{
    "faces": [
        {
            "bbox": [x, y, width, height],
            "confidence": 0.95,
            "landmarks": [...]
        }
    ],
    "processing_time_ms": 23
}
```

### 列出已知人脸

```http
GET /api/faces/known
Authorization: Bearer <token>
```

### 添加已知人脸

```http
POST /api/faces/known
Authorization: Bearer <token>
Content-Type: application/json

{
    "name": "person_name",
    "image_base64": "<base64编码图片>"
}
```

---

## AI策略接口

### 生成AI策略

```http
POST /api/strategy/generate
Authorization: Bearer <token>
Content-Type: application/json

{
    "active_modules": ["face_swap"],
    "user_instruction": "优化换脸效果",
    "auto_optimize": true
}
```

**响应**:
```json
{
    "strategy_id": "strat_001",
    "strategy": {
        "recommendations": [...],
        "config_updates": {...}
    },
    "estimated_improvement": "15%"
}
```

---

## 摄像头接口

### 获取摄像头状态

```http
GET /api/camera/status
Authorization: Bearer <token>
```

**响应**:
```json
{
    "available": true,
    "active": false,
    "devices": [
        {
            "id": "/dev/video0",
            "name": "USB Camera",
            "resolution": "1920x1080"
        }
    ]
}
```

### 启动摄像头

```http
POST /api/camera/start
Authorization: Bearer <token>
Content-Type: application/json

{
    "device_id": "/dev/video0",
    "resolution": "1920x1080"
}
```

### 停止摄像头

```http
POST /api/camera/stop
Authorization: Bearer <token>
```

### 获取摄像头列表

```http
GET /api/camera/list
Authorization: Bearer <token>
```

---

## 视频接口

### 获取视频状态

```http
GET /api/video/status
Authorization: Bearer <token>
```

### 视频合成

```http
POST /api/video/compose
Authorization: Bearer <token>
Content-Type: application/json

{
    "input_path": "/path/to/input.mp4",
    "output_path": "/path/to/output.mp4",
    "options": {
        "engine": "deep_live_cam",
        "source_face": "<base64编码源图片>"
    }
}
```

### 提取帧

```http
POST /api/video/extract_frame
Authorization: Bearer <token>
Content-Type: application/json

{
    "video_path": "/path/to/video.mp4",
    "frame_number": 100,
    "output_path": "/path/to/frame.jpg"
}
```

---

## AR引擎接口

### 获取AR引擎列表

```http
GET /api/ar/engines
Authorization: Bearer <token>
```

**响应**:
```json
{
    "engines": [
        {
            "id": "deep_live_cam",
            "name": "Deep Live Cam",
            "status": "available",
            "capabilities": ["realtime", "video", "image"]
        },
        {
            "id": "facefusion",
            "name": "FaceFusion",
            "status": "available",
            "capabilities": ["video", "image"]
        }
    ]
}
```

### 启动AR引擎

```http
POST /api/ar/start
Authorization: Bearer <token>
Content-Type: application/json

{
    "engine_id": "deep_live_cam",
    "config": {
        "quality": "high",
        "realtime": true
    }
}
```

### 停止AR引擎

```http
POST /api/ar/stop
Authorization: Bearer <token>
Content-Type: application/json

{
    "engine_id": "deep_live_cam"
}
```

---

## 直播接口

### 获取直播状态

```http
GET /api/live/status
Authorization: Bearer <token>
```

### 获取直播配置

```http
GET /api/live/config
Authorization: Bearer <token>
```

### 设置直播配置

```http
POST /api/live/config
Authorization: Bearer <token>
Content-Type: application/json

{
    "target_platform": "obs",
    "output_resolution": "1920x1080",
    "bitrate": 6000
}
```

### 开始直播

```http
POST /api/live/start
Authorization: Bearer <token>
```

### 停止直播

```http
POST /api/live/stop
Authorization: Bearer <token>
```

---

## 识别接口

### 获取识别状态

```http
GET /api/recognition/status
Authorization: Bearer <token>
```

### 检测人脸

```http
POST /api/recognition/detect
Authorization: Bearer <token>
Content-Type: application/json

{
    "image_base64": "<base64编码图片>",
    "options": {
        "max_faces": 10,
        "min_confidence": 0.5
    }
}
```

### 图片合成

```http
POST /api/recognition/compose
Authorization: Bearer <token>
Content-Type: application/json

{
    "source_image_base64": "<base64编码源图片>",
    "target_image_base64": "<base64编码目标图片>",
    "options": {
        "blend_ratio": 0.5,
        "method": "seamless"
    }
}
```

---

## 数据库接口

### 获取数据库日志

```http
GET /api/db/performance
Authorization: Bearer <token>
```

---

## Web监控接口

### 获取监控状态

```http
GET /web/api/status
```

### 获取实时状态

```http
GET /web/api/realtime-status
```

### 获取历史数据

```http
GET /web/api/history
```

### 获取完整状态

```http
GET /web/api/full-status
```

### 运行检查

```http
POST /web/api/run_check
Content-Type: application/json

{
    "check_type": "full"
}
```

### 获取依赖状态

```http
GET /web/api/dependencies
```

### 获取系统资源

```http
GET /web/api/system
```

### 获取进程状态

```http
GET /web/api/processes
```

### 获取业务模块状态

```http
GET /web/api/business
```

### 获取输出模块状态

```http
GET /web/api/output
```

### 获取引擎详情

```http
GET /web/api/engines
```

### 获取摘要

```http
GET /web/api/summary
```

### 获取项目层级

```http
GET /web/api/layers
```

### 获取项目结构

```http
GET /web/api/structure
```

---

## 错误响应

### 错误格式

```json
{
    "error": {
        "code": "ERROR_CODE",
        "message": "错误描述",
        "details": {}
    }
}
```

### 错误代码

| 代码 | 说明 |
|------|------|
| VALIDATION_ERROR | 输入验证失败 |
| AUTHENTICATION_ERROR | 认证失败 |
| AUTHORIZATION_ERROR | 权限不足 |
| NOT_FOUND | 资源不存在 |
| CONFLICT | 资源冲突 |
| RATE_LIMIT | 请求频率限制 |
| INTERNAL_ERROR | 内部错误 |
| SERVICE_UNAVAILABLE | 服务不可用 |

---

## 相关文档

- [整体项目逻辑](./整体项目逻辑.md)
- [模块依赖关系](./模块依赖关系.md)
- [后端模块说明](../reference/BACKEND_MODULES.md)

---

*文档版本: 1.0.0*
*最后更新: 2025-01-21*

