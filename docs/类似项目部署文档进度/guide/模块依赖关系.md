# 模块依赖关系

> AISP 项目模块间依赖关系说明
> 
> 文档版本: 1.0.0
> 最后更新: 2025-01-21

---

## 一、依赖概览

### 1.1 依赖层级

```
用户层 (GUI/Web)
    │
    ▼
API层 (backend/api.py, unified_api.py)
    │
    ▼
服务层 (backend/services/*)
    │
    ├──▶ AI控制层 (backend/ai_control/*)
    │
    ▼
AR引擎层 (backend/ar_engine/*)
    │
    ▼
引擎底层 (engines/*)
    │
    ▼
输出层 (virtual_cam/, obs_integration/)
```

### 1.2 依赖原则

1. **单向依赖**: 上层依赖下层，下层不依赖上层
2. **接口隔离**: 通过接口/抽象类通信
3. **禁止循环**: 模块间禁止循环依赖

---

## 二、详细依赖

### 2.1 GUI层依赖

| 模块 | 依赖 | 说明 |
|------|------|------|
| `gui/main_window.py` | `gui/api_config.py` | API配置 |
| `gui/main_window.py` | `gui/services/api_service.py` | API服务 |
| `gui/hot_window_manager.py` | `gui/main_window.py` | 主窗口 |
| `gui/api_config.py` | 无 | 独立配置 |
| `gui/dialogs/ar_config_dialog.py` | `gui/api_config.py` | API配置 |
| `gui/services/api_service.py` | `gui/api_config.py` | API配置 |
| `gui/widgets/ar_engine.py` | `gui/services/api_service.py` | API服务 |
| `gui/widgets/live_streaming.py` | `gui/services/api_service.py` | API服务 |
| `gui/widgets/service_status_widget.py` | `gui/services/api_service.py` | API服务 |
| `gui/widgets/system_tray.py` | `gui/main_window.py` | 主窗口 |
| `gui/widgets/web_embed_widget.py` | `gui/services/api_service.py` | API服务 |

### 2.2 API层依赖

| 模块 | 依赖 | 说明 |
|------|------|------|
| `backend/api.py` | `backend/models.py` | 数据模型 |
| `backend/api.py` | `backend/services/*` | 业务服务 |
| `backend/api.py` | `backend/control_core/*` | 控制核心 |
| `backend/unified_api.py` | `backend/models.py` | 数据模型 |
| `backend/unified_api.py` | `backend/services/*` | 业务服务 |
| `backend/unified_api.py` | `backend/control_core/*` | 控制核心 |
| `backend/unified_api.py` | `backend/path_utils.py` | 路径工具 |

### 2.3 服务层依赖

| 模块 | 依赖 | 说明 |
|------|------|------|
| `services/video_pipeline.py` | `services/face_detection.py` | 人脸检测 |
| `services/video_pipeline.py` | `services/face_recognition.py` | 人脸识别 |
| `services/video_pipeline.py` | `services/face_swap.py` | 人脸替换 |
| `services/task_scheduler.py` | `services/task_executor.py` | 任务执行 |
| `services/performance_monitor.py` | 无 | 独立监控 |
| `services/local_ai_interface.py` | `ai_control/ollama_client.py` | Ollama客户端 |
| `services/local_ai_interface.py` | `ai_control/auto_strategy.py` | 自动策略 |

### 2.4 AI控制层依赖

| 模块 | 依赖 | 说明 |
|------|------|------|
| `ai_control/auto_strategy.py` | `ai_control/ollama_client.py` | Ollama客户端 |
| `ai_control/auto_strategy.py` | `ai_control/memory_db.py` | 内存数据库 |
| `ai_control/ollama_client.py` | 无 | 独立客户端 |
| `ai_control/memory_db.py` | 无 | 独立存储 |

### 2.5 AR引擎层依赖

| 模块 | 依赖 | 说明 |
|------|------|------|
| `ar_engine/frame_pipeline.py` | `ar_engine/adapters/*` | 引擎适配器 |
| `ar_engine/adapters/deep_live_cam.py` | `engines/engine_base.py` | 引擎基类 |
| `ar_engine/adapters/facefusion.py` | `engines/engine_base.py` | 引擎基类 |
| `ar_engine/adapters/iroop.py` | `engines/engine_base.py` | 引擎基类 |
| `ar_engine/tracker/face_tracker.py` | `ar_engine/frame_pipeline.py` | 帧处理 |

### 2.6 引擎底层依赖

| 模块 | 依赖 | 说明 |
|------|------|------|
| `engines/engine_base.py` | 无 | 独立基类 |

### 2.7 控制核心依赖

| 模块 | 依赖 | 说明 |
|------|------|------|
| `control_core/server.py` | `control_core/state_manager.py` | 状态管理 |
| `control_core/server.py` | `control_core/auth.py` | 认证 |
| `control_core/pipeline_manager.py` | `control_core/state_manager.py` | 状态管理 |
| `control_core/resource_guard.py` | `control_core/state_manager.py` | 状态管理 |

---

## 三、依赖规则

### 3.1 允许的依赖

```
gui/ → backend/api.py
gui/ → backend/unified_api.py
backend/api.py → backend/services/*
backend/api.py → backend/control_core/*
backend/unified_api.py → backend/services/*
backend/unified_api.py → backend/control_core/*
backend/services/* → backend/ai_control/*
backend/services/* → backend/ar_engine/*
backend/ai_control/* → backend/services/* (部分)
backend/ar_engine/* → engines/*
```

### 3.2 禁止的依赖

```
gui/* → backend/services/* (禁止直接调用)
gui/* → backend/ar_engine/* (禁止直接调用)
gui/* → engines/* (禁止直接调用)
backend/services/* → gui/* (禁止逆向调用)
backend/ar_engine/* → backend/control_core/* (禁止)
engines/* → backend/* (禁止)
engines/* → gui/* (禁止)
```

### 3.3 层级隔离规则

| 源层 | 目标层 | 允许 | 说明 |
|------|--------|------|------|
| GUI | 后端服务 | ❌ | 必须通过API |
| 后端服务 | AI控制 | ✅ | 正常调用 |
| AI控制 | 后端服务 | ⚠️ | 仅限策略相关 |
| AR引擎 | 控制核心 | ❌ | 必须通过服务层 |
| 引擎 | 后端/GUI | ❌ | 禁止任何调用 |

---

## 四、数据流

### 4.1 正常数据流

```
1. GUI 接收用户输入
   ↓
2. GUI 调用 API 服务
   ↓
3. API 层路由请求
   ↓
4. 服务层处理业务逻辑
   ↓
5. 服务层调用 AR 引擎
   ↓
6. AR 引擎调用底层引擎
   ↓
7. 引擎处理并返回结果
   ↓
8. 结果逐层返回
   ↓
9. GUI 显示结果
```

### 4.2 禁止的数据流

```
GUI → services/* (❌ 禁止)
GUI → ar_engine/* (❌ 禁止)
GUI → engines/* (❌ 禁止)
services → gui/* (❌ 禁止)
ar_engine → control_core/* (❌ 禁止)
engines → backend/* (❌ 禁止)
```

---

## 五、接口定义

### 5.1 服务层接口

```python
# 视频处理服务
class VideoPipelineService:
    async def process_frame(self, frame: np.ndarray) -> np.ndarray:
        """处理单帧图像"""
        pass
    
    async def process_video(self, input_path: str, output_path: str):
        """处理视频文件"""
        pass

# 人脸服务
class FaceService:
    async def detect(self, image: np.ndarray) -> List[Face]:
        """检测人脸"""
        pass
    
    async def recognize(self, face: Face) -> Identity:
        """识别人脸"""
        pass
    
    async def swap(self, source: Face, target: Face) -> np.ndarray:
        """换脸"""
        pass

# 任务服务
class TaskService:
    async def submit(self, task: Task) -> str:
        """提交任务"""
        pass
    
    async def get_status(self, task_id: str) -> TaskStatus:
        """获取任务状态"""
        pass
```

### 5.2 引擎接口

```python
# 引擎基类
class EngineBase:
    async def process(self, frame: np.ndarray) -> np.ndarray:
        """处理帧"""
        pass
    
    async def initialize(self, config: dict):
        """初始化引擎"""
        pass
    
    async def cleanup(self):
        """清理资源"""
        pass
    
    def get_status(self) -> EngineStatus:
        """获取引擎状态"""
        pass
```

---

## 六、依赖检查

### 6.1 检查脚本

```bash
# 检查循环依赖
python scripts/check_dependencies.py --check-cycles

# 检查禁止的依赖
python scripts/check_dependencies.py --check-forbidden

# 生成依赖图
python scripts/check_dependencies.py --generate-graph
```

### 6.2 验证清单

- [ ] 无循环依赖
- [ ] 无禁止的依赖
- [ ] 接口定义完整
- [ ] 依赖方向正确

---

## 相关文档

- [项目结构说明](./项目结构说明.md)
- [整体项目逻辑](./整体项目逻辑.md)
- [统一接口](./统一接口.md)
- [五层逻辑部署说明](./五层逻辑部署说明.md)

---

*文档版本: 1.0.0*
*最后更新: 2025-01-21*

