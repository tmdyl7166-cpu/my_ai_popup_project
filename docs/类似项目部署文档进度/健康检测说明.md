# AISP 健康检测功能说明

> AISP项目自动化健康检测脚本，支持依赖层、系统层、进程层、业务层检查

## 目录

- [文件结构](#文件结构)
- [依赖要求](#依赖要求)
- [安装方法](#安装方法)
- [使用方法](#使用方法)
- [配置说明](#配置说明)
- [检测内容](#检测内容)

## 文件结构

```
AISP/
├── scripts/
│   └── health_check.py          # 健康检测脚本
└── config/
    └── health_check_config.json # 健康检测配置
```

## 依赖要求

### Python版本

```
Python >= 3.10 (推荐 3.12)
```

### 核心依赖 (requirements.txt)

| 包名 | 最小版本 | 用途 |
|------|---------|------|
| fastapi | >=0.109.0 | 后端API框架 |
| uvicorn | >=0.27.0 | ASGI服务器 |
| opencv-python | >=4.8.0 | 图像处理 |
| numpy | >=1.24.0 | 数值计算 |
| psutil | >=5.9.0 | 系统监控 |
| GPUtil | >=1.4.0 | GPU监控 |
| loguru | >=0.7.0 | 日志记录 |
| watchdog | >=3.0.0 | 文件监控 |
| mediapipe | >=0.10.0 | 人脸检测 |
| onnxruntime | >=1.15.0 | AI推理加速 |

### 健康检测专用依赖

| 包名 | 版本 | 用途 | 必需 |
|------|------|------|------|
| flask | >=2.3.0 | Web界面 | 否* |
| requests | >=2.31.0 | HTTP请求 | 否* |

*注: Flask和requests用于Web界面和API测试，脚本支持优雅降级

## 安装方法

```bash
cd /home/vboxuser/桌面/BX/AI规则/AISP

# 核心依赖
pip3 install -r requirements.txt

# 健康检测额外依赖 (可选)
pip3 install flask requests
```

## 使用方法

### 1. 命令行模式

```bash
cd /home/vboxuser/桌面/BX/AI规则/AISP
python3 scripts/health_check.py
```

### 2. Web界面模式

```bash
cd /home/vboxuser/桌面/BX/AI规则/AISP
python3 scripts/health_check.py --web --port 8080
```

访问: http://localhost:8080

### 3. 命令行参数

| 参数 | 说明 | 默认值 |
|------|------|-------|
| --web | 启动Web界面 | False |
| --port | Web服务端口 | 8080 |
| --help | 显示帮助 | - |

## 配置说明

### 配置文件位置

```
AISP/config/health_check_config.json
```

### 完整配置示例

```json
{
  "meta": {
    "name": "AISP Health Check Configuration",
    "version": "1.0.0"
  },
  "check_interval": 5,
  "dependency_check": {
    "enabled": true,
    "required_packages": [
      "fastapi", "uvicorn", "opencv-python", "numpy",
      "psutil", "GPUtil", "requests", "PyQt6",
      "loguru", "watchdog", "mediapipe"
    ],
    "optional_packages": ["pyvirtualcam", "obswebsocket", "torch"]
  },
  "system_check": {
    "enabled": true,
    "thresholds": {
      "cpu_percent_warning": 70,
      "cpu_percent_critical": 90,
      "memory_percent_warning": 75,
      "memory_percent_critical": 90,
      "disk_percent_warning": 80,
      "disk_percent_critical": 95,
      "gpu_percent_warning": 80,
      "gpu_percent_critical": 95
    },
    "check_items": ["cpu_usage", "memory_usage", "disk_usage", "gpu_usage"]
  },
  "process_check": {
    "enabled": true,
    "required_processes": [
      {"name": "AISP Backend API", "port": 8000, "description": "后端API服务"},
      {"name": "Ollama Service", "port": 11434, "description": "本地AI服务"}
    ],
    "optional_processes": [
      {"name": "OBS Studio", "port": 4455, "description": "OBS WebSocket"}
    ]
  },
  "business_check": {
    "enabled": true,
    "api_endpoints": [
      {"name": "健康检查", "url": "http://localhost:8000/health", "timeout": 5},
      {"name": "系统状态", "url": "http://localhost:8000/api/status", "timeout": 5}
    ],
    "modules_to_check": [
      {"name": "AI控制模块", "path": "backend/ai_control/", "files": ["auto_strategy.py"]},
      {"name": "AR引擎模块", "path": "backend/ar_engine/", "files": ["frame_pipeline.py"]}
    ],
    "engines_to_check": [
      {"name": "Deep-Live-Cam", "path": "engines/deep_live_cam/run.py"},
      {"name": "FaceFusion", "path": "engines/facefusion/facefusion.py"},
      {"name": "iRoop", "path": "engines/iroop/run.py"}
    ]
  }
}
```

## 检测内容

### 依赖层检查

检测以下必需包是否已安装:
- fastapi, uvicorn (后端框架)
- opencv-python, numpy (图像处理)
- psutil, GPUtil (系统监控)
- mediapipe (人脸检测)
- loguru, watchdog (日志和监控)

### 系统层检查

| 指标 | 警告阈值 | 严重阈值 | 单位 |
|-----|---------|---------|------|
| CPU使用率 | 70 | 90 | % |
| 内存使用率 | 75 | 90 | % |
| 磁盘使用率 | 80 | 95 | % |
| GPU使用率 | 80 | 95 | % |

### 进程层检查

| 进程 | 端口 | 必需 | 描述 |
|------|------|-----|------|
| AISP Backend API | 8000 | 是 | 后端API服务 |
| Ollama Service | 11434 | 是 | 本地AI服务 |
| OBS WebSocket | 4455 | 否 | OBS控制 |

### 业务层检查

- API端点连通性测试
- 模块文件存在性检查
- 引擎文件存在性检查

## 状态说明

| 状态 | 图标 | 含义 |
|-----|------|------|
| ok | ✓ | 一切正常 |
| warning | ⚠️ | 需要关注 |
| critical | ✗ | 存在严重问题 |

## 故障排除

### 常见问题

#### 1. psutil未安装

```bash
# 解决
pip3 install psutil
```

#### 2. Flask未安装 (Web界面不可用)

```bash
pip3 install flask
```

#### 3. 端口被占用

```bash
python3 scripts/health_check.py --web --port 8081
```

#### 4. API服务未启动

```bash
# 启动AISP后端服务
bash scripts/start_server.sh

# 然后再运行健康检测
python3 scripts/health_check.py
```

## 输出文件

检测结果保存到: `AISP/logs/health_check_latest.json`

*文档版本: 1.1.1*
*最后更新: 2025-01-21*
