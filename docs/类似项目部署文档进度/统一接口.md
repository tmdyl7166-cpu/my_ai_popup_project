# AISP 统一接口文档

> **文档版本**: 4.0.0  
> **最后更新**: 2025-01-21  
> **状态**: 活跃开发中  
> **API入口**: `backend/unified_api.py` (端口8000)

## 目录

1. [API端点总览](#1-api端点总览)
2. [业务功能API](#2-业务功能api)
3. [核心服务模块](#3-核心服务模块)
4. [AR引擎适配器](#4-ar引擎适配器)
5. [配置管理](#5-配置管理)
6. [数据流与模块依赖](#6-数据流与模块依赖)
7. [认证与权限](#7-认证与权限)

---

## 1. API端点总览

### 1.1 统一API入口

| 服务 | 端口 | 文件 | 描述 |
|------|------|------|------|
| **统一API** | 8000 | `backend/unified_api.py` | 主业务API + 监控API |
| **Web Portal** | 8080 | `web/web_api.py` | 前端静态服务 + API代理 |

### 1.2 统一API端点

#### 健康检查与监控

| 端点 | 方法 | 认证 | 描述 |
|------|------|------|------|
| `/health` | GET | 无 | 服务健康检查 |
| `/status` | GET | 无 | 获取系统状态 |
| `/web/api/status` | GET | 无 | 获取监控状态 |
| `/web/api/full-status` | GET | 无 | 获取完整监控数据 |
| `/web/api/run_check` | POST | 无 | 触发健康检查 |
| `/web/api/dependencies` | GET | 无 | 依赖包状态 |
| `/web/api/system` | GET | 无 | 系统资源状态 |
| `/web/api/processes` | GET | 无 | 进程状态 |
| `/web/api/business` | GET | 无 | 业务模块状态 |
| `/web/api/output` | GET | 无 | 输出模块状态 |
| `/web/api/engines` | GET | 无 | 引擎详情 |
| `/web/api/summary` | GET | 无 | 摘要信息 |

#### 认证管理

| 端点 | 方法 | 认证 | 描述 |
|------|------|------|------|
| `/auth/login` | POST | 无 | 用户登录 |
| `/auth/logout` | POST | 会话 | 用户登出 |
| `/auth/me` | GET | 会话 | 获取当前用户信息 |

#### 任务管理

| 端点 | 方法 | 权限 | 描述 |
|------|------|------|------|
| `/tasks` | POST | can_start_pipeline | 创建新任务 |
| `/tasks` | GET | 会话 | 列出所有任务 |

#### 图像处理

| 端点 | 方法 | 权限 | 描述 |
|------|------|------|------|
| `/frame/process` | POST | can_start_pipeline | 处理单帧图像 |

#### AI策略

| 端点 | 方法 | 权限 | 描述 |
|------|------|------|------|
| `/strategy/generate` | POST | can_configure_ai | 生成AI策略 |

---

## 2. 业务功能API

> **所有业务API前缀**: `/api`

### 2.1 摄像头管理API

| 端点 | 方法 | 描述 |
|------|------|------|
| `/api/camera/status` | GET | 获取摄像头状态 |
| `/api/camera/start` | POST | 启动摄像头 |
| `/api/camera/stop` | POST | 停止摄像头 |
| `/api/camera/list` | GET | 获取可用摄像头列表 |

**启动参数**:
```json
{
  "device_id": 0,
  "width": 1920,
  "height": 1080,
  "fps": 30,
  "use_vcam": false
}
```

### 2.2 图片识别API

| 端点 | 方法 | 描述 |
|------|------|------|
| `/api/recognition/status` | GET | 获取识别服务状态 |
| `/api/recognition/detect` | POST | 检测人脸 |
| `/api/recognition/compose` | POST | 图片合成 |

### 2.3 视频合成API

| 端点 | 方法 | 描述 |
|------|------|------|
| `/api/video/status` | GET | 获取视频服务状态 |
| `/api/video/compose` | POST | 执行视频合成 |
| `/api/video/extract_frame` | POST | 提取视频帧 |

### 2.4 AR引擎API

| 端点 | 方法 | 描述 |
|------|------|------|
| `/api/ar/engines` | GET | 获取AR引擎列表 |
| `/api/ar/start` | POST | 启动AR引擎 |
| `/api/ar/stop` | POST | 停止AR引擎 |

### 2.5 直播配置API

| 端点 | 方法 | 描述 |
|------|------|------|
| `/api/live/status` | GET | 获取直播状态 |
| `/api/live/config` | GET/POST | 获取/设置直播配置 |
| `/api/live/start` | POST | 开始直播 |
| `/api/live/stop` | POST | 停止直播 |

---

## 3. 核心服务模块

### 3.1 服务模块列表

| 模块名称 | 文件路径 | 功能描述 |
|----------|----------|----------|
| video_pipeline | backend/services/video_pipeline.py | 视频帧处理流水线 |
| camera_service | backend/services/camera_service.py | 摄像头管理服务 |
| recognition_service | backend/services/recognition_service.py | 图片识别服务 |
| video_compositor | backend/services/video_compositor.py | 视频合成服务 |
| face_detection | backend/services/face_detection.py | 人脸检测服务 |
| face_swap | backend/services/face_swap.py | 人脸合成服务 |
| task_scheduler | backend/services/task_scheduler.py | 任务队列管理 |
| performance_monitor | backend/services/performance_monitor.py | 性能监控 |
| local_ai_interface | backend/services/local_ai_interface.py | 本地AI接口 |

### 3.2 AI控制模块

| 模块名称 | 文件路径 | 功能描述 |
|----------|----------|----------|
| auto_strategy | backend/ai_control/auto_strategy.py | AI策略生成 |
| ollama_client | backend/ai_control/ollama_client.py | Ollama客户端 |
| memory_db | backend/ai_control/memory_db.py | SQLite存储 |

---

## 4. AR引擎适配器

| 引擎名称 | 路径 | 状态 |
|----------|------|------|
| Deep-Live-Cam | backend/ar_engine/Deep-Live-Cam/ | 活跃 |
| FaceFusion | backend/ar_engine/facefusion/ | 活跃 |
| iRoop | backend/ar_engine/iRoopDeepFaceCam/ | 活跃 |

---

## 5. 配置管理

### 配置文件结构

```
config/
├── run_config.example.json
├── ai/model_config.json
├── ai/capability_map.json
├── tasks/task_queue.json
└── tasks/completed_tasks.json
```

---

## 6. 数据流与模块依赖

### 6.1 数据流序列

```
GUI_INPUT -> UNIFIED_API (8000) -> SERVICES -> AI_CONTROL -> ENGINE -> VIRTUAL_CAM
```

### 6.2 服务启动

```bash
# 启动统一API
python -m backend.unified_api

# 启动Web Portal
python -m web.web_api
```

---

## 7. 认证与权限

### 7.1 用户角色

| 角色 | 描述 | 权限 |
|------|------|------|
| admin | 管理员 | 全部权限 |
| operator | 操作员 | 启动流水线 |
| viewer | 查看者 | 只读权限 |

### 7.2 权限列表

| 权限名 | 描述 |
|--------|------|
| can_start_pipeline | 启动流水线 |
| can_configure_ai | 配置AI策略 |

---

## 附录

### 验证命令

```bash
# 健康检查
curl http://127.0.0.1:8000/health

# 摄像头列表
curl http://127.0.0.1:8000/api/camera/list

# AR引擎列表
curl http://127.0.0.1:8000/api/ar/engines

# Web摘要
curl http://127.0.0.1:8080/web/api/summary
```

---

*本文档由AI自动生成*

