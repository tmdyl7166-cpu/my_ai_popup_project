# AISP 本地部署指南

## 概述

AISP (AI Swap Platform) 是一个完全离线的本地AR合成系统，无需互联网连接即可运行。

## 系统要求

### 最低配置
- CPU: Intel Core i5 / AMD Ryzen 5
- RAM: 8GB
- 存储: 10GB 可用空间
- Python: 3.10+

### 推荐配置
- CPU: Intel Core i7 / AMD Ryzen 7+
- RAM: 16GB+
- GPU: NVIDIA GTX 1060+ (支持CUDA加速)
- 存储: 50GB+ SSD

## 快速部署

### 步骤1: 准备环境

```bash
# 进入项目目录
cd /home/vboxuser/桌面/BX/AI规则/AISP

# 创建虚拟环境
python3 -m venv venv

# 激活虚拟环境
source venv/bin/activate

# 升级pip
pip install --upgrade pip wheel
```

### 步骤2: 安装依赖

```bash
# 安装核心依赖
pip install -r requirements.txt

# 安装PyQt6 GUI依赖
pip install PyQt6 PyQt6-WebEngine pyqtgraph
```

### 步骤3: 配置环境

```bash
# 复制环境变量模板
cp .env.example .env

# 编辑配置 (可选)
nano .env
```

### 步骤4: 创建必要目录

```bash
mkdir -p data models logs cache
```

### 步骤5: 启动服务

#### 方式1: 仅API服务
```bash
python3 -m uvicorn backend.api:app --host 0.0.0.0 --port 8000
```

#### 方式2: API + GUI
```bash
python3 run_gui.py
```

#### 方式3: 使用启动脚本
```bash
bash scripts/start_gui.sh
```

## 引擎安装

### Deep-Live-Cam

```bash
# 克隆到引擎目录
cd backend/ar_engine
git clone https://github.com/hacksider/Deep-Live-Cam.git

# 安装依赖
cd Deep-Live-Cam
pip install -r requirements.txt

# 下载模型 (需要从原始项目获取)
# 将模型文件放到 models/ 目录
```

### FaceFusion

```bash
# 克隆到引擎目录
cd backend/ar_engine
git clone https://github.com/facefusion/facefusion.git

# 安装依赖
cd facefusion
pip install -r requirements.txt
```

### iRoop

```bash
# 克隆到引擎目录
cd backend/ar_engine
git clone https://github.com/iroop/iroop.git iRoopDeepFaceCam
```

## 虚拟摄像头设置 (Linux)

### 安装 v4l2loopback

```bash
# Ubuntu/Debian
sudo apt install v4l2loopback-dkms v4l2loopback-utils

# 加载内核模块
sudo modprobe v4l2loopback devices=1 video_nr=10 card_label="AISP Virtual Camera"
```

### 验证设备

```bash
ls -la /dev/video*
# 应该看到 /dev/video10 或类似的设备
```

## 性能优化

### GPU加速

确保安装CUDA版本的PyTorch：

```bash
pip install torch torchvision --index-url https://download.pytorch.org/whl/cu118
```

### 内存优化

在 `.env` 中设置：

```bash
AISP_MAX_WORKERS=2  # 减少并行处理
AISP_TARGET_FPS=15  # 降低帧率目标
```

### 禁用不必要的模块

如果不需要AI策略生成：

```bash
AISP_AI_ENABLED=false
```

## 故障排除

### 问题1: 导入错误

```bash
# 重新安装依赖
pip install --force-reinstall -r requirements.txt
```

### 问题2: GPU不可用

```bash
# 检查CUDA
python3 -c "import torch; print(torch.cuda.is_available())"
```

### 问题3: 端口被占用

```bash
# 查看占用端口的进程
lsof -i :8000

# 更改端口
AISP_API_PORT=8001 python3 -m uvicorn backend.api:app
```

### 问题4: 虚拟摄像头无法创建

```bash
# 检查权限
sudo chmod 666 /dev/video*

# 或添加当前用户到 video 组
sudo usermod -aG video $USER
```

## 目录结构说明

```
AISP/
├── backend/           # 后端服务
│   ├── api.py        # API入口
│   ├── services/     # 核心服务
│   └── ar_engine/    # AR引擎
├── gui/              # 图形界面
├── virtual_cam/      # 虚拟摄像头
├── obs_integration/  # OBS集成
├── config/           # 配置目录
├── data/             # 数据存储
├── models/           # 模型文件
├── logs/             # 日志文件
└── scripts/          # 启动脚本
```

## 常用命令

```bash
# 启动API服务
python3 -m uvicorn backend.api:app --host 0.0.0.0 --port 8000

# 启动GUI
python3 run_gui.py

# 运行健康检查
python3 scripts/health_check.py

# 验证配置
python3 scripts/validate_configs.py --verbose

# 查看日志
tail -f logs/aisp.log
```

## 注意事项

1. **完全离线**: 系统设计为完全离线运行，无需互联网
2. **资源占用**: 处理视频时CPU/GPU占用较高
3. **模型文件**: 需要单独下载各引擎的模型文件
4. **权限要求**: 使用虚拟摄像头可能需要sudo权限

## 获取帮助

- 查看文档: `docs/` 目录
- API文档: 启动后访问 http://localhost:8000/docs
- 常见问题: 参考 README.md

