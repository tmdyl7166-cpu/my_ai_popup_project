# AISP 模块依赖关系

> 详细说明AISP项目中各模块之间的依赖关系和数据流向。

## 依赖关系总览

```
                    ┌─────────────────┐
                    │   gui/          │
                    │  main_window.py │
                    └────────┬────────┘
                             │ 调用API
                             ▼
                    ┌─────────────────┐
                    │  backend/       │
                    │    api.py       │ ◄── FastAPI入口
                    └────────┬────────┘
                             │
              ┌──────────────┼──────────────┐
              │              │              │
              ▼              ▼              ▼
    ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
    │ backend/        │ │ backend/        │ │ backend/        │
    │ services/       │ │ ai_control/     │ │ control_core/   │
    │                 │ │                 │ │                 │
    │ • face_detection│ │ • auto_strategy │ │ • server.py     │
    │ • face_recognition│ │ • ollama_client│ │ • state_manager │
    │ • face_swap     │ │ • memory_db     │ │ • validator     │
    │ • video_pipeline│ │                 │ │ • module_router │
    │ • task_scheduler│ │                 │ │ • instruction_  │
    │ • task_executor │ │                 │ │   parser        │
    │ • performance_  │ │                 │ │ • user_session  │
    │   monitor       │ │                 │ │ • resource_     │
    │ • local_ai_     │ │                 │ │   guard         │
    │   interface     │ │                 │ │ • pipeline_     │
    │                 │ │                 │ │   manager       │
    └────────┬────────┘ └────────┬────────┘ │ • monitor       │
             │                   │           └─────────────────┘
             │                   │
             │     ┌─────────────┤
             │     │             │
             ▼     ▼             ▼
    ┌─────────────────────────────────┐
    │      backend/ar_engine/         │
    │                                 │
    │   • frame_pipeline.py           │
    │   • adapters/                   │
    │   │   ├── deep_live_cam.py      │
    │   │   ├── facefusion.py         │
    │   │   ├── iroop.py              │
    │   │   └── expression.py         │
    │   • tracker/                    │
    │       └── face_tracker.py       │
    └─────────────────────────────────┘
                   │
                   │ 调用引擎
                   ▼
    ┌─────────────────────────────────┐
    │         engines/                │
    │                                 │
    │   • engine_base.py (基类)       │
    │   • deep_live_cam/              │
    │   • facefusion/                 │
    │   • iroop/                      │
    └─────────────────────────────────┘
                   │
                   │ 输出
     ┌─────────────┴─────────────┐
     │                           │
     ▼                           ▼
┌─────────────────┐   ┌─────────────────┐
│  virtual_cam/   │   │ obs_integration/│
│                 │   │                 │
│ • virtual_      │   │ • obs_          │
│   camera.py     │   │   controller.py │
└─────────────────┘   └─────────────────┘
```

---

## 详细依赖说明

### 1. GUI层 (gui/)

```
main_window.py
├── 依赖: backend/api.py
├── 依赖: PyQt6
└── 被依赖: 无（顶层模块）
```

**职责**:
- 用户界面展示
- 用户输入处理
- 状态展示
- 弹窗与提示

**禁止**:
- 直接调用业务逻辑
- 直接调用AI推理
- 直接调用引擎

---

### 2. 后端API层 (backend/api.py)

```
api.py (FastAPI)
├── 依赖: backend/models.py
├── 依赖: backend/services/*
├── 依赖: backend/control_core/*
├── 依赖: backend/database/db.py
├── 依赖: web/web_api.py
├── 依赖: backend/unified_api.py
└── 被依赖: gui/main_window.py
```

**API端点**:
- `GET /health` - 健康检查
- `POST /api/tasks` - 创建任务
- `GET /api/tasks` - 列出任务
- `POST /api/frame/process` - 处理帧
- `POST /api/video/process` - 处理视频
- `POST /api/strategy/generate` - AI策略生成
- `GET /api/status` - 系统状态

---

### 3. 服务层 (backend/services/)

```
├── face_detection.py
│   ├── 依赖: opencv-python, mediapipe
│   └── 被依赖: video_pipeline.py, frame_pipeline.py
│
├── face_recognition.py
│   ├── 依赖: face_detection.py
│   └── 被依赖: video_pipeline.py
│
├── face_swap.py
│   ├── 依赖: engines/*
│   └── 被依赖: video_pipeline.py
│
├── video_pipeline.py
│   ├── 依赖: face_detection.py
│   ├── 依赖: face_recognition.py
│   ├── 依赖: face_swap.py
│   ├── 依赖: performance_monitor.py
│   └── 被依赖: api.py
│
├── task_executor.py ⚠️ (功能重复)
│   ├── 依赖: config/tasks/task_queue.json
│   └── 被依赖: api.py
│
├── task_scheduler.py ⭐
│   ├── 依赖: asyncio
│   └── 被依赖: api.py
│
├── performance_monitor.py ⭐
│   ├── 依赖: psutil, GPUtil
│   └── 被依赖: video_pipeline.py, api.py
│
└── local_ai_interface.py
    ├── 依赖: ai_control/ollama_client.py
    └── 被依赖: api.py
```

---

### 4. AI控制层 (backend/ai_control/)

```
├── auto_strategy.py ⭐
│   ├── 依赖: ollama_client.py
│   ├── 依赖: config/tasks/task_queue.json
│   └── 被依赖: local_ai_interface.py
│
├── ollama_client.py ⭐
│   ├── 依赖: requests
│   └── 被依赖: auto_strategy.py, local_ai_interface.py
│
├── memory_db.py ⭐
│   ├── 依赖: sqlite3
│   └── 被依赖: auto_strategy.py
```

**数据流**:
```
用户输入 → api.py → local_ai_interface.py 
    → ollama_client.py → Ollama服务
    → auto_strategy.py → 生成策略
    → memory_db.py → 存储学习数据
```

---

### 5. AR引擎层 (backend/ar_engine/)

```
├── frame_pipeline.py ⭐
│   ├── 依赖: adapters/*
│   ├── 依赖: tracker/face_tracker.py
│   └── 被依赖: video_pipeline.py
│
├── adapters/
│   ├── __init__.py
│   ├── deep_live_cam.py
│   │   ├── 依赖: engines/engine_base.py
│   │   └── 被依赖: frame_pipeline.py
│   │
│   ├── facefusion.py
│   │   ├── 依赖: engines/engine_base.py
│   │   └── 被依赖: frame_pipeline.py
│   │
│   ├── iroop.py
│   │   ├── 依赖: engines/engine_base.py
│   │   └── 被依赖: frame_pipeline.py
│   │
│   └── expression.py
│       ├── 依赖: engines/engine_base.py
│       └── 被依赖: frame_pipeline.py
│
└── tracker/
    ├── __init__.py
    └── face_tracker.py
        ├── 依赖: mediapipe
        └── 被依赖: frame_pipeline.py
```

---

### 6. 控制核心层 (backend/control_core/)

```
├── server.py ⭐
│   ├── 依赖: uvicorn, fastapi
│   └── 被依赖: api.py (启动入口)
│
├── state_manager.py
│   └── 被依赖: server.py, api.py
│
├── validator.py
│   └── 被依赖: module_router.py, instruction_parser.py
│
├── module_router.py
│   ├── 依赖: validator.py
│   └── 被依赖: server.py
│
├── instruction_parser.py
│   ├── 依赖: validator.py
│   └── 被依赖: server.py
│
├── user_session.py
│   └── 被依赖: server.py
│
├── resource_guard.py
│   └── 被依赖: server.py
│
├── pipeline_manager.py
│   └── 被依赖: server.py
│
└── monitor.py ⚠️ (功能重复)
    ├── 依赖: psutil, GPUtil
    └── 被依赖: server.py
```

---

### 7. 引擎层 (engines/)

```
├── engine_base.py ⭐ (抽象基类)
│   ├── 定义接口: is_available, start, stop, process_frame
│   └── 被依赖: 所有适配器
│
├── deep_live_cam/
│   ├── 依赖: engine_base.py
│   └── 依赖: 第三方源码
│
├── facefusion/
│   ├── 依赖: engine_base.py
│   └── 依赖: 第三方源码
│
└── iroop/
    ├── 依赖: engine_base.py
    └── 依赖: 第三方源码
```

**规则**:
- 禁止修改第三方源码
- 只能通过适配器封装调用
- 所有调用必须经过 `engine_base.py`

---

### 8. 输出层

#### virtual_cam/

```
virtual_camera.py
├── 依赖: pyvirtualcam
└── 被依赖: video_pipeline.py
```

#### obs_integration/

```
obs_controller.py
├── 依赖: obswebsocket
└── 被依赖: video_pipeline.py
```

---

## 配置依赖

```
config/
├── config_loader.py ⭐
│   ├── 依赖: project_config.json
│   ├── 依赖: ai_config.json
│   ├── 依赖: engines_config.json
│   └── 依赖: output_config.json
│
├── project_config.json
│   ├── 定义: paths, modules, data_flow
│   └── 被依赖: 所有模块
│
├── ai_config.json
│   ├── 定义: ollama, models, strategy
│   └── 被依赖: ai_control/*
│
├── engines_config.json
│   ├── 定义: 引擎参数, 适配器
│   └── 被依赖: engines/*, ar_engine/adapters/*
│
└── output_config.json
    ├── 定义: virtual_camera, obs_integration
    └── 被依赖: virtual_cam/*, obs_integration/*
```

---

## 依赖规则总结

### ✅ 允许的依赖

| 层级 | 可以依赖 |
|------|---------|
| GUI层 | 后端API |
| API层 | 服务层、控制核心 |
| 服务层 | AI控制、AR引擎、其他服务 |
| AI控制层 | Ollama服务、数据库 |
| AR引擎层 | 引擎层适配器 |
| 引擎层 | 第三方源码 |

### ❌ 禁止的依赖

| 层级 | 禁止依赖 |
|------|---------|
| GUI层 | 任何业务逻辑、引擎 |
| 服务层 | 控制核心内部实现 |
| AI控制层 | GUI、服务层 |
| AR引擎层 | GUI、后端逻辑 |
| 引擎层 | 后端任何模块 |

---

## 重复依赖问题

### 问题1: 多个性能监控

```
scripts/monitor.py
    └── 依赖: psutil, GPUtil
    
backend/services/performance_monitor.py
    └── 依赖: psutil, GPUtil
    
backend/control_core/monitor.py
    └── 依赖: psutil, GPUtil
```

**解决方案**: 统一使用 `backend/services/performance_monitor.py`

### 问题2: 多个任务调度

```
backend/services/task_executor.py
    └── 依赖: json
    
backend/services/task_scheduler.py
    └── 依赖: asyncio, json
```

**解决方案**: 统一使用 `task_scheduler.py`（功能更完整）

### 问题3: 多个数据存储

```
backend/ai_control/memory_db.py
    └── 依赖: sqlite3
    
backend/ai_control/memory_store.py
    └── 依赖: json
```

**解决方案**: 统一使用 `memory_db.py`（SQLite更可靠）

---

*文档版本: 1.1.0*
*最后更新: 2025-01-21*

