# AISP 配置说明文档

## 📋 配置层级结构

AISP使用**四级配置层级**体系，确保配置的优先级和继承关系清晰。

```
┌─────────────────────────────────────────────────────────────┐
│  Level 1: 根规则 (不可覆盖)                                   │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│  • AI_RULES.json       - AI行为约束与项目规则                 │
│  • AI_PATH_CONTEXT.json - 模块路径与职责定义                  │
│  • AI_CLEANUP_POLICY.json - 清理与去重规则                   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  Level 2: 项目主配置                                         │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│  • project_config.json  - 项目主配置                         │
│  • ai_config.json       - AI配置                             │
│  • engines_config.json  - 引擎配置                           │
│  • output_config.json   - 输出配置                           │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  Level 3: 运行配置                                           │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│  • run_config.json       - API服务器和Ollama配置             │
│  • health_check_config.json - 健康检查配置                   │
│  • AI3.json              - 前端交互与UI优化规则               │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  Level 4: 功能子配置                                         │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│  • ai/model_config.json    - AI模型配置                      │
│  • ai/capability_map.json  - 能力映射                        │
│  • tasks/task_queue.json   - 任务队列                        │
│  • tasks/task_schema.json  - 任务模式定义                    │
└─────────────────────────────────────────────────────────────┘
```

---

## 📁 配置文件清单

### Level 1: 根规则配置

| 文件 | 优先级 | 说明 |
|------|--------|------|
| `AI_RULES.json` | 1 | AI行为约束、自动化检测、队列管理 |
| `AI_PATH_CONTEXT.json` | 1 | 模块路径、职责划分、数据流定义 |
| `AI_CLEANUP_POLICY.json` | 1 | 清理策略、去重规则 |

### Level 2: 项目主配置

| 文件 | 优先级 | 说明 |
|------|--------|------|
| `config/project_config.json` | 2 | 项目基本配置 |
| `config/ai_config.json` | 2 | AI功能配置 |
| `config/engines_config.json` | 2 | 引擎配置 |
| `config/output_config.json` | 2 | 输出配置 |

### Level 3: 运行配置

| 文件 | 优先级 | 说明 |
|------|--------|------|
| `config/run_config.json` | 3 | API服务器、Ollama、端点配置 |
| `config/health_check_config.json` | 3 | 健康检查配置 |
| `config/AI3.json` | 3 | 前端交互、弹窗、跨域规则 |

### Level 4: 功能子配置

| 文件 | 优先级 | 说明 |
|------|--------|------|
| `config/ai/model_config.json` | 4 | AI模型参数配置 |
| `config/ai/capability_map.json` | 4 | 能力映射表 |
| `config/tasks/task_queue.json` | 4 | 任务队列管理 |
| `config/tasks/task_schema.json` | 4 | 任务模式定义 |

---

## 🔄 配置继承规则

### 层级继承
```
Level 1 (根规则)
    │
    ├──▶ Level 2 (项目配置) ──必须遵循Level 1的约束
    │           │
    │           ├──▶ Level 3 (运行配置) ──必须遵循Level 1-2的约束
    │           │           │
    │           │           └──▶ Level 4 (子配置) ──必须遵循Level 1-3的约束
    │           │
    └──▶ 其他层级配置
```

### 优先级规则

| 优先级 | 规则 | 说明 |
|--------|------|------|
| 最高 | Level 1 | 根规则不可覆盖 |
| 高 | Level 2 | 项目配置不可覆盖Level 1 |
| 中 | Level 3 | 运行配置可覆盖，需注明原因 |
| 低 | Level 4 | 子配置可覆盖，受上级约束 |

---

## 🔗 配置关联关系

### AI_RULES.json 关联
```
AI_RULES.json
├── 依赖: AI_PATH_CONTEXT.json (路径上下文)
├── 依赖: AI_CLEANUP_POLICY.json (清理策略)
├── 约束: project_config.json
├── 约束: ai_config.json
└── 引用: task_queue.json (任务队列)
```

### AI_PATH_CONTEXT.json 关联
```
AI_PATH_CONTEXT.json
├── 依赖: AI_RULES.json (规则定义)
├── 依赖: AI_CLEANUP_POLICY.json (清理策略)
├── 约束: project_config.json (项目路径)
├── 约束: engines_config.json (引擎路径)
├── 引用: config/AI3.json (前端规则)
└── 引用: config/ai/model_config.json (模型路径)
```

### run_config.json 关联
```
run_config.json
├── 依赖: AI_RULES.json
├── 依赖: AI_PATH_CONTEXT.json
├── 依赖: AI_CLEANUP_POLICY.json
├── 引用: project_config.json
└── 协同: ai_config.json
```

### AI3.json 关联
```
AI3.json
├── 根规则: AI_RULES.json
├── 根规则: AI_PATH_CONTEXT.json
├── 根规则: AI_CLEANUP_POLICY.json
├── 引用: project_config.json
├── 协同: run_config.json
└── 约束: task_queue.json
```

---

## 📊 数据流配置

### 标准数据流
```json
{
  "data_flow": [
    "GUI_INPUT",
    "BACKEND_API",
    "SERVICE_PROCESSING",
    "AI_CONTROL",
    "LOCAL_AI_INTERFACE",
    "ENGINE_EXECUTION",
    "VIRTUAL_CAM_OUTPUT"
  ]
}
```

### 层级映射
| 层级 | 路径 | 说明 |
|------|------|------|
| GUI层 | `gui/` | 用户界面 |
| 后端API | `backend/unified_api.py` | API入口 |
| 服务层 | `backend/services/` | 业务逻辑 |
| AI控制层 | `backend/ai_control/` | AI决策 |
| AR引擎层 | `backend/ar_engine/` | 引擎封装 |
| 控制核心 | `backend/control_core/` | 状态管理 |
| 引擎层 | `engines/` | 第三方引擎 |
| 输出层 | `virtual_cam/, obs_integration/` | 输出 |

---

## ⚙️ 队列配置

### 队列类型
```json
{
  "interaction_queues": {
    "api_requests": {
      "type": "fifo",
      "max_size": 100,
      "priority_support": true,
      "timeout_seconds": 30
    },
    "task_execution": {
      "type": "priority",
      "max_size": 50,
      "priority_levels": ["critical", "high", "normal", "low"],
      "timeout_seconds": 300
    },
    "event_processing": {
      "type": "batching",
      "batch_size": 20,
      "flush_interval_ms": 100
    },
    "ai_inference": {
      "type": "single",
      "max_concurrent": 1,
      "queue_timeout_seconds": 600
    },
    "video_frame_processing": {
      "type": "realtime",
      "max_concurrent": 1,
      "priority": "highest",
      "timeout_seconds": 0.033
    }
  }
}
```

---

## 🚨 冲突检测

### 配置冲突规则
1. **路径冲突**: 检查`AI_PATH_CONTEXT.json`中定义的路径
2. **规则冲突**: 检查`AI_RULES.json`中的全局规则
3. **优先级冲突**: 低层级配置不得覆盖高层级规则
4. **依赖缺失**: 确保所有`depends_on`配置存在

### 冲突处理
```
冲突检测流程:
1. 读取Level 1配置 (根规则)
2. 验证Level 2配置 (继承检查)
3. 验证Level 3配置 (依赖检查)
4. 验证Level 4配置 (一致性检查)
5. 生成验证报告
```

---

## 📝 配置验证

### 验证命令
```bash
# 验证所有配置
python scripts/validate_configs.py

# 验证路径配置
python scripts/verify_paths.py

# 验证部署状态
python scripts/verify_deployment.py
```

### 验证项
- JSON语法正确性
- 路径引用有效性
- 配置层级正确性
- 依赖关系完整性
- 优先级覆盖检查

---

## 🔧 配置更新

### 更新流程
1. 修改对应层级的配置文件
2. 运行验证脚本
3. 重启相关服务
4. 验证功能正常

### 重启命令
```bash
# 重启后端服务
./scripts/start_server.sh

# 重启GUI
./scripts/start_gui.sh

# 重启所有服务
./scripts/start_all.sh
```

---

## 📌 注意事项

1. **Level 1配置不可修改**: AI_RULES.json、AI_PATH_CONTEXT.json、AI_CLEANUP_POLICY.json为只读
2. **修改前备份**: 修改任何配置文件前先备份
3. **验证后再部署**: 使用`validate_configs.py`验证配置
4. **遵循继承规则**: 下级配置必须符合上级规则
5. **文档同步更新**: 配置变更需同步更新相关文档

---

*最后更新: 2025-01-21 | 版本: 2.0.0*
