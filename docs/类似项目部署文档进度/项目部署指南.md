# AISP 项目部署指南

> 本文档整合了项目部署整体大纲和开发部署大纲的内容，提供完整的部署指导。

## 一、环境准备

### 系统要求

- Python 3.12
- GPU支持（CUDA/cuDNN 可选，用于加速）
- 操作系统：Windows / Linux / macOS

### 虚拟环境创建

```bash
python3.12 -m venv venv
source venv/bin/activate  # Linux/macOS
# Windows: venv\Scripts\activate
pip install --upgrade pip
```

### 核心依赖安装

```bash
pip install -r requirements.txt
```

### 依赖分类

| 类别 | 插件/库 | 用途 |
|------|---------|------|
| GUI | PyQt6, PyQtGraph | 桌面界面、实时视频/图像显示 |
| 前端 | Jinja2, Bootstrap 5 | Dev Portal模板渲染与UI美化 |
| Backend | fastapi, uvicorn, pandas, numpy | API接口、任务调度、数据处理 |
| AI | Ollama (LLaMA 3.2), OpenCV, MediaPipe FaceMesh | 本地AI推理、检测、识别、换脸 |
| 虚拟摄像头 | pyvirtualcam | 输出到OBS/Zoom |
| OBS控制 | obs-websocket-py | OBS远程控制与任务同步 |
| 任务管理 | watchdog, loguru | 文件监控、日志记录 |
| 图像生成 | Stable Diffusion, ControlNet | AR增强、图像合成 |
| AI加速 | ONNX Runtime, CUDA/cuDNN, Numba | GPU/CPU加速 |
| 开发辅助 | VS Code+Blackbox AI, pytest, sphinx | 代码修复、单元测试、文档生成 |

---

## 二、项目分层结构

### 1. 用户交互层（GUI & Dev Portal）

**作用**：
- 展示主窗口与弹窗
- 显示任务状态、AI结果、调试信息
- 提供 Dev Portal 浏览器端实时监控

**组件**：

| 模块 | 插件/库 | 功能 |
|------|---------|------|
| 桌面界面 | PyQt6 | 主窗口、弹窗操作 |
| 图像显示 | PyQtGraph | 视频帧/识别结果实时渲染 |
| 前端模板 | Jinja2 | Dev Portal HTML模板渲染 |
| 前端样式 | Bootstrap 5 | 响应式UI美化 |

**部署方式**：
- GUI: `python main_window.py`
- Dev Portal: FastAPI + Jinja2 渲染 (http://localhost:8000)

---

### 2. 业务逻辑层（Backend）

**作用**：
- 核心AI逻辑处理：检测、识别、换脸
- AI策略调度
- 任务队列管理（task_queue.json / completed_tasks.json）

**组件**：

| 模块 | 插件/库 | 功能 |
|------|---------|------|
| 后端框架 | FastAPI + Uvicorn | API接口、任务调度 |
| 数据存储 | SQLite + Pandas | 任务记录、状态存储 |
| AI策略 | ai_control.py | 调度AI，统一调用 local_ai_interface.py |
| 服务 | face_detection.py, face_recognition.py, face_swap.py | 检测→识别→合成 |

**部署**：
```bash
uvicorn backend.api:app --reload --host 0.0.0.0 --port 8000
```

---

### 3. 引擎封装层（Engines）

**作用**：
- 封装第三方子项目，统一接口
- 避免直接操作引擎文件，保证AI调用可控

**组件**：

| 子项目 | 功能 | AI调用方式 |
|--------|------|-----------|
| Deep-Live-Cam | 实时换脸 | engine_base.py |
| iRoopDeepFaceCam | 视频换脸 | engine_base.py |
| Facefusion | 静态图/视频合成 | engine_base.py |

**部署**：
- 将第三方子项目放入 `engines/` 目录
- 确保 `engine_base.py` 能统一调用

---

### 4. AI接口层（Local AI Interface）

**作用**：
- 本地AI调用集中管理
- 支持 Ollama / LLaMA 3.2 推理、生成、增强
- 输出结果标准化并记录日志

**组件**：

| 文件 | 功能 |
|------|------|
| local_ai_interface.py | 所有AI推理请求统一入口 |

**接口**：
- `/api/ai/detect_face` → 人脸检测
- `/api/ai/recognize_face` → 特征识别
- `/api/ai/face_swap` → 换脸/合成
- `/api/tasks/update` → 更新任务状态

---

### 5. 输出层（虚拟摄像头 + OBS）

**作用**：
- 视频/图像输出到虚拟摄像头
- OBS同步显示/录制
- Dev Portal实时预览

**组件**：

| 模块 | 插件/库 | 功能 |
|------|---------|------|
| 虚拟摄像头 | pyvirtualcam | 输出到OBS/Zoom |
| OBS控制 | obs-websocket-py | 场景切换、远程控制 |
| 输出监控 | Dev Portal | 视频帧流、任务状态显示 |

---

## 三、任务流与数据流

### 1. 数据流

```
用户输入 → Backend服务 → AI策略 → Engines → Local AI → 输出层 → GUI/Dev Portal
```

**处理顺序**：
1. 主素材输入（图片/视频/摄像头）
2. AI检测（face_detection）
3. AI识别（face_recognition）
4. AI合成/换脸（face_swap）
5. AI策略调度（ai_control）
6. Local AI接口调用（Ollama/LLaMA）
7. 引擎封装调用（Deep-Live-Cam / Facefusion）
8. 输出（本地保存 / 虚拟摄像头 / Dev Portal）
9. 更新任务状态（task_queue.json → completed_tasks.json）

---

### 2. 任务驱动逻辑

**任务读取**：
- AI读取 `TOOD.md` + `task_queue.json`
- 优先处理未完成任务

**任务执行**：
- 按依赖顺序执行服务
- 调用 Local AI 生成或增强

**任务完成**：
- 更新 `completed_tasks.json`
- `TOOD.md` 高亮标记 ✅
- GUI或Dev Portal弹窗通知用户或人工审核

---

## 四、输出场景部署逻辑

| 输出类型 | 接口 | 参数配置 | 异常处理 |
|---------|------|---------|---------|
| 本地保存 | local_ai_interface.py → save_file | 路径、文件名、压缩质量 | 写入失败 → 弹窗提示 + 日志 |
| 虚拟摄像头 | pyvirtualcam_wrapper.py | 分辨率、帧率、摄像头ID | 摄像头占用 → 弹窗 + 自动重试 |
| OBS同步 | obs-websocket-py | 场景ID、源ID | 连接失败 → Dev Portal显示警告 |
| Dev Portal预览 | /api/video/frame | 刷新间隔、分辨率 | 流丢帧 → 自动重连 |
| 日志记录 | loguru | 日志级别、JSON/Plain | 写入失败 → 控制台提示 |
| 任务通知 | /api/notifications/send | 弹窗文字、声音 | 弹窗失败 → Dev Portal通知 |

---

## 五、监控与性能管理

### 实时监控

- 帧率、GPU/CPU使用率、AI推理时间
- 前端显示统计面板

### 异常处理

- 流丢帧 → 自动重连
- GPU/CPU占用过高 → 暂停低优先级任务
- 输出失败 → 弹窗 + 日志 + 状态更新

---

## 六、开发与测试

| 工具 | 用途 |
|------|------|
| pytest | 单元测试，保证模块逻辑稳定 |
| VS Code + Blackbox AI | 代码优化 |
| Sphinx | 文档生成 |
| Swagger UI (FastAPI自带) | 接口调试 |

---

## 七、快速启动

```bash
# 1. 环境准备
bash scripts/setup_env.sh

# 2. 启动后端API
bash scripts/start_server.sh

# 3. 启动GUI（可选）
bash scripts/start_gui.sh

# 4. 一键启动所有服务
bash scripts/start_all.sh

# 5. 验证部署
python scripts/verify_deployment.py
```

---

## 八、相关文档

- [项目结构说明](项目结构说明.md) - 详细目录结构
- [模块依赖关系](模块依赖关系.md) - 模块依赖图
- [配置说明](配置说明.md) - 配置参数详解
- [健康检测说明](健康检测说明.md) - 健康检查功能说明

---

*文档版本: 2.0.1（整合版）*
*最后更新: 2025-01-21*

