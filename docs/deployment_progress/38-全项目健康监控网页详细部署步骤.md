# AI弹窗项目 - 全项目健康监控网页详细部署文档

## 文档信息

| 项目 | 内容 |
|------|------|
| 文档名称 | 38-全项目健康监控网页详细部署步骤 |
| 创建时间 | 2026-01-19 |
| 项目路径 | `/home/vboxuser/桌面/BX/HC/my_ai_popup_project` |
| Web服务端口 | 8080 |

---

## 一、项目概述

### 1.1 项目目标

创建一个功能完整的全项目健康监控网页，实现：
- 前后端统一启动和监控
- 实时健康状态展示
- 模块化功能管理
- 自动化脚本调用
- 完善的错误处理和用户交互

### 1.2 技术栈

| 层级 | 技术 | 版本 |
|------|------|------|
| 前端框架 | Bootstrap | 5.3.0 |
| 图标库 | Font Awesome | 6.4.0 |
| 动画库 | Animate.css | 4.1.1 |
| WebSocket | Socket.IO | 4.7.2 |
| 图表库 | Chart.js | 最新 |
| 后端框架 | FastAPI | 最新 |
| 实时通信 | python-socketio | 最新 |

---

## 二、模块架构

### 2.1 模块列表

项目已创建 **17个独立JavaScript模块**，每个模块遵循单一职责原则：

#### 核心管理模块（4个）

| 模块名称 | 文件路径 | 职责 |
|---------|---------|------|
| WebSocketManager | `web/static/js/modules/websocketManager.js` | WebSocket连接管理 |
| ModalManager | `web/static/js/modules/modalManager.js` | 模态框创建和管理 |
| Notifications | `web/static/js/modules/notifications.js` | 通知系统 |
| GlobalActions | `web/static/js/modules/globalActions.js` | 全局操作功能 |

#### 功能监控模块（6个）

| 模块名称 | 文件路径 | 职责 |
|---------|---------|------|
| GlobalMonitor | `web/static/js/modules/globalMonitor.js` | 全局内容部署实时监控 |
| DeploymentProgress | `web/static/js/modules/deploymentProgress.js` | 部署进度监控 |
| ModuleStatus | `web/static/js/modules/moduleStatus.js` | 功能模块状态监控 |
| ScriptControl | `web/static/js/modules/scriptControl.js` | 脚本控制 |
| ConfigManagement | `web/static/js/modules/configManagement.js` | 配置管理 |
| LogsViewer | `web/static/js/modules/logsViewer.js` | 日志查看 |

#### 新增独立功能模块（7个）

| 模块名称 | 文件路径 | 职责 |
|---------|---------|------|
| PortMapping | `web/static/js/modules/portMapping.js` | 统一前后端口映射表 |
| BubbleMonitor | `web/static/js/modules/bubbleMonitor.js` | 功能冒泡监测与实时通知 |
| SubProjectMonitor | `web/static/js/modules/subProjectMonitor.js` | 子项目功能监测 |
| ScriptRunner | `web/static/js/modules/scriptRunner.js` | 自动化脚本执行管理 |
| APIInterface | `web/static/js/modules/apiInterface.js` | 统一API调用封装 |
| HealthChecker | `web/static/js/modules/healthChecker.js` | 系统健康检查 |
| SystemResources | `web/static/js/modules/systemResources.js` | 系统资源实时监控 |

#### 基础设施模块（6个）

| 模块名称 | 文件路径 | 职责 |
|---------|---------|------|
| ModalStackManager | `web/static/js/modules/modalStackManager.js` | 嵌套弹窗管理和事件阻止 |
| FormValidator | `web/static/js/modules/formValidator.js` | 表单验证和数据安全 |
| CacheManager | `web/static/js/modules/cacheManager.js` | 缓存管理和冲突避免 |
| LazyLoader | `web/static/js/modules/lazyLoader.js` | 动态加载与懒加载 |
| Pagination | `web/static/js/modules/pagination.js` | 分页控件功能 |

---

## 三、部署步骤

### 3.1 环境准备

#### 3.1.1 检查Python环境

```bash
# 检查Python版本（需要3.7+）
python3 --version

# 检查pip是否安装
pip3 --version
```

#### 3.1.2 安装依赖

```bash
# 进入项目目录
cd /home/vboxuser/桌面/BX/HC/my_ai_popup_project

# 安装Python依赖
pip3 install -r requirements.txt

# 主要依赖包括：
# - fastapi
# - uvicorn
# - python-socketio
# - python-multipart
# - psutil
# - sentry-sdk
```

#### 3.1.3 检查前端资源

```bash
# 确认以下目录存在
ls -la web/static/js/modules/
ls -la web/static/css/
ls -la web/templates/
```

### 3.2 项目配置

#### 3.2.1 后端配置（web/web_config.json）

```json
{
    "app": {
        "host": "0.0.0.0",
        "port": 8080,
        "debug": true,
        "title": "AI弹窗项目监控中心"
    },
    "cors": {
        "enabled": true,
        "origins": ["*"]
    },
    "security": {
        "api_key_enabled": false,
        "rate_limit": {
            "enabled": true,
            "requests_per_minute": 60
        }
    },
    "monitoring": {
        "health_check_interval": 30,
        "auto_refresh_interval": 5000
    }
}
```

#### 3.2.2 项目配置（project_config.json）

```json
{
    "project": {
        "name": "AI弹窗项目",
        "version": "1.0.0",
        "root": "."
    },
    "paths": {
        "scripts": "scripts",
        "logs": "logs",
        "docs": "docs",
        "web": "web",
        "assets": "assets"
    },
    "subprojects": {
        "deep_live_cam": {
            "path": "assets/Deep-Live-Cam-main",
            "enabled": true
        },
        "facefusion": {
            "path": "assets/facefusion-master",
            "enabled": true
        },
        "iroop": {
            "path": "assets/iRoopDeepFaceCam-main",
            "enabled": true
        },
        "obs_studio": {
            "path": "assets/obs-studio-master",
            "enabled": true
        }
    }
}
```

### 3.3 启动步骤

#### 3.3.1 方法一：使用启动脚本

```bash
# 进入项目目录
cd /home/vboxuser/桌面/BX/HC/my_ai_popup_project

# 执行启动脚本
./start.sh

# 或者指定端口
./start.sh --port 8080
```

#### 3.3.2 方法二：直接运行Python

```bash
# 进入项目目录
cd /home/vboxuser/桌面/BX/HC/my_ai_popup_project

# 启动Web服务
python3 web/app.py --host 0.0.0.0 --port 8080
```

#### 3.3.3 方法三：开发模式启动

```bash
# 进入项目目录
cd /home/vboxuser/桌面/BX/HC/my_ai_popup_project

# 使用uvicorn热重载启动
uvicorn web.app:app --host 0.0.0.0 --port 8080 --reload
```

### 3.4 验证部署

#### 3.4.1 检查服务状态

```bash
# 测试健康检查API
curl http://localhost:8080/api/health

# 预期输出：
# {"status":"healthy","timestamp":"2026-01-19T03:13:51.001350","version":"1.0.0"}
```

#### 3.4.2 访问Web界面

打开浏览器访问：**http://localhost:8080**

#### 3.4.3 测试API端点

```bash
# 测试端口API
curl http://localhost:8080/api/ports

# 测试子项目API
curl http://localhost:8080/api/subprojects

# 测试冒泡API
curl http://localhost:8080/api/bubbles
```

---

## 四、模块详细说明

### 4.1 端口映射表模块（PortMapping）

#### 功能描述
统一管理和展示项目所有端口的映射关系和状态。

#### 核心方法

| 方法 | 参数 | 返回值 | 说明 |
|------|------|--------|------|
| `init()` | containerId?: string | void | 初始化模块 |
| `refresh()` | 无 | Promise | 刷新端口数据 |
| `update()` | portData: PortData[] | void | 更新端口信息 |
| `destroy()` | 无 | void | 销毁模块 |

#### 使用示例

```javascript
// 在容器中初始化
PortMapping.init('portMappingContent');

// 刷新数据
PortMapping.refresh();

// 获取端口状态
const status = PortMapping.getStatus();
```

### 4.2 冒泡监测模块（BubbleMonitor）

#### 功能描述
以冒泡形式实时展示系统状态变化和告警信息。

#### 核心方法

| 方法 | 参数 | 返回值 | 说明 |
|------|------|--------|------|
| `init()` | 无 | void | 初始化冒泡容器 |
| `show(type, title, message)` | type: string, title: string, message: string | void | 显示冒泡 |
| `success(title, message)` | title: string, message: string | void | 显示成功冒泡 |
| `error(title, message)` | title: string, message: string | void | 显示错误冒泡 |
| `warning(title, message)` | title: string, message: string | void | 显示警告冒泡 |
| `dismiss(bubbleId)` | bubbleId: string | void | 关闭指定冒泡 |
| `dismissAll()` | 无 | void | 关闭所有冒泡 |

#### 使用示例

```javascript
// 显示成功通知
BubbleMonitor.success('部署完成', '项目部署已成功完成');

// 显示错误通知
BubbleMonitor.error('连接失败', '无法连接到服务器');

// 显示警告通知
BubbleMonitor.warning('资源不足', '内存使用率超过80%');
```

### 4.3 子项目监测模块（SubProjectMonitor）

#### 功能描述
监控所有子项目（Deep-Live-Cam、FaceFusion等）的运行状态。

#### 核心方法

| 方法 | 参数 | 返回值 | 说明 |
|------|------|--------|------|
| `init()` | containerId?: string | void | 初始化模块 |
| `refresh()` | 无 | Promise | 刷新项目数据 |
| `checkHealth(projectName)` | projectName: string | Promise | 检查项目健康 |
| `showDetails(projectName)` | projectName: string | void | 显示项目详情 |
| `openConfig(projectName)` | projectName: string | void | 打开项目配置 |

#### 使用示例

```javascript
// 初始化
SubProjectMonitor.init('subProjectContent');

// 检查特定项目健康
await SubProjectMonitor.checkHealth('deep-live-cam');

// 显示项目详情
SubProjectMonitor.showDetails('facefusion');
```

### 4.4 脚本运行器模块（ScriptRunner）

#### 功能描述
管理和执行自动化脚本，支持批量执行和进度跟踪。

#### 核心方法

| 方法 | 参数 | 返回值 | 说明 |
|------|------|--------|------|
| `init()` | containerId?: string | void | 初始化模块 |
| `runScript(scriptName)` | scriptName: string | Promise | 执行脚本 |
| `stopScript(scriptName)` | scriptName: string | Promise | 停止脚本 |
| `runBatch(category)` | category: string | Promise | 批量执行 |
| `showDetails(scriptName)` | scriptName: string | void | 显示脚本详情 |

#### 使用示例

```javascript
// 执行健康检查脚本
await ScriptRunner.runScript('health_check.py');

// 批量执行所有测试脚本
await ScriptRunner.runBatch('test');

// 显示脚本执行详情
ScriptRunner.showDetails('deploy.sh');
```

### 4.5 API接口管理模块（APIInterface）

#### 功能描述
统一封装所有前端API调用，支持请求重试和错误处理。

#### 核心方法

| 方法 | 参数 | 返回值 | 说明 |
|------|------|--------|------|
| `init()` | 无 | void | 初始化模块 |
| `request(endpoint, options)` | endpoint: string, options: object | Promise | 发起请求 |
| `healthCheck()` | 无 | Promise | 健康检查 |
| `getScriptsList()` | 无 | Promise | 获取脚本列表 |
| `getSystemResources()` | 无 | Promise | 获取系统资源 |

#### 使用示例

```javascript
// 初始化
APIInterface.init();

// 发起API请求
const data = await APIInterface.request('health');

// 使用快捷方法
const scripts = await APIInterface.getScriptsList();
const resources = await APIInterface.getSystemResources();
```

### 4.6 健康检查模块（HealthChecker）

#### 功能描述
执行系统健康检查，显示CPU、内存、磁盘等服务状态。

#### 核心方法

| 方法 | 参数 | 返回值 | 说明 |
|------|------|--------|------|
| `init(containerId)` | containerId?: string | void | 初始化模块 |
| `runCheck()` | 无 | Promise | 执行健康检查 |
| `viewLogs()` | 无 | void | 查看检查日志 |
| `getStatus()` | 无 | object | 获取检查状态 |

#### 使用示例

```javascript
// 初始化
HealthChecker.init('healthCheckerContent');

// 执行健康检查
await HealthChecker.runCheck();

// 获取当前状态
const status = HealthChecker.getStatus();
```

### 4.7 系统资源监控模块（SystemResources）

#### 功能描述
实时监控系统资源使用情况，包括CPU、内存、磁盘等。

#### 核心方法

| 方法 | 参数 | 返回值 | 说明 |
|------|------|--------|------|
| `init(containerId)` | containerId?: string | void | 初始化模块 |
| `refresh()` | 无 | Promise | 刷新数据 |
| `getStatus()` | 无 | object | 获取资源状态 |

#### 使用示例

```javascript
// 初始化
SystemResources.init('systemResourcesContent');

// 刷新数据
await SystemResources.refresh();

// 获取当前状态
const status = SystemResources.getStatus();
```

### 4.8 弹窗栈管理模块（ModalStackManager）

#### 功能描述
管理嵌套弹窗的层级、事件冒泡和数据传递。

#### 核心方法

| 方法 | 参数 | 返回值 | 说明 |
|------|------|--------|------|
| `init()` | 无 | void | 初始化模块 |
| `createModalWithStopPropagation(options)` | options: object | string | 创建防冒泡弹窗 |
| `closeAll()` | 无 | void | 关闭所有弹窗 |
| `closeTo(modalId)` | modalId: string | void | 关闭到指定弹窗 |
| `setModalData(modalId, key, value)` | modalId, key, value | void | 设置弹窗数据 |
| `getModalData(modalId, key)` | modalId, key | any | 获取弹窗数据 |

#### 使用示例

```javascript
// 初始化
ModalStackManager.init();

// 创建带事件阻止的弹窗
ModalStackManager.createModalWithStopPropagation({
    title: '确认操作',
    content: '确定要执行此操作吗？',
    onConfirm: () => console.log('确认')
});

// 设置弹窗间传递的数据
ModalStackManager.setModalData('modal-1', 'userData', { id: 1, name: '张三' });

// 关闭所有弹窗
ModalStackManager.closeAll();
```

### 4.9 表单验证模块（FormValidator）

#### 功能描述
提供前后端表单验证，防止XSS和注入攻击。

#### 核心方法

| 方法 | 参数 | 返回值 | 说明 |
|------|------|--------|------|
| `init()` | 无 | void | 初始化模块 |
| `validate(value, rules)` | value: any, rules: string[] | object | 验证单个值 |
| `validateForm(formData, schema)` | formData: object, schema: object | object | 验证整个表单 |
| `sanitize(input)` | input: string | string | 清理输入（防XSS） |
| `createValidator(formId)` | formId: string | object | 创建表单验证器 |

#### 使用示例

```javascript
// 初始化
FormValidator.init();

// 验证单个值
const result = FormValidator.validate('test@example.com', ['required', 'email']);

// 验证整个表单
const formResult = FormValidator.validateForm({
    email: 'test@example.com',
    phone: '13800138000'
}, {
    email: ['required', 'email'],
    phone: ['required', 'phone']
});

// 清理用户输入
const sanitized = FormValidator.sanitize(userInput);

// 创建表单验证器
const validator = FormValidator.createValidator('myForm');
validator.addField('username', ['required', 'minLength:3']);
const isValid = validator.validateField('username', inputValue);
```

### 4.10 缓存管理模块（CacheManager）

#### 功能描述
管理应用缓存，防止缓存冲突和过期。

#### 核心方法

| 方法 | 参数 | 返回值 | 说明 |
|------|------|--------|------|
| `init()` | 无 | void | 初始化模块 |
| `set(key, value, expiration?)` | key, value, expiration? | boolean | 设置缓存 |
| `get(key)` | key | any | 获取缓存 |
| `remove(key)` | key | boolean | 删除缓存 |
| `has(key)` | key | boolean | 检查缓存是否存在 |
| `clear()` | 无 | void | 清空所有缓存 |
| `cleanup()` | 无 | number | 清理过期缓存 |
| `size()` | 无 | number | 获取缓存大小 |

#### 使用示例

```javascript
// 初始化
CacheManager.init();

// 设置缓存（默认5分钟过期）
CacheManager.set('userData', { id: 1, name: '张三' });

// 设置缓存（1小时后过期）
CacheManager.set('config', settings, CacheManager.config.longExpiration);

// 获取缓存
const data = CacheManager.get('userData');

// 检查缓存是否存在
if (CacheManager.has('userData')) {
    // 使用缓存数据
}

// 清理过期缓存
CacheManager.cleanup();

// 清空所有缓存
CacheManager.clear();
```

### 4.11 懒加载模块（LazyLoader）

#### 功能描述
实现资源的动态加载和懒加载，支持按需加载。

#### 核心方法

| 方法 | 参数 | 返回值 | 说明 |
|------|------|--------|------|
| `init()` | 无 | void | 初始化模块 |
| `loadResource(target, type)` | target, type | Promise | 加载资源 |
| `loadScript(moduleName)` | moduleName | Promise | 加载脚本 |
| `loadStylesheet(cssName)` | cssName | Promise | 加载样式 |
| `preload(targets)` | targets: string[] | Promise | 预加载资源 |
| `observe(element)` | element | void | 观察元素（懒加载） |
| `getLoadedModules()` | 无 | string[] | 获取已加载模块 |

#### 使用示例

```javascript
// 初始化
LazyLoader.init();

// 预加载模块
LazyLoader.preload(['portMapping', 'bubbleMonitor']);

// 动态加载脚本
await LazyLoader.loadScript('healthChecker');

// 动态加载样式
await LazyLoader.loadStylesheet('monitor');

// 获取已加载模块列表
const loaded = LazyLoader.getLoadedModules();
```

### 4.12 分页控制器模块（Pagination）

#### 功能描述
管理数据分页和排序，提供分页UI组件。

#### 核心方法

| 方法 | 参数 | 返回值 | 说明 |
|------|------|--------|------|
| `init(containerId)` | containerId?: string | Pagination | 初始化模块 |
| `setOptions(options)` | options: object | Pagination | 设置参数 |
| `setData(data, totalItems?)` | data, totalItems? | Pagination | 设置数据 |
| `goToPage(page)` | page: number | boolean | 跳转到指定页 |
| `nextPage()` | 无 | boolean | 下一页 |
| `prevPage()` | 无 | boolean | 上一页 |
| `sort(field, direction)` | field, direction | Pagination | 排序 |
| `render()` | 无 | void | 渲染分页控件 |
| `refresh()` | 无 | object | 刷新 |

#### 使用示例

```javascript
// 初始化
const pager = Pagination.init('paginationContent');

// 设置参数
pager.setOptions({ pageSize: 20 });

// 设置数据
pager.setData([
    { id: 1, name: '项目1' },
    { id: 2, name: '项目2' }
], 100); // 100条数据

// 翻页
pager.goToPage(3);
pager.nextPage();
pager.prevPage();

// 排序
pager.sort('name', 'asc');

// 渲染
pager.render();

// 获取当前页数据
const currentData = pager.getCurrentPageData();

// 获取分页信息
const info = pager.getPageInfo();
```

---

## 五、API端点说明

### 5.1 基础端点

| 端点 | 方法 | 说明 |
|------|------|------|
| `/api/health` | GET | 系统健康检查 |
| `/api/project/status` | GET | 项目整体状态 |
| `/api/system/resources` | GET | 系统资源使用情况 |

### 5.2 脚本相关端点

| 端点 | 方法 | 说明 |
|------|------|------|
| `/api/scripts/list` | GET | 获取脚本列表 |
| `/api/scripts/status` | GET | 获取脚本运行状态 |
| `/api/scripts/run/{script_name}` | POST | 运行指定脚本 |
| `/api/scripts/stop/{script_name}` | POST | 停止指定脚本 |
| `/api/scripts/execute/{script_name}` | POST | 执行脚本 |
| `/api/logs/{script_name}` | GET | 获取脚本日志 |

### 5.3 配置相关端点

| 端点 | 方法 | 说明 |
|------|------|------|
| `/api/config/{component}` | GET | 获取组件配置 |
| `/api/config/{component}` | POST | 更新组件配置 |

### 5.4 监控相关端点

| 端点 | 方法 | 说明 |
|------|------|------|
| `/api/ports` | GET | 端口状态列表 |
| `/api/subprojects` | GET | 子项目状态 |
| `/api/deployment/progress` | GET | 部署进度 |
| `/api/bubbles` | GET | 实时冒泡数据 |
| `/api/bubbles/history` | GET | 历史冒泡记录 |
| `/api/mapping` | GET | API端点映射 |

### 5.5 WebSocket端点

| 端点 | 说明 |
|------|------|
| `/ws/monitoring` | 监控WebSocket连接 |

---

## 六、用户交互说明

### 6.1 主界面布局

```
┌─────────────────────────────────────────────────────────────┐
│ 导航栏：项目名称 | 系统状态 | 连接状态 | 时间 | 操作菜单    │
├──────────────┬──────────────────────────────────────────────┤
│              │                                              │
│  侧边栏      │              主内容区                         │
│  · 系统概览  │  ┌────────────────────────────────────────┐  │
│  · CPU/Memory│  │ 全局监控面板                            │  │
│  · 服务状态  │  └────────────────────────────────────────┘  │
│              │  ┌────────────────────────────────────────┐  │
│  快速导航    │  │ 部署进度面板                            │  │
│  · 全局监控  │  └────────────────────────────────────────┘  │
│  · 部署进度  │  ┌────────────────────────────────────────┐  │
│  · 模块状态  │  │ 模块状态面板                            │  │
│  · 脚本控制  │  └────────────────────────────────────────┘  │
│  · 配置管理  │  ┌────────────────────────────────────────┐  │
│  · 日志查看  │  │ 脚本控制面板                            │  │
│              │  └────────────────────────────────────────┘  │
│              │  ┌────────────────────────────────────────┐  │
│              │  │ 配置管理面板                            │  │
│              │  └────────────────────────────────────────┘  │
│              │  ┌────────────────────────────────────────┐  │
│              │  │ 日志查看面板                            │  │
│              │  └────────────────────────────────────────┘  │
└──────────────┴──────────────────────────────────────────────┘
```

### 6.2 键盘快捷键

| 快捷键 | 功能 |
|--------|------|
| Ctrl + R | 刷新全部 |
| Ctrl + H | 健康检查 |
| Ctrl + S | 保存配置 |

### 6.3 冒泡通知类型

| 类型 | 图标 | 颜色 | 用途 |
|------|------|------|------|
| success | ✓ | 绿色 | 操作成功 |
| error | ✕ | 红色 | 错误信息 |
| warning | ⚠ | 黄色 | 警告信息 |
| info | ℹ | 蓝色 | 一般信息 |
| progress | ⟳ | 蓝色 | 进度显示 |

---

## 七、常见问题

### 7.1 启动问题

**Q: 端口被占用**
```bash
# 查看占用端口的进程
lsof -i :8080

# 或使用
netstat -tlnp | grep 8080

# 终止进程
kill <PID>
```

**Q: 依赖安装失败**
```bash
# 升级pip
pip3 install --upgrade pip

# 单独安装失败依赖
pip3 install fastapi uvicorn python-socketio
```

### 7.2 功能问题

**Q: WebSocket连接失败**
- 检查浏览器控制台错误
- 确认后端服务正常运行
- 检查CORS配置

**Q: 页面加载缓慢**
- 检查网络连接
- 确认静态资源路径正确
- 清理浏览器缓存

### 7.3 调试方法

```bash
# 开启调试模式
python3 web/app.py --host 0.0.0.0 --port 8080 --reload

# 查看日志
tail -f logs/web_app.log

# 检查健康状态
curl http://localhost:8080/api/health
```

---

## 八、后续优化建议

### 8.1 功能扩展
- 添加用户认证和权限管理
- 实现数据导出功能（Excel/CSV）
- 添加数据可视化图表
- 实现多语言支持

### 8.2 性能优化
- 实现服务端渲染
- 添加CDN加速
- 优化数据库查询
- 实现缓存层

### 8.3 安全增强
- 添加API认证
- 实现请求限流
- 增强XSS防护
- 添加审计日志

---

## 九、相关文档

| 文档 | 路径 |
|------|------|
| 项目主文档 | `docs/docs_README.md` |
| 部署进度 | `docs/deployment_progress/37-全项目健康监控部署.md` |
| 任务清单 | `TODO.md` |
| 启动脚本 | `start.sh` |

---

*文档更新时间: 2026-01-19*
*版本: 1.0.0*
