# 21. 前端UI结构部署任务

## 任务概述
根据 docs/待部署内容/本项目my ai popup project.txt、docs/待部署内容/功能模块详解与子功能扩展 1 启动摄像头.txt、docs/待部署内容/功能内容弹窗窗口结构与功能说明 1 弹窗整体布局.txt、docs/待部署内容/主界面功能模块.txt 中的详细描述，实现前端用户使用的桌面窗口框架。

## 模块职责
- **选择功能区**: 负责文件类型选择（图片/视频/摄像头），参数识别和预备区域呈现。职责单一：用户输入收集和初步验证。
- **AI学习区域**: 管理本地AI选择、下载、学习进度显示。职责单一：AI模型管理，不涉及处理逻辑。
- **任务部署区域**: 处理简单/高级模式切换，参数配置。职责单一：任务配置，不直接调用AI或处理引擎。
- **反馈区域**: 显示任务结果预览。职责单一：结果展示，不参与处理逻辑。
- **摄像头管理模块**: 启动/停止摄像头，配置虚拟摄像头，设置摄像头权限。职责单一：摄像头设备管理。
- **图片识别与合成模块**: 图片识别参数配置，图片合成到视频/虚拟摄像头。职责单一：图像合成参数管理。
- **AI配置与训练模块**: 开启/关闭AI模型，AI训练功能。职责单一：AI模型状态管理。
- **视频插入与合成模块**: 向虚拟摄像头或实时视频中插入视频片段。职责单一：视频插入配置。
- **实时视频流显示模块**: 显示视频流与合成图像，支持图像、视频、虚拟背景预览。职责单一：视频显示。

## 详细部署说明

### 1. 窗口框架搭建
- 创建主窗口类 `MainWindow` 继承 PyQt5 的 QMainWindow
- 布局使用 QVBoxLayout 和 QHBoxLayout 实现四个区域划分
- 每个区域使用独立的 QWidget 子类封装
- 弹窗整体布局结构：
  ```
  +----------------------------------------------------------+
  |                   AR 合成应用功能配置                    |
  +----------------------------------------------------------+
  | 1. 启动摄像头                 [按钮]                       |
  | 2. 设置摄像头权限            [按钮]                       |
  | 3. 选择虚拟摄像头            [下拉框: 默认摄像头]           |
  | 4. 图片识别设置              [按钮]                       |
  | 5. 图片合成到视频            [按钮]                       |
  | 6. 图片合成到虚拟摄像头      [按钮]                       |
  | 7. 视频插入到虚拟摄像头      [按钮]                       |
  | 8. AI 配置与训练             [按钮]                       |
  | 9. 截图保存                  [按钮]                       |
  +----------------------------------------------------------+
  |                        视频流预览区域                   |
  |  +----------------------------------------------+       |
  |  |                                              |       |
  |  |                                              |       |
  |  |                实时视频流显示                  |       |
  |  |                                              |       |
  |  +----------------------------------------------+       |
  +----------------------------------------------------------+
  |                 确认 [按钮]      关闭 [按钮]             |
  +----------------------------------------------------------+
  ```

### 2. 摄像头管理模块实现
2.1 启动摄像头（按钮）
- 点击启动摄像头，显示实时视频流
- 通过 Deep-Live-Cam 处理实时摄像头输入
- 启动前检测摄像头是否被其他应用占用
- 子功能：启动前检查摄像头权限，启动成功后显示视频流，提供停止摄像头功能
- 代码示例：
```python
def start_camera(self):
    """启动摄像头并显示实时视频流"""
    self.cap = cv2.VideoCapture(0)
    if not self.cap.isOpened():
        messagebox.showerror("错误", "无法打开摄像头！")
        return
    self.is_camera_running = True
    self.update_video_stream()
```

2.2 设置摄像头权限（按钮）
- 检查并提示用户是否已授予摄像头权限
- 没有权限时弹出提示并引导用户进行权限设置
- 代码示例：
```python
def set_permissions(self):
    """检查并提示用户开启摄像头权限"""
    messagebox.showinfo("权限提示", "请确保应用已获得摄像头权限。")
```

2.3 选择虚拟摄像头（下拉框）
- 允许用户从下拉框中选择虚拟摄像头设备（如 OBS Studio 创建的虚拟摄像头）
- 选择后切换至虚拟摄像头并通过该虚拟摄像头输出视频流
- 子功能：加载当前系统中可用的虚拟摄像头，自动检测并设置虚拟摄像头为输出设备
- 代码示例：
```python
def select_virtual_camera(self):
    """选择虚拟摄像头并设置输出"""
    virtual_cameras = ["虚拟摄像头 1", "虚拟摄像头 2"]
    self.virtual_camera_combobox['values'] = virtual_cameras
```

### 3. 图片识别与合成模块实现
3.1 图片识别设置（按钮）
- 用户可以选择不同的识别模型（人脸识别、物体识别）来增强视频效果
- 设置后开始识别并显示识别结果
- 子功能：选择识别模型，选择识别模式（实时面部识别、物体识别等）
- 代码示例：
```python
def setup_image_recognition(self):
    """配置图片识别功能"""
    messagebox.showinfo("选择识别模型", "请选择图像识别模型：人脸识别/物体识别等")
```

3.2 图片合成到视频（按钮）
- 将用户选择的图片合成到视频流中，设置合成的区域、大小和透明度
- 合成后的视频流实时显示
- 子功能：用户选择图片文件，设置合成区域（如人脸区域）及合成透明度
- 代码示例：
```python
def combine_image_to_video(self):
    """将图片合成到视频流"""
    image_file = filedialog.askopenfilename(filetypes=[("Image files", "*.png;*.jpg")])
    if image_file:
        image = cv2.imread(image_file)
        # 在视频流中合成图片
        frame[y_offset:y_offset+image.shape[0], x_offset:x_offset+image.shape[1]] = image
```

3.3 图片合成到虚拟摄像头（按钮）
- 用户选择将图片合成到虚拟摄像头的输出中
- 其他应用通过虚拟摄像头获取合成后的实时视频流
- 子功能：通过虚拟摄像头输出合成后的图像，支持对图像进行动态合成
- 代码示例：
```python
def combine_to_virtual_camera(self):
    """将合成后的图像输出到虚拟摄像头"""
    frame_with_bg = Deep_Live_Cam.apply_virtual_background(frame)  # 替换背景
    self.virtual_camera.send(frame_with_bg)  # 输出到虚拟摄像头
```

### 4. AI配置与训练模块实现
4.1 开启/关闭AI模型
- 用户可以选择是否启动内置的AI模型（如ollama）
- 用于实时图像识别、深度学习等任务
- 预集成ollama安装方式，不直接安装，进行占位预留，后续可扩展其他AI模型

4.2 开启/关闭AI训练
- 如果选择开启AI训练，用户需要安装训练所需的库（TensorFlow、PyTorch）
- 下载并准备训练数据，支持一键安装和启动训练
- 训练完成后可通过新模型优化图像合成效果

### 5. 视频插入与合成模块实现
5.1 视频插入到虚拟摄像头（按钮）
- 用户可以选择将本地视频文件插入到视频流中
- 插入后的视频实时显示并输出到虚拟摄像头
- 子功能：用户选择视频文件，设置视频插入的区域和透明度
- 支持视频透明度调整，支持视频帧率与实时视频流的匹配
- 代码示例：
```python
def insert_video_to_virtual_camera(self):
    """插入视频到虚拟摄像头"""
    video_file = filedialog.askopenfilename(filetypes=[("Video files", "*.mp4;*.avi")])
    if video_file:
        video_cap = cv2.VideoCapture(video_file)
        while video_cap.isOpened():
            ret, video_frame = video_cap.read()
            if ret:
                frame = combine_with_video(frame, video_frame)  # 合成视频
                self.virtual_camera.send(frame)
```

### 6. 截图保存模块实现
- 用户可以选择保存当前视频流的截图
- 支持选择文件保存路径和文件格式（PNG、JPEG）
- 代码示例：
```python
def save_screenshot(self):
    """保存截图"""
    ret, frame = self.cap.read()
    if ret:
        save_path = filedialog.asksaveasfilename(defaultextension=".png", filetypes=[("PNG files", "*.png")])
        if save_path:
            cv2.imwrite(save_path, frame)
```

### 7. 视频流预览区域
- 展示当前摄像头的实时视频流及用户配置的合成效果
- 实时显示图像合成、虚拟背景等
- 支持图像、视频、虚拟背景和其他合成内容的预览

### 8. 选择功能区实现（简单/高级模式）
- 添加文件类型选择下拉框（图片/视频/摄像头）
- 实现文件选择按钮和路径显示
- 自动识别文件参数并显示在预备区域
- 简单模式：选择次要文件类型，直接调用引擎
- 高级模式：自然语言输入框，AI理解分析

### 9. 任务部署区域实现
- 简单模式：用户选择次要合成文件类型，直接进行合成
- 高级模式：用户仅选择主要文件后与AI产生自然语言交流，让AI深度理解分析识别输入的任务内容
- 根据主要参数与任务要求，结合所有引擎和学习库创造出合成内容

### 10. AI学习区域实现
- 本地AI模型列表显示
- 下载按钮和进度条
- 学习说明和进度反馈
- 预留所有可选学习内容及学习说明

### 11. 反馈区域实现
- 实时预览窗口
- 任务进度显示
- 结果展示

### 12. 预留接口
- 自然语言输入预留
- API调用接口预留
- 扩展功能占位符

## 依赖关系
- 不直接依赖后端处理模块
- 通过API接口与后端通信
- 避免与AI模块直接耦合
- 各模块独立，无隐式依赖

## 联动检查点
- 修改摄像头逻辑 → 检查 processing / utils
- 修改AI命令 → 检查 rules / task_manager
- 修改UI交互 → 检查 API / task状态
- 修改模型参数 → 检查 config / docs

## 测试验证
- 窗口布局正确显示
- 各区域功能独立
- 模式切换正常
- 接口预留可用
- 摄像头启动/停止正常
- 虚拟摄像头切换正常
- 图片/视频合成功能正常
- AI配置功能正常

## 验收标准
- 窗口结构清晰，四个区域职责分明
- 无功能重叠或隐式依赖
- 支持简单/高级模式切换
- 预留扩展接口完整
- 摄像头管理功能完整
- 图片/视频合成功能完整
- AI配置功能完整

