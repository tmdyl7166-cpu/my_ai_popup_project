# 接口映射表

## 模块调用关系图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         前端应用层 (app.js)                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                     组件层 (components/)                         │    │
│  │  Charting ←→ Progress ←→ Spinner ←→ Toast ←→ WS               │    │
│  │     │           │            │           │        │               │    │
│  │     │           │            │           │        │               │    │
│  │     └───────────┴────────────┴───────────┴────────┘               │    │
│  │                              │                                      │    │
│  │                     提供可视化、数据展示                            │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                              │                                           │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                     工具层 (utils/)                               │    │
│  │  EventBus ←→ SafeUtils ←→ ErrorHandler ←→ API ←→ ModalStack    │    │
│  │     │           │              │            │          │           │    │
│  │     │           │              │            │          │           │    │
│  │     │           │              │            │          │           │    │
│  │     └───────────┴──────────────┴────────────┴──────────┘           │    │
│  │                              │                                      │    │
│  │                     ThemeManager ←→ DynamicMenu                    │    │
│  │                              │                                      │    │
│  │              提供安全、事件、通信、UI管理                            │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                              │                                           │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                     功能模块层 (modules/)                         │    │
│  │  GlobalMonitor ←→ DeploymentProgress ←→ ModuleStatus            │    │
│  │  ScriptControl ←→ ConfigManagement ←→ LogsViewer                │    │
│  │  PortMapping ←→ BubbleMonitor ←→ VideoStreamMonitor             │    │
│  │  ... (更多功能模块)                                               │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                              │                                           │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                     后端API层 (web/app.py)                        │    │
│  │  /api/health ←→ /api/project/status ←→ /api/scripts/*           │    │
│  │  /api/system/* ←→ /api/ports ←→ /api/subprojects ←→ /api/video/*│    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

## 组件接口 (components/)

### Charting 图表组件

| 方法                                              | 参数                               | 返回值    | 说明         |
| ------------------------------------------------- | ---------------------------------- | --------- | ------------ |
| `createLineChart(canvasId, config)`               | canvasId: string, config: object   | Chart实例 | 创建折线图   |
| `createBarChart(canvasId, config)`                | canvasId: string, config: object   | Chart实例 | 创建柱状图   |
| `createPieChart(canvasId, config)`                | canvasId: string, config: object   | Chart实例 | 创建饼图     |
| `updateChart(canvasId, newData)`                  | canvasId: string, newData: object  | void      | 更新图表数据 |
| `addDataPoint(canvasId, label, value, maxPoints)` | 多个                               | void      | 添加数据点   |
| `destroyChart(canvasId)`                          | canvasId: string                   | void      | 销毁图表     |
| `exportChart(canvasId, filename)`                 | canvasId: string, filename: string | void      | 导出图表     |

### Progress 进度条组件

| 方法                                            | 参数                                | 返回值           | 说明             |
| ----------------------------------------------- | ----------------------------------- | ---------------- | ---------------- |
| `createSimple(containerId, config)`             | containerId: string, config: object | ProgressBar      | 创建简单进度条   |
| `setValue(barId, percent)`                      | barId: string, percent: number      | void             | 设置进度值       |
| `increment(barId, delta)`                       | barId: string, delta: number        | number           | 增加进度         |
| `setType(barId, type)`                          | barId: string, type: string         | void             | 设置类型         |
| `createMultiStage(containerId, stages, config)` | 多个                                | MultiStage       | 创建多阶段进度条 |
| `createCircular(containerId, config)`           | containerId: string, config: object | CircularProgress | 创建环形进度条   |

### Spinner 加载动画组件

| 方法                                  | 参数                                | 返回值  | 说明             |
| ------------------------------------- | ----------------------------------- | ------- | ---------------- |
| `createBorder(containerId, config)`   | containerId: string, config: object | Spinner | 创建旋转加载器   |
| `createGrow(containerId, config)`     | containerId: string, config: object | Spinner | 创建脉冲加载器   |
| `createDots(containerId, config)`     | containerId: string, config: object | Spinner | 创建圆点加载器   |
| `createBars(containerId, config)`     | containerId: string, config: object | Spinner | 创建条形加载器   |
| `createWithText(containerId, config)` | containerId: string, config: object | Spinner | 创建文字加载提示 |
| `createOverlay(config)`               | config: object                      | Overlay | 创建全屏遮罩     |
| `showGlobal(message)`                 | message: string                     | Overlay | 显示全局加载     |
| `hideGlobal()`                        | -                                   | void    | 隐藏全局加载     |

### Toast 通知组件

| 方法                               | 参数            | 返回值  | 说明           |
| ---------------------------------- | --------------- | ------- | -------------- |
| `init(config)`                     | config: object  | void    | 初始化         |
| `success(title, message, options)` | 多个            | toastId | 显示成功提示   |
| `error(title, message, options)`   | 多个            | toastId | 显示错误提示   |
| `warning(title, message, options)` | 多个            | toastId | 显示警告提示   |
| `info(title, message, options)`    | 多个            | toastId | 显示信息提示   |
| `show(options)`                    | options: object | toastId | 显示自定义提示 |
| `hide(toastId)`                    | toastId: string | void    | 隐藏Toast      |
| `hideAll()`                        | -               | void    | 隐藏所有       |
| `confirm(options)`                 | options: object | Promise | 显示确认框     |

### WS WebSocket组件

| 方法                                  | 参数                                | 返回值     | 说明     |
| ------------------------------------- | ----------------------------------- | ---------- | -------- |
| `init(options)`                       | options: object                     | void       | 初始化   |
| `connect()`                           | -                                   | Promise    | 建立连接 |
| `disconnect()`                        | -                                   | void       | 关闭连接 |
| `send(data)`                          | data: any                           | boolean    | 发送消息 |
| `subscribeProgress(taskId, callback)` | taskId: string, callback: function  | function   | 订阅进度 |
| `subscribeLogs(taskId, callback)`     | taskId: string, callback: function  | function   | 订阅日志 |
| `subscribeData(channel, callback)`    | channel: string, callback: function | function   | 订阅数据 |
| `subscribeTask(taskId, callbacks)`    | taskId: string, callbacks: object   | function   | 订阅任务 |
| `connectPipelineWS(taskId)`           | taskId: string                      | PipelineWS | 快捷连接 |

## 工具接口 (utils/)

### EventBus 事件总线

| 方法                           | 参数                                               | 返回值         | 说明             |
| ------------------------------ | -------------------------------------------------- | -------------- | ---------------- |
| `on(event, callback, options)` | event: string, callback: function, options: object | subscriptionId | 订阅事件         |
| `off(event, subscriptionId)`   | event: string, subscriptionId: string              | void           | 取消订阅         |
| `offAll(event)`                | event: string                                      | void           | 取消所有订阅     |
| `emit(event, data)`            | event: string, data: any                           | void           | 触发事件         |
| `once(event, callback)`        | event: string, callback: function                  | subscriptionId | 一次性订阅       |
| `listenerCount(event)`         | event: string                                      | number         | 获取监听者数量   |
| `hasListeners(event)`          | event: string                                      | boolean        | 检查是否有监听者 |

### SafeUtils 安全工具

| 方法                               | 参数                           | 返回值  | 说明          |
| ---------------------------------- | ------------------------------ | ------- | ------------- |
| `escapeHtml(str)`                  | str: string                    | string  | HTML转义      |
| `unescapeHtml(str)`                | str: string                    | string  | HTML反转义    |
| `xss(str, options)`                | str: string, options: object   | string  | XSS过滤       |
| `sanitizeHtml(html, options)`      | html: string, options: object  | string  | 清理富文本    |
| `safeJsonParse(str, defaultValue)` | str: string, defaultValue: any | any     | JSON安全解析  |
| `safeTemplate(template, data)`     | template: string, data: object | string  | 安全模板渲染  |
| `generateToken(length)`            | length: number                 | string  | 生成随机令牌  |
| `generateCsrfToken()`              | -                              | string  | 生成CSRF令牌  |
| `getCsrfToken()`                   | -                              | string  | 获取CSRF令牌  |
| `validateCsrfToken(token)`         | token: string                  | boolean | 验证CSRF令牌  |
| `isSafeUrl(url)`                   | url: string                    | boolean | 验证URL安全性 |

### ErrorHandler 错误处理

| 方法                             | 参数                             | 返回值   | 说明         |
| -------------------------------- | -------------------------------- | -------- | ------------ |
| `init(config)`                   | config: object                   | void     | 初始化       |
| `create(message, options)`       | message: string, options: object | Error    | 创建错误对象 |
| `throw(message, options)`        | message: string, options: object | void     | 抛出错误     |
| `wrap(fn, context)`              | fn: function, context: object    | function | 包装异步函数 |
| `getCachedErrors()`              | -                                | Array    | 获取缓存错误 |
| `clearCache()`                   | -                                | void     | 清除缓存     |
| `manualReport(message, details)` | message: string, details: object | void     | 手动报告     |

### API 统一API封装

| 方法                                     | 参数            | 返回值  | 说明          |
| ---------------------------------------- | --------------- | ------- | ------------- |
| `init(options)`                          | options: object | void    | 初始化        |
| `setToken(token)`                        | token: string   | void    | 设置认证token |
| `clearToken()`                           | -               | void    | 清除认证token |
| `request(options)`                       | options: object | Promise | 发起请求      |
| `get(url, params, options)`              | 多个            | Promise | GET请求       |
| `post(url, data, options)`               | 多个            | Promise | POST请求      |
| `put(url, data, options)`                | 多个            | Promise | PUT请求       |
| `patch(url, data, options)`              | 多个            | Promise | PATCH请求     |
| `delete(url, options)`                   | 多个            | Promise | DELETE请求    |
| `upload(url, file, onProgress, options)` | 多个            | Promise | 文件上传      |
| `all(requests)`                          | requests: Array | Promise | 批量请求      |
| `race(requests)`                         | requests: Array | Promise | 竞速请求      |

### ModalStack 弹窗管理

| 方法                        | 参数                             | 返回值  | 说明         |
| --------------------------- | -------------------------------- | ------- | ------------ |
| `init()`                    | -                                | void    | 初始化       |
| `open(options)`             | options: object                  | string  | 打开弹窗     |
| `close(id)`                 | id: string                       | void    | 关闭弹窗     |
| `closeTop()`                | -                                | void    | 关闭顶部弹窗 |
| `closeAll()`                | -                                | void    | 关闭所有弹窗 |
| `get(id)`                   | id: string                       | Modal   | 获取弹窗     |
| `getTop()`                  | -                                | Modal   | 获取顶部弹窗 |
| `getCount()`                | -                                | number  | 获取数量     |
| `has(id)`                   | id: string                       | boolean | 检查是否存在 |
| `alert(message, options)`   | message: string, options: object | string  | 警告框       |
| `confirm(message, options)` | message: string, options: object | Promise | 确认框       |
| `msg(message, options)`     | message: string, options: object | string  | 提示框       |
| `loading(message)`          | message: string                  | number  | 加载层       |

### ThemeManager 主题管理

| 方法                              | 参数                | 返回值  | 说明         |
| --------------------------------- | ------------------- | ------- | ------------ |
| `init()`                          | -                   | void    | 初始化       |
| `setTheme(theme)`                 | theme: string       | boolean | 设置主题     |
| `toggleTheme()`                   | -                   | boolean | 切换主题     |
| `getTheme()`                      | -                   | string  | 获取当前主题 |
| `getThemeConfig(theme)`           | theme: string       | object  | 获取主题配置 |
| `getAllThemes()`                  | -                   | Array   | 获取所有主题 |
| `createToggleButton(containerId)` | containerId: string | void    | 创建切换按钮 |
| `addThemeStyles()`                | -                   | void    | 添加主题样式 |

### DynamicMenu 动态菜单

| 方法                          | 参数                            | 返回值  | 说明         |
| ----------------------------- | ------------------------------- | ------- | ------------ |
| `init(options)`               | options: object                 | void    | 初始化       |
| `loadMenu()`                  | -                               | Promise | 加载菜单     |
| `render(containerId)`         | containerId: string             | void    | 渲染菜单     |
| `setActive(menuId)`           | menuId: string                  | void    | 设置激活状态 |
| `addItem(parentId, item)`     | parentId: string, item: object  | boolean | 添加菜单项   |
| `removeItem(itemId)`          | itemId: string                  | boolean | 移除菜单项   |
| `updateItem(itemId, updates)` | itemId: string, updates: object | boolean | 更新菜单项   |
| `updateBadge(itemId, badge)`  | itemId: string, badge: object   | boolean | 更新徽章     |
| `getMenuData()`               | -                               | Array   | 获取菜单数据 |
| `refresh()`                   | -                               | void    | 刷新菜单     |

## 后端API端点 (web/app.py)

| 端点                        | 方法 | 说明             |
| --------------------------- | ---- | ---------------- |
| `/api/health`               | GET  | 系统健康检查     |
| `/api/project/status`       | GET  | 项目整体状态     |
| `/api/scripts/list`         | GET  | 获取脚本列表     |
| `/api/scripts/status`       | GET  | 获取脚本运行状态 |
| `/api/system/resources`     | GET  | 系统资源使用情况 |
| `/api/system/gpu`           | GET  | GPU资源使用情况  |
| `/api/ports`                | GET  | 端口状态列表     |
| `/api/subprojects`          | GET  | 子项目状态       |
| `/api/bubbles`              | GET  | 实时冒泡数据     |
| `/api/audit/logs`           | GET  | 审计日志查询     |
| `/api/audit/export`         | GET  | 审计日志导出     |
| `/api/performance`          | GET  | 性能监控概览     |
| `/api/performance/metrics`  | GET  | 性能指标数据     |
| `/api/performance/optimize` | POST | 性能优化执行     |
| `/api/video`                | GET  | 视频流概览       |
| `/api/video/cameras`        | GET  | 摄像头设备       |
| `/api/video/streams`        | GET  | 视频流数据       |
| `/api/video/engines`        | GET  | 引擎状态         |
| `/api/engines`              | GET  | 引擎列表         |
| `/api/engines/:name/status` | GET  | 引擎状态         |
| `/api/engines/:name/start`  | POST | 启动引擎         |
| `/api/engines/:name/stop`   | POST | 停止引擎         |

## 模块初始化顺序

```
1. utils/eventBus.js      - 事件总线（无依赖）
2. utils/safeUtils.js     - 安全工具（无依赖）
3. utils/errorHandler.js  - 错误处理（无依赖）
4. components/charting.js - 图表组件（无依赖）
5. components/progress.js - 进度条（无依赖）
6. components/spinner.js  - 加载动画（无依赖）
7. components/toast.js    - 通知提示（无依赖）
8. utils/api.js           - API封装（依赖eventBus）
9. utils/modalStack.js    - 弹窗管理（依赖eventBus）
10. utils/themeManager.js  - 主题管理（依赖eventBus）
11. utils/dynamicMenu.js   - 动态菜单（依赖eventBus）
12. components/ws.js       - WebSocket（依赖eventBus, API）
13. modules/*              - 功能模块（依赖以上所有）
14. app.js                 - 应用入口（整合所有模块）
```

## 事件常量

```javascript
EventBus.EVENTS = {
  APP_INIT: "app:init",
  APP_READY: "app:ready",
  APP_ERROR: "app:error",
  MODULE_LOADED: "module:loaded",
  DATA_UPDATED: "data:updated",
  UI_REFRESH: "ui:refresh",
  UI_THEME_CHANGE: "ui:theme:change",
  NETWORK_ONLINE: "network:online",
  NETWORK_OFFLINE: "network:offline",
  API_SUCCESS: "api:success",
  API_ERROR: "api:error",
  WS_CONNECTED: "ws:connected",
  WS_DISCONNECTED: "ws:disconnected",
  MODAL_OPENED: "modal:opened",
  MODAL_CLOSED: "modal:closed",
};
```

---

_文档更新时间: 2026-01-19_
_版本: 1.0.0_
