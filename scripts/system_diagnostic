#!/bin/bash
#===============================================================================
# my_ai_popup_project 系统诊断工具
# 功能: 全面诊断系统状态和项目运行环境
#===============================================================================

set -euo pipefail

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

echo -e "${BLUE}=========================================="
echo "my_ai_popup_project 系统诊断"
echo "==========================================${NC}"
echo ""

# 获取项目根目录
get_project_root() {
    local script_dir
    script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    echo "$(dirname "$script_dir")"
}

PROJECT_ROOT=$(get_project_root)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# 日志函数
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1" >&2
}

# 收集系统信息
collect_system_info() {
    log_info "收集系统信息..."

    echo "=== 系统信息 ==="
    echo "操作系统: $(uname -s)"
    echo "内核版本: $(uname -r)"
    echo "架构: $(uname -m)"

    if command -v lsb_release &> /dev/null; then
        echo "发行版: $(lsb_release -d | cut -f2)"
    elif [ -f /etc/os-release ]; then
        echo "发行版: $(grep PRETTY_NAME /etc/os-release | cut -d'"' -f2)"
    fi

    echo "主机名: $(hostname)"
    echo "用户: $(whoami)"
    echo "当前时间: $(date)"
    echo ""
}

# 检查硬件资源
check_hardware() {
    log_info "检查硬件资源..."

    echo "=== 硬件资源 ==="

    # CPU信息
    echo "CPU信息:"
    if command -v lscpu &> /dev/null; then
        lscpu | grep -E "(Model name|CPU\(s\)|Thread|Core|Socket)" | head -5
    else
        echo "  处理器: $(grep -c processor /proc/cpuinfo) 核心"
        echo "  型号: $(grep "model name" /proc/cpuinfo | head -1 | cut -d: -f2 | sed 's/^ *//')"
    fi

    # 内存信息
    echo "内存信息:"
    if command -v free &> /dev/null; then
        free -h | grep -E "^(Mem|Swap)"
    else
        echo "  总内存: $(grep MemTotal /proc/meminfo | awk '{print $2/1024/1024 " GB"}')"
        echo "  可用内存: $(grep MemAvailable /proc/meminfo | awk '{print $2/1024/1024 " GB"}')"
    fi

    # 磁盘信息
    echo "磁盘信息:"
    if command -v df &> /dev/null; then
        df -h "$PROJECT_ROOT" | tail -1
    fi

    # GPU信息
    echo "GPU信息:"
    if command -v nvidia-smi &> /dev/null; then
        nvidia-smi --query-gpu=name,memory.total,memory.free --format=csv,noheader,nounits | head -1
    elif command -v lspci &> /dev/null && lspci | grep -i vga | grep -i nvidia &> /dev/null; then
        echo "  NVIDIA GPU检测到，但nvidia-smi不可用"
    else
        echo "  未检测到NVIDIA GPU"
    fi

    echo ""
}

# 检查软件环境
check_software() {
    log_info "检查软件环境..."

    echo "=== 软件环境 ==="

    # Python
    if command -v python3 &> /dev/null; then
        echo "Python3: $(python3 --version)"
        echo "  路径: $(which python3)"
    else
        echo "Python3: 未安装"
    fi

    # pip
    if command -v pip3 &> /dev/null; then
        echo "pip3: $(pip3 --version | cut -d' ' -f2)"
    else
        echo "pip3: 未安装"
    fi

    # Node.js (如果需要)
    if command -v node &> /dev/null; then
        echo "Node.js: $(node --version)"
    fi

    # Git
    if command -v git &> /dev/null; then
        echo "Git: $(git --version)"
    else
        echo "Git: 未安装"
    fi

    # Docker
    if command -v docker &> /dev/null; then
        echo "Docker: $(docker --version)"
    fi

    # 编译工具
    echo "编译工具:"
    for tool in gcc g++ make cmake; do
        if command -v "$tool" &> /dev/null; then
            echo "  $tool: ✓"
        else
            echo "  $tool: ✗"
        fi
    done

    echo ""
}

# 检查项目环境
check_project_environment() {
    log_info "检查项目环境..."

    echo "=== 项目环境 ==="

    # 项目结构
    echo "项目结构检查:"
    required_dirs=("src" "rules" "assets" "docs" "scripts" "web" "logs")
    for dir in "${required_dirs[@]}"; do
        if [ -d "$PROJECT_ROOT/$dir" ]; then
            echo "  $dir/: ✓"
        else
            echo "  $dir/: ✗ (缺失)"
        fi
    done

    # 关键文件
    echo "关键文件检查:"
    required_files=("project_config.json" "requirements.txt" "README.md")
    for file in "${required_files[@]}"; do
        if [ -f "$PROJECT_ROOT/$file" ]; then
            echo "  $file: ✓"
        else
            echo "  $file: ✗ (缺失)"
        fi
    done

    # 虚拟环境
    echo "虚拟环境:"
    venv_path="$PROJECT_ROOT/ai_popup_env"
    if [ -d "$venv_path" ]; then
        echo "  路径: $venv_path"
        if [ -f "$venv_path/bin/activate" ]; then
            echo "  激活脚本: ✓"
        else
            echo "  激活脚本: ✗"
        fi
    else
        echo "  虚拟环境: ✗ (未创建)"
    fi

    echo ""
}

# 检查网络连接
check_network() {
    log_info "检查网络连接..."

    echo "=== 网络连接 ==="

    # 基本连接
    echo "基本连接测试:"
    if ping -c 1 -W 2 8.8.8.8 &> /dev/null; then
        echo "  互联网连接: ✓"
    else
        echo "  互联网连接: ✗"
    fi

    # DNS解析
    if nslookup github.com &> /dev/null; then
        echo "  DNS解析: ✓"
    else
        echo "  DNS解析: ✗"
    fi

    # 关键服务
    echo "关键服务连接:"
    services=(
        "github.com:443:GitHub"
        "pypi.org:443:PyPI"
        "registry-1.docker.io:443:Docker Hub"
    )

    for service in "${services[@]}"; do
        IFS=':' read -r host port name <<< "$service"
        if timeout 5 bash -c "echo > /dev/tcp/$host/$port" 2>/dev/null; then
            echo "  $name: ✓"
        else
            echo "  $name: ✗"
        fi
    done

    echo ""
}

# 检查性能指标
check_performance() {
    log_info "检查性能指标..."

    echo "=== 性能指标 ==="

    # CPU负载
    echo "CPU负载:"
    if command -v uptime &> /dev/null; then
        uptime
    fi

    # 内存使用
    echo "内存使用:"
    if command -v free &> /dev/null; then
        free -h
    fi

    # 磁盘I/O
    echo "磁盘I/O:"
    if command -v iostat &> /dev/null; then
        iostat -x 1 1 | tail -3
    else
        echo "  iostat不可用，跳过磁盘I/O检查"
    fi

    echo ""
}

# 检查安全设置
check_security() {
    log_info "检查安全设置..."

    echo "=== 安全设置 ==="

    # 文件权限
    echo "关键文件权限:"
    files_to_check=(
        "$PROJECT_ROOT/project_config.json"
        "$PROJECT_ROOT/rules/"
        "$PROJECT_ROOT/assets/"
    )

    for file in "${files_to_check[@]}"; do
        if [ -e "$file" ]; then
            perms=$(stat -c "%a" "$file" 2>/dev/null || echo "unknown")
            echo "  $file: $perms"
        fi
    done

    # 防火墙状态
    echo "防火墙状态:"
    if command -v ufw &> /dev/null; then
        ufw status | head -3
    elif command -v firewall-cmd &> /dev/null; then
        firewall-cmd --state
    else
        echo "  未检测到防火墙管理工具"
    fi

    echo ""
}

# 生成诊断报告
generate_report() {
    local report_file="$PROJECT_ROOT/logs/system_diagnostic_$(date +%Y%m%d_%H%M%S).txt"

    log_info "生成诊断报告..."

    {
        echo "my_ai_popup_project 系统诊断报告"
        echo "====================================="
        echo "生成时间: $(date)"
        echo "项目路径: $PROJECT_ROOT"
        echo "====================================="
        echo ""
    } > "$report_file"

    # 重新运行所有检查并输出到文件
    {
        collect_system_info
        check_hardware
        check_software
        check_project_environment
        check_network
        check_performance
        check_security
    } >> "$report_file"

    log_success "诊断报告已保存: $report_file"
    echo "报告路径: $report_file"
}

# 主程序
ACTION="full_diagnostic"

while [[ $# -gt 0 ]]; do
    case $1 in
        --full)
            ACTION="full_diagnostic"
            shift
            ;;
        --quick)
            ACTION="quick_diagnostic"
            shift
            ;;
        --hardware)
            ACTION="hardware_only"
            shift
            ;;
        --software)
            ACTION="software_only"
            shift
            ;;
        --network)
            ACTION="network_only"
            shift
            ;;
        --report)
            ACTION="generate_report_only"
            shift
            ;;
        --help|-h)
            echo "使用方法:"
            echo "  $0                    # 完整诊断"
            echo "  $0 --full             # 完整诊断"
            echo "  $0 --quick            # 快速诊断"
            echo "  $0 --hardware         # 仅硬件诊断"
            echo "  $0 --software         # 仅软件诊断"
            echo "  $0 --network          # 仅网络诊断"
            echo "  $0 --report           # 仅生成报告"
            echo ""
            echo "诊断内容:"
            echo "  - 系统信息 (OS, 内核, 架构)"
            echo "  - 硬件资源 (CPU, 内存, 磁盘, GPU)"
            echo "  - 软件环境 (Python, pip, 编译工具)"
            echo "  - 项目环境 (结构, 文件, 虚拟环境)"
            echo "  - 网络连接 (互联网, DNS, 服务)"
            echo "  - 性能指标 (CPU, 内存, I/O)"
            echo "  - 安全设置 (权限, 防火墙)"
            exit 0
            ;;
        *)
            log_error "未知参数: $1"
            exit 1
            ;;
    esac
done

case $ACTION in
    full_diagnostic)
        log_info "开始完整系统诊断..."
        collect_system_info
        check_hardware
        check_software
        check_project_environment
        check_network
        check_performance
        check_security
        generate_report
        log_success "完整诊断完成"
        ;;

    quick_diagnostic)
        log_info "开始快速诊断..."
        collect_system_info
        check_project_environment
        check_network
        generate_report
        log_success "快速诊断完成"
        ;;

    hardware_only)
        check_hardware
        ;;

    software_only)
        check_software
        ;;

    network_only)
        check_network
        ;;

    generate_report_only)
        generate_report
        ;;
esac

echo ""
echo -e "${GREEN}=========================================="
echo "系统诊断执行完成"
echo -e "==========================================${NC}"
